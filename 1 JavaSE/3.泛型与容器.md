[TOC]



## ä¸€ã€æ³›å‹

#### æ³›å‹æ¦‚è¿°

- ä½¿ç”¨æ³›å‹å¯ä»¥è®©ç¼–è¯‘å™¨å¯¹ç±»å‹è¿›è¡Œæ£€æŸ¥ï¼Œé¿å…æ’å…¥é”™è¯¯ç±»å‹çš„å¯¹è±¡ã€‚å®ƒæä¾›äº†ç¼–è¯‘æœŸçš„ç±»å‹å®‰å…¨ï¼Œç¡®ä¿ä½ åªèƒ½æŠŠæ­£ç¡®ç±»å‹çš„å¯¹è±¡æ”¾å…¥é›†åˆä¸­ï¼Œé¿å…äº†åœ¨è¿è¡Œæ—¶å‡ºç°ClassCastExceptionã€‚

- æ³›å‹çš„å¥½å¤„ï¼šå®‰å…¨æ€§ã€å¯è¯»æ€§ã€‚å®‰å…¨æ€§æ˜¯æŒ‡ç¼–è¯‘å™¨ä¼šå¸®æ£€æµ‹ç±»å‹é”™è¯¯ï¼Œä½¿ç±»å‹å®‰å…¨ã€‚

  
  
    

#### æ³›å‹ç”¨å¤„åˆ†ç±»

##### æ³›å‹ç±»

- ä¸€ä¸ªæ³›å‹ç±»å°±æ˜¯å…·æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª**ç±»å‹å˜é‡**çš„ç±»ã€‚

```java
// ä¸€ä¸ªç®€å•çš„æ³›å‹ç±»
public class Pair<T> 
{
   private T first;
   private T second;

   public Pair() { first = null; second = null; }
   public Pair(T first, T second) { 
        this.first = first;  this.second = second; 
   }

   public T getFirst() { return first; }
   public T getSecond() { return second; }

   public void setFirst(T newValue) { first = newValue; }
   public void setSecond(T newValue) { second = newValue; }
}

// ä¸¤ä¸ªç±»å‹å˜é‡çš„æ³›å‹ç±»
public class Pair<T, U>{...}
```

ç”¨å…·ä½“çš„ç±»å‹æ›¿æ¢ç±»å‹å˜é‡å°±å¯ä»¥å®ä¾‹åŒ–æ³›å‹ç±»å‹ã€‚

```java
public class PairTest1 {        // æµ‹è¯•ç±»
   public static void main(String[] args)   {
      String[] words = { "Mary", "had", "a", "little", "lamb" };
      Pair<String> mm = ArrayAlg.minmax(words);
      System.out.println("min = " + mm.getFirst());
      System.out.println("max = " + mm.getSecond());
   }
}

class ArrayAlg{
   /**
    * Gets the minimum and maximum of an array of strings.
    * @param a an array of strings
    * @return a pair with the min and max value, or null if a is null or empty
    */
   public static Pair<String> minmax(String[] a) {
      if (a == null || a.length == 0) return null;
      String min = a[0];
      String max = a[0];
      for (int i = 1; i < a.length; i++)      {
         if (min.compareTo(a[i]) > 0) min = a[i];
         if (max.compareTo(a[i]) < 0) max = a[i];
      }
      return new Pair<>(min, max);
   }
}

```

------

##### æ³›å‹æ–¹æ³•

- ä¸€ä¸ªæ–¹æ³•æ˜¯ä¸æ˜¯æ³›å‹çš„ï¼Œä¸å…¶æ‰€åœ¨çš„ç±»æ˜¯ä¸æ˜¯æ³›å‹çš„æ²¡æœ‰å…³ç³»ã€‚

- å¯ä»¥å®šä¹‰å¸¦æœ‰**ç±»å‹å‚æ•°**çš„æ–¹æ³•ã€‚è°ƒç”¨æ³›å‹æ–¹æ³•æ—¶ï¼Œåœ¨**æ–¹æ³•åå‰çš„å°–æ‹¬å·**ä¸­æ”¾äººå…·ä½“çš„ç±»å‹ã€‚
- \<T>æ˜¯ç±»å‹å‚æ•°ï¼ŒT æ˜¯è¿”å›ç±»å‹ï¼Œç±»å‹å‚æ•°æ”¾åœ¨è¿”å›å€¼ä¹‹å‰ã€‚
- ä¸æ³›å‹ç±»ä¸åŒï¼Œè°ƒç”¨æ–¹æ³•æ—¶ä¸€èˆ¬ä¸éœ€è¦ç‰¹æ„æŒ‡å®šç±»å‹å‚æ•°çš„å®é™…ç±»å‹ï¼Œ ä¸€èˆ¬Java ç¼–è¯‘å™¨å¯ä»¥è‡ªåŠ¨æ¨æ–­å‡ºæ¥ã€‚

```java
// ä¸æ˜¯æ³›å‹ç±»
class ArrayAlg{
    // <T>æ˜¯ç±»å‹å‚æ•°ï¼ŒT æ˜¯è¿”å›ç±»å‹ï¼Œå‚æ•°ä¸ºç±»å‹Tçš„ä¸å®šæ•°ç›®å‚æ•°
    public static <T> T getMiddle(T... a){
        return a[a.length / 2];
    }
    
    
   public static <T> int indexOf(T[] arr, T elm) {
       for(int i = 0; i < arr.length; i++) {
           if(arr[i].equals(elm)) {
               return i;
           }
       }
       return -1;
   }
}

// è°ƒç”¨æ³›å‹æ–¹æ³•
String middle = ArrayAlg.<String>getMiddle("]ohnM, "Test", "Public");
String middle = ArrayAlg.getMiddle("]ohnM, "Test", "Public");   // çœç•¥ç±»å‹å‚æ•°
                                   
indexOf(new Integer[]{1, 3, 5, 6, 8}, 10);
```

- æ³›å‹æ–¹æ³•å¯ä»¥å®šä¹‰åœ¨**æ™®é€šç±»**ä¸­ï¼Œä¹Ÿå¯ä»¥å®šä¹‰åœ¨æ³›å‹ç±»ä¸­ã€‚

```java
public class Box<T> {
    // T stands for "Type"
    private T t;
    public void set(T t) { this.t = t; }
    public T get() { return t; }
}
```

##### æ³›å‹æ¥å£

æ¥å£ä¹Ÿå¯ä»¥æ˜¯æ³›å‹çš„ï¼Œå¦‚ä¸‹ã€‚ä½¿ç”¨æ—¶éœ€è¦æŒ‡å®šå…·ä½“çš„ç±»å‹ã€‚

```java
public interface Comparable<T> {
    public int compareTo(T o);
}
```

```java
public class Book implements Comparable<Integer> {
    public int compareTo(Integer bookPage) {
        return compare(this.bookpage, anotherBook.bookPage);
    }
}
```

------

#### ç±»å‹å˜é‡çš„é™å®š

- ç±»å‹æ“¦é™¤çš„è¿‡ç¨‹å³æ“¦é™¤(erased) ç±»å‹å˜é‡, å¹¶æ›¿æ¢ä¸ºç›¸åº”çš„**é™å®šç±»å‹** (æ— é™å®šçš„å˜é‡ç”¨ **Object**)ã€‚ç›¸å½“äºç»™ç±»å‹æ“¦é™¤æŒ‡å®šä¸€ä¸ªè¾¹ç•Œï¼ŒæŒ‡å®šè¾¹ç•Œä¹‹åï¼Œç±»å‹æ“¦é™¤ä¹‹åå°±ä¸ä¼šå˜ä¸º Objectã€‚

- å¯¹ç±»å‹è¿›è¡Œé™å®š

```java
// é™å®šminæ–¹æ³•åªèƒ½è¢«å®ç°äº†Comparab1eæ¥å£çš„ç±»è°ƒç”¨
public static <T extends Comparab1e> T min(T[] a){...}
```

- å¦‚æœæœ‰å¤šä¸ªç±»å‹å˜é‡å’Œå¤šä¸ªé™å®šç±»å‹ï¼Œé™å®šç±»å‹ç”¨&åˆ†éš”ï¼Œç±»å‹å˜é‡ç”¨é€—å·åˆ†éš”ã€‚
- å¦‚æœç”¨ä¸€ä¸ªç±»ä½œä¸ºé™å®šï¼Œå®ƒå¿…é¡»æ˜¯é™å®šåˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªã€‚

```java
// å¤šä¸ªé™å®šç±»å‹ï¼Œä¸”Studentsç±»ä¸ºç¬¬ä¸€ä¸ª
public static <T extends Students & Comparab1e & Serializable> Pair<T> min(T[] a){...}
```

- ä¸Šç•Œå¯ä»¥æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ­¤æ—¶ T å¿…é¡»å®ç°è¿™ä¸ªæ¥å£ã€‚

```java
/**
* æ³›å‹æ–¹æ³• <T extends Comparable> ä¸ºç±»å‹é™å®š  Pair<T> ä¸ºè¿”å›ç±»å‹  T[]ä¸ºå…¥å‚
*/
public static <T extends Comparable> Pair<T> minmax(T[] a) 
   {
      if (a == null || a.length == 0) return null;
      T min = a[0];
      T max = a[0];
      for (int i = 1; i < a.length; i++)
      {
         if (min.compareTo(a[i]) > 0) min = a[i];
         if (max.compareTo(a[i]) < 0) max = a[i];
      }
      return new Pair<>(min, max);
   }
```

------

#### ç±»å‹æ“¦é™¤

è™šæ‹Ÿæœº**æ²¡æœ‰**æ³›å‹ç±»å‹å¯¹è±¡ï¼Œè™šæ‹Ÿæœºä¸çŸ¥é“æ³›å‹ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½å±äºæ™®é€šç±»ã€‚æ— è®ºä½•æ—¶å®šä¹‰ä¸€ä¸ªæ³›å‹ç±»å‹ï¼Œéƒ½è‡ªåŠ¨æä¾›äº†ä¸€ä¸ªç›¸åº”çš„**åŸå§‹ç±»å‹**(raw type)ã€‚

Java æ³›å‹æ˜¯é€šè¿‡**ç±»å‹æ“¦é™¤**å®ç°çš„ã€‚

åŸå§‹ç±»å‹çš„åå­—å°±æ˜¯åˆ å»ç±»å‹å‚æ•°åçš„æ³›å‹ç±»å‹åã€‚æ“¦é™¤(erased) ç±»å‹å˜é‡, å¹¶æ›¿æ¢ä¸º**é™å®šç±»å‹** (æ— é™å®šçš„å˜é‡ç”¨ **Object**)ã€‚å¦‚ä¸‹æ³›å‹æ–¹æ³•

```java
public Pair(T first, T second) { 
    this.first = first;  this.second = second; 
}
```

ç±»å‹æ“¦é™¤ååŸå§‹ç±»å‹å˜ä¸º

```java
public Pair(Object first, Object second) { 
    this.first = first;  this.second = second; 
}
```

ç”±äºæ²¡æœ‰é™å®šç±»å‹ï¼Œæ‰€ä»¥ T æ¢ä¸º **Object**ã€‚å¦ä¸€ä¸ªç±»å¦‚ä¸‹

```java
public class Test <T extends Comparable & Serializable> implements Serializable{
    private T lower;
    private T upper;
    public Test (T first, T second){
        if (first.compareTo(second) <= 0) { lower = first; upper = second; }
        else { lower = second; upper = first; }
    }
}
```

ç”±äºå…¶æœ‰é™å®šç±»å‹ Comparableï¼Œæ‰€ä»¥å…¶åŸå§‹ç±»å‹ä¸­ T å˜ä¸º Comparable å¾—åˆ°å¦‚ä¸‹ç±»ã€‚ç±»å‹æ“¦é™¤ä¹Ÿä¼šå‡ºç°åœ¨æ³›å‹æ–¹æ³•ä¸­ã€‚

```java
// æ“¦é™¤åå˜æˆé™å®šç±»å‹
public class Test implements Serializable {
    private Comparable lower;
    private Coiparable upper;
    public Test (Coiparable first, Coiparable second) { . . . }
}
```

Java æ³›å‹è½¬æ¢çš„äº‹å®ï¼š

- è™šæ‹Ÿæœºä¸­æ²¡æœ‰æ³›å‹ï¼Œåªæœ‰æ™®é€šçš„ç±»å’Œæ–¹æ³•ã€‚
- æ‰€æœ‰çš„ç±»å‹å‚æ•°éƒ½ç”¨å®ƒä»¬çš„**é™å®šç±»å‹æ›¿æ¢**ã€‚
- **æ¡¥æ–¹æ³•è¢«åˆæˆæ¥ä¿æŒå¤šæ€**ã€‚
- ä¸ºä¿æŒç±»å‹å®‰å…¨æ€§ï¼Œå¿…è¦æ—¶æ’å…¥å¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚

------

#### é€šé…ç¬¦

**ä¸ºä»€ä¹ˆè¦ç”¨é€šé…ç¬¦ï¼Ÿ**

åœ¨javaä¸­ï¼Œæ•°ç»„æ˜¯å¯ä»¥åå˜çš„ï¼Œæ¯”å¦‚dog extends Animalï¼Œé‚£ä¹ˆAnimal[] ä¸dog[]æ˜¯å…¼å®¹çš„ã€‚è€Œé›†åˆæ˜¯ä¸èƒ½åå˜çš„ï¼Œä¹Ÿå°±æ˜¯è¯´List\<Animal>ä¸æ˜¯List\<dog>çš„çˆ¶ç±»ï¼Œè¿™æ—¶å€™å°±å¯ä»¥ç”¨åˆ°é€šé…ç¬¦äº†ã€‚

**ä¸€ã€åŸºæœ¬æ¦‚å¿µï¼š**

åœ¨å­¦ä¹ Javaæ³›å‹çš„è¿‡ç¨‹ä¸­, é€šé…ç¬¦æ˜¯è¾ƒéš¾ç†è§£çš„ä¸€éƒ¨åˆ†. ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç±»:

- æ— è¾¹ç•Œçš„é€šé…ç¬¦(Unbounded Wildcards), å°±æ˜¯ \<?>, æ¯”å¦‚List<?>.
    ã€€ã€€æ— è¾¹ç•Œçš„é€šé…ç¬¦çš„ä¸»è¦ä½œç”¨å°±æ˜¯è®©**æ³›å‹èƒ½å¤Ÿæ¥å—æœªçŸ¥ç±»å‹**çš„æ•°æ®. 
- å›ºå®šä¸Šè¾¹ç•Œçš„é€šé…ç¬¦(Upper Bounded Wildcards):
    ã€€ã€€ä½¿ç”¨**å›ºå®šä¸Šè¾¹ç•Œ**çš„é€šé…ç¬¦çš„æ³›å‹, å°±èƒ½å¤Ÿæ¥å—**æŒ‡å®šç±»åŠå…¶å­ç±»**ç±»å‹çš„æ•°æ®. è¦å£°æ˜ä½¿ç”¨è¯¥ç±»é€šé…ç¬¦, é‡‡ç”¨   **<? extends E> ** çš„å½¢å¼, è¿™é‡Œçš„ **E** å°±æ˜¯è¯¥æ³›å‹çš„**ä¸Šè¾¹ç•Œ**. æ³¨æ„: è¿™é‡Œè™½ç„¶ç”¨çš„æ˜¯ extends å…³é”®å­—, å´ä¸ä»…é™äºç»§æ‰¿äº†çˆ¶ç±» E çš„å­ç±», ä¹Ÿå¯ä»¥ä»£æŒ‡æ˜¾ç°äº†**æ¥å£** E çš„ç±». 
- å›ºå®šä¸‹è¾¹ç•Œçš„é€šé…ç¬¦(Lower Bounded Wildcards):
    ã€€ã€€ä½¿ç”¨å›ºå®š**ä¸‹è¾¹ç•Œ**çš„é€šé…ç¬¦çš„æ³›å‹, å°±èƒ½å¤Ÿæ¥å—æŒ‡å®š**ç±»åŠå…¶çˆ¶ç±»ç±»å‹**çš„æ•°æ®. è¦å£°æ˜ä½¿ç”¨è¯¥ç±»é€šé…ç¬¦, é‡‡ç”¨   **<? super E>** çš„å½¢å¼, è¿™é‡Œçš„ **E** å°±æ˜¯è¯¥æ³›å‹çš„**ä¸‹è¾¹ç•Œ**ã€‚æ³¨æ„: ä½ å¯ä»¥ä¸ºä¸€ä¸ªæ³›å‹æŒ‡å®šä¸Šè¾¹ç•Œæˆ–ä¸‹è¾¹ç•Œ, ä½†æ˜¯ä¸èƒ½åŒæ—¶æŒ‡å®šä¸Šä¸‹è¾¹ç•Œ.

**äºŒã€åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼š**

**1. æ— è¾¹ç•Œçš„é€šé…ç¬¦çš„ä½¿ç”¨, æˆ‘ä»¬ä»¥åœ¨é›†åˆListä¸­ä½¿ç”¨<?>ä¸ºä¾‹.** 

```java
public static void printList(List<?> list) {
    for (Object o : list) {
        System.out.println(o);
    }
}

public static void main(String[] args) {
    List<String> l1 = new ArrayList<>();
    l1.add("aa");
    l1.add("bb");
    l1.add("cc");
    printList(l1);
    List<Integer> l2 = new ArrayList<>();
    l2.add(11);
    l2.add(22);
    l2.add(33);
    printList(l2);
    
}
```

è¿™ç§ä½¿ç”¨ List<?> çš„æ–¹å¼å°±æ˜¯çˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»å¯¹è±¡. æ³¨æ„, è¿™é‡Œçš„ printList æ–¹æ³•ä¸èƒ½å†™æˆ public static void printList(List\<Object> list)çš„å½¢å¼, åŸå› æˆ‘åœ¨ä¸Šä¸€ç¯‡åšæ–‡ä¸­å·²ç»è®²è¿‡, è™½ç„¶ Object ç±»æ˜¯æ‰€æœ‰ç±»çš„çˆ¶ç±», ä½†æ˜¯List\<Object> è·Ÿå…¶ä»–æ³›å‹çš„ List å¦‚ List\<String> ,  List\<Integer> ä¸å­˜åœ¨ç»§æ‰¿å…³ç³», å› æ­¤ä¼šæŠ¥é”™.

æœ‰ä¸€ç‚¹æˆ‘ä»¬å¿…é¡»æ˜ç¡®, **æˆ‘ä»¬ä¸èƒ½å¯¹ List<?> ä½¿ç”¨addæ–¹æ³•, ä»…æœ‰ä¸€ä¸ªä¾‹å¤–, å°±æ˜¯add(null)**. ä¸ºä»€ä¹ˆå‘¢? å› ä¸ºæˆ‘ä»¬**ä¸ç¡®å®š**è¯¥ List çš„ç±»å‹, ä¸çŸ¥é“ add ä»€ä¹ˆç±»å‹çš„æ•°æ®æ‰å¯¹, åªæœ‰ null æ˜¯æ‰€æœ‰å¼•ç”¨æ•°æ®ç±»å‹éƒ½å…·æœ‰çš„å…ƒç´ ã€‚å³åªèƒ½è¯»ä¸èƒ½å†™ï¼Œé—®å·  ï¼Ÿ å°±æ˜¯è¡¨ç¤ºç±»å‹å®‰å…¨æ— çŸ¥ã€‚è¯·çœ‹ä¸‹é¢ä»£ç :

```java
public static void addTest(List<?> list) {
    Object o = new Object();
    // list.add(o); // ç¼–è¯‘æŠ¥é”™
    // list.add(1); // ç¼–è¯‘æŠ¥é”™
    // list.add("ABC"); // ç¼–è¯‘æŠ¥é”™
    list.add(null);
}
```

ç”±äºæˆ‘ä»¬æ ¹æœ¬ä¸çŸ¥é“ list ä¼šæ¥å—åˆ°å…·æœ‰ä»€ä¹ˆæ ·çš„æ³›å‹ List, æ‰€ä»¥é™¤äº† null ä¹‹å¤–ä»€ä¹ˆä¹Ÿä¸èƒ½ addã€‚
è¿˜æœ‰, **List<?> ä¹Ÿä¸èƒ½ä½¿ç”¨ get æ–¹æ³•, åªæœ‰ Object ç±»å‹æ˜¯ä¸ªä¾‹å¤–**. åŸå› ä¹Ÿå¾ˆç®€å•, å› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“ä¼ å…¥çš„ List æ˜¯ä»€ä¹ˆæ³›å‹çš„, æ‰€ä»¥æ— æ³•æ¥å—å¾—åˆ°çš„ get, ä½†æ˜¯ Object æ˜¯æ‰€æœ‰æ•°æ®ç±»å‹çš„çˆ¶ç±», æ‰€ä»¥åªæœ‰æ¥å—ä»–å¯ä»¥, è¯·çœ‹ä¸‹é¢ä»£ç :

```java
public static void getTest(List<?> list) {
    // String s = list.get(0);  // ç¼–è¯‘æŠ¥é”™
    // Integer i = list.get(1); // ç¼–è¯‘æŠ¥é”™
    Object o = list.get(2);
}
```

ä¸æ˜¯æœ‰å¼ºåˆ¶ç±»å‹è½¬æ¢ä¹ˆ? æ˜¯æœ‰, ä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“ä¼šä¼ å…¥ä»€ä¹ˆç±»å‹, æ¯”å¦‚æˆ‘ä»¬å°†å…¶å¼ºè½¬ä¸º String, ç¼–è¯‘æ˜¯é€šè¿‡äº†, ä½†æ˜¯å¦‚æœä¼ å…¥ä¸ª Integer æ³›å‹çš„ List, ä¸€è¿è¡Œè¿˜ä¼šå‡ºé”™ã€‚é‚£ä¹ˆä¿è¯ä¼ å…¥çš„Stringç±»å‹çš„æ•°æ®ä¸å°±å¥½äº†ä¹ˆ? é‚£æ ·æ˜¯æ²¡é—®é¢˜äº†, ä½†æ˜¯é‚£è¿˜ç”¨ <?> å¹²å˜›å‘€? ç›´æ¥ List\<String> ä¸å°±è¡Œäº†ã€‚

**2. å›ºå®šä¸Šè¾¹ç•Œçš„é€šé…ç¬¦çš„ä½¿ç”¨**

 ä»æ—§ä»¥Listä¸ºä¾‹æ¥è¯´æ˜ã€‚

```java
public static double sumOfList(List<? extends Number> list) {
    double s = 0.0;
    for (Number n : list) {
        // æ³¨æ„è¿™é‡Œå¾—åˆ°çš„næ˜¯å…¶ä¸Šè¾¹ç•Œç±»å‹çš„, ä¹Ÿå°±æ˜¯Number, éœ€è¦å°†å…¶è½¬æ¢ä¸ºdouble.
        s += n.doubleValue();
    }
    return s;
}

public static void main(String[] args) {
    List<Integer> list1 = Arrays.asList(1, 2, 3, 4);
    System.out.println(sumOfList(list1));
    List<Double> list2 = Arrays.asList(1.1, 2.2, 3.3, 4.4);
    System.out.println(sumOfList(list2));
}
```

æœ‰ä¸€ç‚¹æˆ‘ä»¬éœ€è¦è®°ä½çš„æ˜¯, **List<? extends E> ä¸èƒ½ä½¿ç”¨ add æ–¹æ³•**, è¯·çœ‹å¦‚ä¸‹ä»£ç :

```java
public static void addTest2(List<? extends Number> l) {
    // l.add(1);   // ç¼–è¯‘æŠ¥é”™
    // l.add(1.1); //ç¼–è¯‘æŠ¥é”™
    l.add(null);
}
```

åŸå› å¾ˆç®€å•, æ³›å‹ <? extends E> æŒ‡çš„æ˜¯ E åŠå…¶å­ç±», è¿™é‡Œä¼ å…¥çš„å¯èƒ½æ˜¯ Integer, ä¹Ÿå¯èƒ½æ˜¯ Double, æˆ‘ä»¬åœ¨å†™è¿™ä¸ªæ–¹æ³•æ—¶ä¸èƒ½ç¡®å®šä¼ å…¥çš„ä»€ä¹ˆç±»å‹çš„æ•°æ®, å¦‚æœæˆ‘ä»¬è°ƒç”¨:

```java
List<Integer> list = new ArrayList<>();
addTest(list);
```

é‚£ä¹ˆæˆ‘ä»¬ä¹‹å‰å†™çš„ add(1.1) å°±ä¼šå‡ºé”™, åä¹‹äº¦ç„¶, æ‰€ä»¥é™¤äº† null ä¹‹å¤–ä»€ä¹ˆä¹Ÿä¸èƒ½ add. ä½†æ˜¯ get çš„æ—¶å€™æ˜¯å¯ä»¥å¾—åˆ°ä¸€ä¸ª Number, ä¹Ÿå°±æ˜¯**ä¸Šè¾¹ç•Œç±»å‹**çš„æ•°æ®çš„, å› ä¸ºä¸ç®¡å­˜å…¥ä»€ä¹ˆæ•°æ®ç±»å‹éƒ½æ˜¯ Number çš„å­ç±»å‹, å¾—åˆ°è¿™äº›å°±æ˜¯ä¸€ä¸ª**çˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»**å¯¹è±¡. 

**3. å›ºå®šä¸‹è¾¹ç•Œé€šé…ç¬¦çš„ä½¿ç”¨**

è¿™ä¸ªè¾ƒå‰é¢çš„ä¸¤ä¸ªæœ‰ç‚¹éš¾ç†è§£, é¦–å…ˆä»ä»¥Listä¸ºä¾‹.

```java
public static void addNumbers(List<? super Integer> list) {
    for (int i = 1; i <= 10; i++) {
        list.add(i);
    }
}

public static void main(String[] args) {
    List<Object> list1 = new ArrayList<>();
    addNumbers(list1);
    System.out.println(list1);
    List<Number> list2 = new ArrayList<>();
    addNumbers(list2);
    System.out.println(list2);
    List<Double> list3 = new ArrayList<>();
    // addNumbers(list3); // ç¼–è¯‘æŠ¥é”™
}
```

æˆ‘ä»¬çœ‹åˆ°, List<? super E> æ˜¯èƒ½å¤Ÿè°ƒç”¨ add æ–¹æ³•çš„, å› ä¸ºæˆ‘ä»¬åœ¨ addNumbers æ‰€ add çš„å…ƒç´ å°±æ˜¯ Integer ç±»å‹çš„, è€Œä¼ å…¥çš„ list ä¸ç®¡æ˜¯ä»€ä¹ˆ, éƒ½ä¸€å®šæ˜¯ Integer æˆ–å…¶çˆ¶ç±»æ³›å‹çš„ List, è¿™æ—¶ add ä¸€ä¸ª Integer å…ƒç´ æ˜¯æ²¡æœ‰ä»»ä½•ç–‘é—®çš„. ä½†æ˜¯, **æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨getæ–¹æ³•**, é™¤éä½¿ç”¨ Object ç±»å‹æ¥æ¥æ”¶ï¼Œè¯·çœ‹å¦‚ä¸‹ä»£ç :

```java
public static void getTest2(List<? super Integer> list) {
    // Integer i = list.get(0); // ç¼–è¯‘æŠ¥é”™
    Object o = list.get(1);
}
```

è¿™ä¸ªåŸå› ä¹Ÿæ˜¯å¾ˆç®€å•çš„, å› ä¸ºæˆ‘ä»¬æ‰€ä¼ å…¥çš„ç±»éƒ½æ˜¯ Integer çš„ç±»æˆ–å…¶çˆ¶ç±», æ‰€ä¼ å…¥çš„æ•°æ®ç±»å‹å¯èƒ½æ˜¯ Integer åˆ°Object ä¹‹é—´çš„ä»»ä½•ç±»å‹, è¿™æ˜¯**æ— æ³•é¢„æ–™**çš„, ä¹Ÿå°±æ— æ³•æ¥æ”¶. å”¯ä¸€èƒ½ç¡®å®šçš„å°±æ˜¯ Object, å› ä¸ºæ‰€æœ‰ç±»å‹éƒ½æ˜¯å…¶**å­ç±»å‹**.
ä½¿ç”¨ <? super E> è¿˜æœ‰ä¸ªå¸¸è§çš„åœºæ™¯å°±æ˜¯ **Comparator**. 

**é€šé…ç¬¦æ€»ç»“**

ä¸Šè¿°å‡ ç§é€šé…ç¬¦çš„ä½¿ç”¨åŸåˆ™ï¼Œæœ‰äººå°†å…¶ç§°ä¸º PECS (å³"Producer Extends, Consumer Super", ç½‘ä¸Šç¿»è¯‘ä¸º"**ç”Ÿäº§è€…ä½¿ç”¨ extends, æ¶ˆè´¹è€…ä½¿ç”¨ super**"ã€‚

- <?> <? extends E> ç”¨äº**çµæ´»è¯»å–**ï¼Œä½¿ç”¨æ–¹æ³•å¯ä»¥è¯»å– E æˆ–è€… E çš„ä»»æ„å­ç±»å‹çš„å®¹å™¨å¯¹è±¡ã€‚å¯å°†è¯¥å¯¹è±¡å½“æˆåªè¯»å¯¹è±¡ï¼Œç±»ä¼¼ç”Ÿäº§è€…ã€‚
- <? super E> ç”¨äº**çµæ´»å†™å…¥ä¸æ¯”è¾ƒ**ï¼Œä½¿å¾—å¯¹è±¡å¯ä»¥å†™å…¥çˆ¶ç±»å‹çš„å®¹å™¨ï¼Œä½¿å¾—çˆ¶ç±»å‹çš„æ¯”è¾ƒæ–¹æ³•å¯ä»¥åº”ç”¨äºå­ç±»å¯¹è±¡ã€‚å¯å°†è¯¥å¯¹è±¡å½“æˆåªèƒ½å†™å¯¹è±¡ï¼Œç±»ä¼¼æ¶ˆè´¹è€…ã€‚

---

#### æ³›å‹çš„çº¦æŸä¸å±€é™æ€§

å±€é™æ€§å¤šåŠæ˜¯ç”±ç±»å‹æ“¦é™¤å¼•èµ·ã€‚

**1. ä¸èƒ½ç”¨åŸºæœ¬ç±»å‹å®ä¾‹åŒ–ç±»å‹å‚æ•°**

ä¸èƒ½ç”¨ç±»å‹å‚æ•°ä»£æ›¿åŸºæœ¬ç±»å‹ã€‚å› æ­¤æ²¡æœ‰ Pair\<double>, åªæœ‰ **Pair\<Double>**ã€‚å…¶åŸå› æ˜¯ç±»å‹æ“¦é™¤ã€‚æ“¦é™¤ä¹‹åï¼ŒPairç±»å«æœ‰ **Object** ç±»å‹çš„åŸŸï¼Œè€Œ Object ä¸èƒ½å­˜å‚¨ double å€¼ã€‚

**2. è¿è¡Œæ—¶ç±»å‹æŸ¥è¯¢åªé€‚ç”¨äºåŸå§‹ç±»å‹**

è™šæ‹Ÿæœºä¸­çš„å¯¹è±¡æ€»æœ‰ä¸€ä¸ªç‰¹å®šçš„éæ³›å‹ç±»å‹ã€‚å› æ­¤æ‰€æœ‰çš„ç±»å‹æŸ¥è¯¢åªäº§ç”ŸåŸå§‹ç±»å‹ã€‚
**getClass** æ–¹æ³•æ€»æ˜¯è¿”å›**åŸå§‹ç±»å‹**ã€‚ä¾‹å¦‚ï¼š

```java
Pair<String> stringPair = . .
Pair<Employee> employeePair = . .
if (stringPair.getClass() == employeePair.getClass()) // they are equal
```

å…¶æ¯”è¾ƒçš„ç»“æœæ˜¯ true, è¿™æ˜¯å› ä¸ºä¸¤æ¬¡è°ƒç”¨ getClass éƒ½å°†è¿”å› Pair.classã€‚

**3. ä¸èƒ½åˆ›å»ºå‚æ•°åŒ–ç±»å‹çš„æ•°ç»„**

ä¸èƒ½å®ä¾‹åŒ–å‚æ•°åŒ–ç±»å‹çš„æ•°ç»„ï¼Œ ä¾‹å¦‚ï¼š

```java
Pair<String>[] table = new Pair<String>[10]; // é”™è¯¯ ä¼ å…¥Stringå·²ç»æ˜¯å‚æ•°åŒ–äº†
```

æ“¦é™¤ä¹‹åï¼Œtableçš„ç±»å‹æ˜¯ Pair[]ã€‚ å¯ä»¥æŠŠå®ƒè½¬æ¢ä¸º Object[]:

```java
Object[] objarray = table;
```

æ•°ç»„ä¼š**è®°ä½**å®ƒçš„å…ƒç´ ç±»å‹ï¼Œ å¦‚æœè¯•å›¾å­˜å‚¨å…¶ä»–ç±»å‹çš„å…ƒç´ ï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ª ArrayStoreException å¼‚å¸¸ã€‚

**ä½†æ˜¯**å¯ä»¥å‘å‚æ•°ä¸ªæ•°å¯å˜çš„æ–¹æ³•ä¼ é€’ä¸€ä¸ªæ³›å‹ç±»å‹çš„å®ä¾‹ã€‚å¦‚ä¸‹é¢çš„å‚æ•°å¯å˜çš„æ–¹æ³•:

```java
public static <T> void addAll(Collections coll, T... ts){
    for (t : ts) coll.add(t);
}
```

ä¸ºäº†è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼ŒJava è™šæ‹Ÿæœºå¿…é¡»å»ºç«‹ä¸€ä¸ª Pair\<String> æ•°ç»„ï¼Œè¿™å°±è¿åäº†å‰é¢çš„è§„åˆ™ã€‚ä¸è¿‡ï¼Œè¿™ç§æƒ…å†µåªä¼šå¾—åˆ°ä¸€ä¸ª**è­¦å‘Š**ï¼Œè€Œä¸æ˜¯é”™è¯¯ã€‚
å¯ä»¥åœ¨addAllæ–¹æ³•ä¸Šæ ‡æ³¨è§£@SafeVarargsæˆ–æ³¨è§£@SuppressWanings("unchecked")æ¥æŠ‘åˆ¶æ­¤è­¦å‘Šã€‚å¯ä»¥ä½¿ç”¨ @SafeVarargsæ ‡æ³¨æ¥æ¶ˆé™¤åˆ›å»ºæ³›å‹æ•°ç»„çš„æœ‰å…³é™åˆ¶ï¼Œä½†æ˜¯æœ‰äº›å±é™©ã€‚

**4. ä¸èƒ½é€šè¿‡ç±»å‹å‚æ•°åˆ›å»ºå¯¹è±¡**

ä¸èƒ½ä½¿ç”¨åƒ new T(...)  new T[...]  æˆ–  T.class  è¿™æ ·çš„è¡¨è¾¾å¼ä¸­çš„ç±»å‹å˜é‡ã€‚æœ€å¥½çš„æ˜¯è®©è°ƒç”¨è€…æä¾›ä¸€ä¸ª**æ„é€ å™¨**è¡¨è¾¾å¼ã€‚

```java
public Pair() { 
    first = new T(); 
    second = new T(); 
} // éæ³•

Pair<String> p = Pair.makePair(String::new);    // æä¾›æ„é€ è¡¨è¾¾å¼ åˆæ³•
```

å¦‚æœéœ€è¦æ ¹æ®ç±»å‹åˆ›å»ºå¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡åå°„çš„æ–¹å¼å®ç°ã€‚

```java
first = T.class.newInstance(); // éæ³• T.classéæ³•ï¼Œä¼šè½¬ä¸ºObject.class
// å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„APIå¾—åˆ°classå¯¹è±¡
public static <T> Pair<T> makePair(Class<T> cl){
    try { 
        return new Pair<>(cl.newInstance(), cl.newInstance()); }
    catch (Exception ex) { 
        return null; 
    }
}
// ä½¿ç”¨å¦‚ä¸‹æ–¹å¼è°ƒç”¨
Pair<String> p = Pair.makePair(String.class);
```

**5. ä¸èƒ½åˆ›å»ºæ³›å‹æ•°ç»„**

æ•°ç»„æœ¬èº«ä¹Ÿæœ‰ç±»å‹ï¼Œç”¨æ¥ç›‘æ§å­˜å‚¨åœ¨è™šæ‹Ÿæœºä¸­çš„æ•°ç»„ã€‚è¿™ä¸ªç±»å‹ä¼šè¢«**æ“¦é™¤**ã€‚

```java
public static <T extends Comparable>T[] minmax(T[] a) { T[] mm = new T[2]; ...} // éæ³•
```

ç±»å‹æ“¦é™¤ä¼šè®©è¿™ä¸ªæ–¹æ³•**æ°¸è¿œæ„é€  Comparable[2] æ•°ç»„**ã€‚å¦‚æœç°å®éœ€è¦èƒ½å¤Ÿå­˜æ”¾æ³›å‹å¯¹è±¡çš„å®¹å™¨ï¼Œå¯ä»¥ä½¿ç”¨**åŸå§‹ç±»å‹**çš„æ•°ç»„ã€‚å¦‚ã€‚

```java
Pair[] options = new Pair {
    new Pair<String, Integer>("1", 2),
    new Pair<String, Integer>("2", 2)
};
```

æ³›å‹å®¹å™¨å†…éƒ¨ä½¿ç”¨ Object æ•°ç»„ï¼Œå¦‚æœè¦è½¬æ¢æ³›å‹å®¹å™¨ä¸ºå¯¹åº”ç±»å‹çš„æ•°ç»„ï¼Œéœ€è¦ä½¿ç”¨åå°„ã€‚

 æœ€å¥½è®©ç”¨æˆ·æä¾›ä¸€ä¸ª**æ•°ç»„æ„é€ å™¨è¡¨è¾¾å¼**ï¼š

```java
String[] ss = ArrayAlg.minmax(String[]::new, "Tom", "Dick", "Harry");
```

----

#### æ³›å‹é¢è¯•é¢˜

**Javaçš„æ³›å‹æ˜¯å¦‚ä½•å·¥ä½œçš„ ? ä»€ä¹ˆæ˜¯ç±»å‹æ“¦é™¤ ?**

æ³›å‹æ˜¯é€šè¿‡**ç±»å‹æ“¦é™¤**æ¥å®ç°çš„ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶æ“¦é™¤äº†æ‰€æœ‰ç±»å‹ç›¸å…³çš„ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨è¿è¡Œæ—¶ä¸å­˜åœ¨ä»»ä½•ç±»å‹ç›¸å…³çš„ä¿¡æ¯ã€‚ä¾‹å¦‚List\<String>åœ¨è¿è¡Œæ—¶ä»…ç”¨ä¸€ä¸ªListæ¥è¡¨ç¤ºã€‚è¿™æ ·åšçš„ç›®çš„ï¼Œæ˜¯ç¡®ä¿èƒ½å’ŒJava 5ä¹‹å‰çš„ç‰ˆæœ¬å¼€å‘äºŒè¿›åˆ¶ç±»åº“è¿›è¡Œ**å…¼å®¹**ã€‚ä½ æ— æ³•åœ¨è¿è¡Œæ—¶è®¿é—®åˆ°ç±»å‹å‚æ•°ï¼Œå› ä¸ºç¼–è¯‘å™¨å·²ç»æŠŠæ³›å‹ç±»å‹è½¬æ¢æˆäº†**åŸå§‹ç±»å‹**ã€‚æ ¹æ®ä½ å¯¹è¿™ä¸ªæ³›å‹é—®é¢˜çš„å›ç­”æƒ…å†µï¼Œä½ ä¼šå¾—åˆ°ä¸€äº›åç»­æé—®ï¼Œæ¯”å¦‚ä¸ºä»€ä¹ˆæ³›å‹æ˜¯ç”±ç±»å‹æ“¦é™¤æ¥å®ç°çš„æˆ–è€…ç»™ä½ å±•ç¤ºä¸€äº›ä¼šå¯¼è‡´ç¼–è¯‘å™¨å‡ºé”™çš„é”™è¯¯æ³›å‹ä»£ç ã€‚

**ä»€ä¹ˆæ˜¯æ³›å‹ä¸­çš„é™å®šé€šé…ç¬¦å’Œéé™å®šé€šé…ç¬¦ ?**

è¿™æ˜¯å¦ä¸€ä¸ªéå¸¸æµè¡Œçš„Javaæ³›å‹é¢è¯•é¢˜ã€‚é™å®šé€šé…ç¬¦å¯¹ç±»å‹è¿›è¡Œäº†é™åˆ¶ã€‚æœ‰ä¸¤ç§é™å®šé€šé…ç¬¦ï¼Œä¸€ç§æ˜¯ \<? extends T> å®ƒé€šè¿‡ç¡®ä¿ç±»å‹å¿…é¡»æ˜¯Tçš„å­ç±»æ¥è®¾å®šç±»å‹çš„ä¸Šç•Œï¼Œå¦ä¸€ç§æ˜¯ \<? super T> å®ƒé€šè¿‡ç¡®ä¿ç±»å‹å¿…é¡»æ˜¯Tçš„çˆ¶ç±»æ¥è®¾å®šç±»å‹çš„ä¸‹ç•Œã€‚æ³›å‹ç±»å‹å¿…é¡»ç”¨é™å®šå†…çš„ç±»å‹æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚å¦ä¸€æ–¹é¢ \<?> è¡¨ç¤ºäº†éé™å®šé€šé…ç¬¦ï¼Œå› ä¸º <?> å¯ä»¥ç”¨**ä»»æ„ç±»å‹**æ¥æ›¿ä»£ã€‚

 **List<? extends T>å’ŒList <? super T>ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ« ?**

è¿™å’Œä¸Šä¸€ä¸ªé¢è¯•é¢˜æœ‰è”ç³»ï¼Œæœ‰æ—¶é¢è¯•å®˜ä¼šç”¨è¿™ä¸ªé—®é¢˜æ¥è¯„ä¼°ä½ å¯¹æ³›å‹çš„ç†è§£ï¼Œè€Œä¸æ˜¯ç›´æ¥é—®ä½ ä»€ä¹ˆæ˜¯é™å®šé€šé…ç¬¦å’Œéé™å®šé€šé…ç¬¦ã€‚è¿™ä¸¤ä¸ªListçš„å£°æ˜éƒ½æ˜¯é™å®šé€šé…ç¬¦çš„ä¾‹å­ï¼ŒList<? extends T>å¯ä»¥æ¥å—ä»»ä½•ç»§æ‰¿è‡ªTçš„ç±»å‹çš„Listï¼Œè€ŒList<? super T>å¯ä»¥æ¥å—ä»»ä½•Tçš„çˆ¶ç±»æ„æˆçš„Listã€‚ä¾‹å¦‚List<? extends Number>å¯ä»¥æ¥å—List\<Integer>æˆ–List\<Float>ã€‚

**ç¼–å†™ä¸€æ®µæ³›å‹ç¨‹åºæ¥å®ç°LRUç¼“å­˜?**

å¯¹äºå–œæ¬¢Javaç¼–ç¨‹çš„äººæ¥è¯´è¿™ç›¸å½“äºæ˜¯ä¸€æ¬¡ç»ƒä¹ ã€‚ç»™ä¸ªæç¤ºï¼ŒLinkedHashMap å¯ä»¥ç”¨æ¥å®ç°å›ºå®šå¤§å°çš„LRUç¼“å­˜ï¼Œå½“LRUç¼“å­˜å·²ç»æ»¡äº†çš„æ—¶å€™ï¼Œå®ƒä¼šæŠŠæœ€è€çš„é”®å€¼å¯¹ç§»å‡ºç¼“å­˜ã€‚LinkedHashMap æä¾›äº†ä¸€ä¸ªç§°ä¸ºremoveEldestEntry() çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¢« put() å’Œ putAll() è°ƒç”¨æ¥åˆ é™¤æœ€è€çš„é”®å€¼å¯¹ã€‚å½“ç„¶ï¼Œå¦‚æœä½ å·²ç»ç¼–å†™äº†ä¸€ä¸ªå¯è¿è¡Œçš„JUnitæµ‹è¯•ï¼Œä½ ä¹Ÿå¯ä»¥éšæ„ç¼–å†™ä½ è‡ªå·±çš„å®ç°ä»£ç ã€‚

**ä½ å¯ä»¥æŠŠList\<String>ä¼ é€’ç»™ä¸€ä¸ªæ¥å—List\<Object>å‚æ•°çš„æ–¹æ³•å—ï¼Ÿ**

å¯¹ä»»ä½•ä¸€ä¸ªä¸å¤ªç†Ÿæ‚‰æ³›å‹çš„äººæ¥è¯´ï¼Œè¿™ä¸ªJavaæ³›å‹é¢˜ç›®çœ‹èµ·æ¥ä»¤äººç–‘æƒ‘ï¼Œå› ä¸ºä¹çœ‹èµ·æ¥Stringæ˜¯ä¸€ç§Objectï¼Œæ‰€ä»¥List\<String>åº”å½“å¯ä»¥ç”¨åœ¨éœ€è¦List\<Object>çš„åœ°æ–¹ï¼Œä½†æ˜¯äº‹å®å¹¶éå¦‚æ­¤ã€‚çœŸè¿™æ ·åšçš„è¯ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚å¦‚æœä½ å†æ·±ä¸€æ­¥è€ƒè™‘ï¼Œä½ ä¼šå‘ç°Javaè¿™æ ·åšæ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºList\<Object>å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„å¯¹è±¡åŒ…æ‹¬String, Integerç­‰ç­‰ï¼Œè€ŒList\<String>å´åªèƒ½ç”¨æ¥å­˜å‚¨Stringsã€‚ã€€

```java
List<Object> objectList;
List<String> stringList;
objectList = stringList;  // compilation error incompatible types
```

**Arrayä¸­å¯ä»¥ç”¨æ³›å‹å—?**

è¿™å¯èƒ½æ˜¯Javaæ³›å‹é¢è¯•é¢˜ä¸­æœ€ç®€å•çš„ä¸€ä¸ªäº†ï¼Œå½“ç„¶å‰ææ˜¯ä½ è¦çŸ¥é“ Array äº‹å®ä¸Šå¹¶ä¸æ”¯æŒæ³›å‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Effective Java ä¸€ä¹¦ä¸­å»ºè®®ä½¿ç”¨ List æ¥ä»£æ›¿ Arrayï¼Œå› ä¸º List å¯ä»¥æä¾›ç¼–è¯‘æœŸçš„ç±»å‹å®‰å…¨ä¿è¯ï¼Œè€Œ Array å´ä¸èƒ½ã€‚





## äºŒã€é€šç”¨å®¹å™¨ç±»

### æ¦‚è§ˆ

å®¹å™¨ä¸»è¦åŒ…æ‹¬ Collection å’Œ Map ä¸¤ç§ï¼ŒCollection å­˜å‚¨ç€å¯¹è±¡çš„é›†åˆï¼Œè€Œ Map å­˜å‚¨ç€é”®å€¼å¯¹ï¼ˆä¸¤ä¸ªå¯¹è±¡ï¼‰çš„æ˜ å°„è¡¨ã€‚

åœ¨ IDEA ä¸­ double shift è°ƒå‡º Search EveryWhereï¼ŒæŸ¥æ‰¾æºç æ–‡ä»¶ï¼Œæ‰¾åˆ°ä¹‹åå°±å¯ä»¥é˜…è¯»æºç ã€‚

#### Collection

![1563604728498](assets/1563604728498.png)

##### 1. Set

- TreeSetï¼šåŸºäº**çº¢é»‘æ ‘**å®ç°ï¼Œæ”¯æŒæœ‰åºæ€§æ“ä½œï¼Œä¾‹å¦‚æ ¹æ®ä¸€ä¸ªèŒƒå›´æŸ¥æ‰¾å…ƒç´ çš„æ“ä½œã€‚ä½†æ˜¯æŸ¥æ‰¾æ•ˆç‡ä¸å¦‚ HashSetï¼ŒHashSet æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼ŒTreeSet åˆ™ä¸º O(logN)ã€‚
- HashSetï¼šåŸºäº**å“ˆå¸Œè¡¨**å®ç°ï¼Œæ”¯æŒå¿«é€ŸæŸ¥æ‰¾ï¼Œä½†ä¸æ”¯æŒæœ‰åºæ€§æ“ä½œã€‚å¹¶ä¸”å¤±å»äº†å…ƒç´ çš„æ’å…¥é¡ºåºä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨ Iterator éå† HashSet å¾—åˆ°çš„ç»“æœæ˜¯ä¸ç¡®å®šçš„ã€‚
- LinkedHashSetï¼šå…·æœ‰ HashSet çš„æŸ¥æ‰¾æ•ˆç‡ï¼Œä¸”å†…éƒ¨ä½¿ç”¨åŒå‘é“¾è¡¨ç»´æŠ¤å…ƒç´ çš„æ’å…¥é¡ºåºã€‚

##### 2. List

- ArrayListï¼šåŸºäº**åŠ¨æ€æ•°ç»„**å®ç°ï¼Œæ”¯æŒéšæœºè®¿é—®ã€‚
- Vectorï¼šå’Œ ArrayList ç±»ä¼¼ï¼Œä½†å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
- LinkedListï¼šåŸºäº**åŒå‘é“¾è¡¨**å®ç°ï¼Œåªèƒ½é¡ºåºè®¿é—®ï¼Œä½†æ˜¯å¯ä»¥å¿«é€Ÿåœ°åœ¨é“¾è¡¨ä¸­é—´æ’å…¥å’Œåˆ é™¤å…ƒç´ ã€‚ä¸ä»…å¦‚æ­¤ï¼ŒLinkedList è¿˜å¯ä»¥ç”¨ä½œæ ˆã€é˜Ÿåˆ—å’ŒåŒå‘é˜Ÿåˆ—ã€‚

##### 3. Queue

- LinkedListï¼šå¯ä»¥ç”¨å®ƒæ¥å®ç°åŒå‘é˜Ÿåˆ—ã€‚
- PriorityQueueï¼šåŸºäº**å †ç»“æ„**å®ç°ï¼Œå¯ä»¥ç”¨å®ƒæ¥å®ç°ä¼˜å…ˆé˜Ÿåˆ—ã€‚

------

#### Map

![1563604743962](assets/1563604743962.png)

- TreeMapï¼šåŸºäº**çº¢é»‘æ ‘**å®ç°ã€‚
- HashMapï¼šåŸºäº**å“ˆå¸Œè¡¨**å®ç°ã€‚
- HashTableï¼šå’Œ HashMap ç±»ä¼¼ï¼Œä½†å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™æ„å‘³ç€åŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶å†™å…¥ HashTable å¹¶ä¸”ä¸ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚å®ƒæ˜¯**é—ç•™ç±»**ï¼Œä¸åº”è¯¥å»ä½¿ç”¨å®ƒã€‚ç°åœ¨å¯ä»¥ä½¿ç”¨ **ConcurrentHashMap** æ¥æ”¯æŒçº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸” ConcurrentHashMap çš„æ•ˆç‡ä¼šæ›´é«˜ï¼Œå› ä¸º ConcurrentHashMap å¼•å…¥äº†**åˆ†æ®µé”**ã€‚
- LinkedHashMapï¼šä½¿ç”¨åŒå‘é“¾è¡¨æ¥ç»´æŠ¤å…ƒç´ çš„é¡ºåºï¼Œé¡ºåºä¸ºæ’å…¥é¡ºåºæˆ–è€…æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆ**LRU**ï¼‰é¡ºåºã€‚



### å®¹å™¨ä¸­çš„è®¾è®¡æ¨¡å¼

#### è¿­ä»£å™¨æ¨¡å¼

![1563604760815](assets/1563604760815.png)

Collection ç»§æ‰¿äº† **Iterable** æ¥å£ï¼Œå…¶ä¸­çš„ iterator() æ–¹æ³•èƒ½å¤Ÿäº§ç”Ÿä¸€ä¸ª Iterator å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡å°±å¯ä»¥è¿­ä»£éå† Collection ä¸­çš„å…ƒç´ ã€‚

ä» JDK 1.5 ä¹‹åå¯ä»¥ä½¿ç”¨ foreach æ–¹æ³•æ¥éå†å®ç°äº† Iterable æ¥å£çš„èšåˆå¯¹è±¡ã€‚

```java
List<String> list = new ArrayList<>();
list.add("a");
list.add("b");
for (String item : list) {
    System.out.println(item);
}
```

------

#### é€‚é…å™¨æ¨¡å¼

java.util.Arrays.asList() å¯ä»¥æŠŠ**æ•°ç»„**ç±»å‹è½¬æ¢ä¸º List ç±»å‹ã€‚

```java
@SafeVarargs
public static <T> List<T> asList(T... a)
```

åº”è¯¥æ³¨æ„çš„æ˜¯ asList() çš„å‚æ•°ä¸ºæ³›å‹çš„å˜é•¿å‚æ•°ï¼Œ**ä¸èƒ½ä½¿ç”¨åŸºæœ¬ç±»å‹**æ•°ç»„ä½œä¸ºå‚æ•°ï¼Œåªèƒ½ä½¿ç”¨ç›¸åº”çš„åŒ…è£…ç±»å‹æ•°ç»„ã€‚

```java
Integer[] arr = {1, 2, 3};
List list = Arrays.asList(arr);
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è°ƒç”¨ asList()ï¼š

```java
List list = Arrays.asList(1, 2, 3);
```





## ä¸‰ã€åˆ—è¡¨ä¸é˜Ÿåˆ—

### ArrayList

#### 1. æ¦‚è§ˆ

- ä½¿ç”¨æ—¶éœ€è¦å®ä¾‹åŒ–æ³›å‹å‚æ•°ã€‚
- ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
- å¯ä»¥éšæœºè®¿é—®ï¼ŒæŒ‰ç…§ç´¢å¼•è¿›è¡Œè®¿é—®çš„æ•ˆç‡å¾ˆé«˜ï¼Œæ•ˆç‡ä¸º O(1)ã€‚
- é™¤éæ•°ç»„å·²ç»æ’åºï¼Œå¦åˆ™æŒ‰ç…§å†…å®¹æŸ¥æ‰¾å…ƒç´ æ•ˆç‡è¾ƒä½ï¼Œæ•ˆç‡ä¸º O(N)ã€‚
- æ·»åŠ å…ƒç´ æ•ˆç‡è¿˜è¡Œï¼Œä½†æ˜¯ä¼šé¢ä¸´æ•°ç»„æ‰©å®¹ä¸å†…å®¹å¤åˆ¶ç­‰å¼€é”€é—®é¢˜ã€‚
- æ’å…¥ä¸åˆ é™¤å…ƒç´ æ•ˆç‡è¾ƒä½ï¼Œå› ä¸ºéœ€è¦ç§»åŠ¨å…ƒç´ ã€‚



å› ä¸º ArrayList æ˜¯åŸºäº**æ•°ç»„**å®ç°çš„ï¼Œæ‰€ä»¥æ”¯æŒ**å¿«é€Ÿéšæœºè®¿é—®**ã€‚RandomAccess æ¥å£æ ‡è¯†ç€è¯¥ç±»æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ï¼ŒRandomAccess æ˜¯ä¸€ä¸ªæ ‡è®°æ¥å£ï¼Œæ²¡æœ‰ä»»ä½•æ–¹æ³•ã€‚

```java
public class ArrayList<E> extends AbstractList<E>
        implements List<E>, RandomAccess, Cloneable, java.io.Serializable
```

æ•°ç»„çš„é»˜è®¤å¤§å°ä¸º 10ã€‚

```java
private static final int DEFAULT_CAPACITY = 10;
```

![1563604782084](assets/1563604782084.png)

#### 2. æ‰©å®¹

æ·»åŠ å…ƒç´ æ—¶ä½¿ç”¨ ensureCapacityInternal() æ–¹æ³•æ¥ä¿è¯å®¹é‡è¶³å¤Ÿï¼Œå¦‚æœä¸å¤Ÿæ—¶ï¼Œéœ€è¦ä½¿ç”¨ grow() æ–¹æ³•è¿›è¡Œæ‰©å®¹ï¼Œæ–°å®¹é‡çš„å¤§å°ä¸º `oldCapacity + (oldCapacity >> 1)`ï¼Œä¹Ÿå°±æ˜¯æ—§å®¹é‡çš„ **1.5 å€**ã€‚elementData æ•°ç»„ä¼šéšç€å®é™…å…ƒç´ ä¸ªæ•°çš„å¢å¤šè€Œé‡æ–°åˆ†é…ã€‚

æ‰©å®¹æ“ä½œéœ€è¦è°ƒç”¨ `Arrays.copyOf()` æŠŠåŸæ•°ç»„æ•´ä¸ªå¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­ï¼Œè¿™ä¸ªæ“ä½œä»£ä»·å¾ˆé«˜ï¼Œå› æ­¤æœ€å¥½åœ¨åˆ›å»º ArrayList å¯¹è±¡æ—¶å°±**æŒ‡å®š**å¤§æ¦‚çš„å®¹é‡å¤§å°ï¼Œ**å‡å°‘æ‰©å®¹æ“ä½œçš„æ¬¡æ•°**ã€‚

```java
public boolean add(E e) {
    ensureCapacityInternal(size + 1);  // Increments modCount!!
    elementData[size++] = e;		// size ç”¨äºè®°å½•å®é™…çš„å…ƒç´ ä¸ªæ•°	
    return true;
}

// ç¡®ä¿æ•°ç»„å®¹é‡è¶³å¤Ÿ
private void ensureCapacityInternal(int minCapacity) {
    if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
        minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);
    }
    ensureExplicitCapacity(minCapacity);
}

private void ensureExplicitCapacity(int minCapacity) {
    // è¡¨ç¤ºå†…éƒ¨ä¿®æ”¹æ¬¡æ•°
    modCount++;
    // overflow-conscious code
    if (minCapacity - elementData.length > 0)
        grow(minCapacity);
}

// å¢åŠ æ•°ç»„å®¹é‡
private void grow(int minCapacity) {
    // overflow-conscious code
    int oldCapacity = elementData.length;
    // å³ç§»ä¸€ä½ç›¸å½“äºé™¤2ï¼Œå› æ­¤æ‰©å®¹ä¸ºåŸæ¥çš„1.5å€
    int newCapacity = oldCapacity + (oldCapacity >> 1);
    if (newCapacity - minCapacity < 0)
        newCapacity = minCapacity;
    if (newCapacity - MAX_ARRAY_SIZE > 0)
        newCapacity = hugeCapacity(minCapacity);
    // minCapacity is usually close to size, so this is a win:
    elementData = Arrays.copyOf(elementData, newCapacity);
}
```

#### 3. åˆ é™¤å…ƒç´ 

éœ€è¦è°ƒç”¨ System.arraycopy() å°† index+1 åé¢çš„å…ƒç´ éƒ½å¤åˆ¶åˆ° index ä½ç½®ä¸Šï¼Œè¯¥æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼Œå¯ä»¥çœ‹å‡º ArrayList åˆ é™¤å…ƒç´ çš„ä»£ä»·æ˜¯**éå¸¸é«˜**çš„ã€‚

```java
public E remove(int index) {
    rangeCheck(index);
    modCount++;
    E oldValue = elementData(index);
    int numMoved = size - index - 1;
    if (numMoved > 0)
        System.arraycopy(elementData, index+1, elementData, index, numMoved);
    elementData[--size] = null; // é‡Šæ”¾å¼•ç”¨ä»¥ä¾¿åŸå¯¹è±¡è¢«åƒåœ¾å›æ”¶
    return oldValue;
}
```

**è¿­ä»£ä¸åˆ é™¤**

è¿­ä»£å™¨çš„å¸¸è§è¯¯ç”¨å°±æ˜¯åœ¨è¿­ä»£çš„ä¸­é—´è°ƒç”¨å®¹å™¨çš„åˆ é™¤æ–¹æ³•ã€‚

```java
List<String> list = new ArrayList<>();
list.add("str1");
list.add("str2");
list.add("str3");
for (String s : list) {
    if ("str1".equals(s)) {
        list.remove(s);
    }
}
```

è¿™æ®µä»£ç çœ‹èµ·æ¥å¥½åƒæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬è¿è¡Œï¼Œå°±ä¼šæŠ›å‡º **ConcurrentModificationException** å¼‚å¸¸ã€‚

å…¶å®è¿™ä¸æ˜¯ç‰¹ä¾‹ï¼Œæ¯å½“æˆ‘ä»¬ä½¿ç”¨è¿­ä»£å™¨éå†å…ƒç´ æ—¶ï¼Œå¦‚æœä¿®æ”¹äº†å…ƒç´ å†…å®¹ï¼ˆæ·»åŠ ã€åˆ é™¤å…ƒç´ ï¼‰ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œç”±äº **foreach** åŒæ ·ä½¿ç”¨çš„æ˜¯è¿­ä»£å™¨ï¼Œæ‰€ä»¥ä¹Ÿæœ‰åŒæ ·çš„æƒ…å†µã€‚

remove æ–¹æ³•çš„æºç 

```java
public class ArrayList<E> {

    void remove() {
        modCount++;  // ç»§æ‰¿è‡ªAbstractListçš„å±æ€§ï¼Œä¿å­˜å¯¹å…¶ä¸­å…ƒç´ çš„ä¿®æ”¹æ¬¡æ•°ï¼Œæ¯æ¬¡å¢åŠ æˆ–åˆ é™¤æ—¶åŠ 1
        // å…·ä½“åˆ é™¤æ“ä½œä»£ç 
        //...
    }
  
    public Iterator<E> iterator() {
        return new Itr();
    }

    private class Itr implements Iterator<E> {
        int cursor;       // index of next element to return
        // åœ¨åˆ›å»ºè¿­ä»£å™¨æ—¶å°†å½“å‰ArrayListçš„ä¿®æ”¹æ¬¡æ•°èµ‹å€¼ç»™ expectedModCount ä¿å­˜
        int expectedModCount = modCount;
        public boolean hasNext() {
            return cursor != size;
        }
        
        @SuppressWarnings("unchecked")
        public E next() {
            // æ£€æŸ¥å½“å‰æ‰€åœ¨çš„ ArrayList çš„ modCount æ˜¯å¦ä¸åˆ›å»º Itr æ—¶çš„å€¼ä¸€è‡´ï¼Œ
            // ä¹Ÿå°±æ˜¯åˆ¤æ–­è·å–äº†Itrè¿­ä»£å™¨å ArrayList ä¸­çš„å…ƒç´ æ˜¯å¦è¢« Itr å¤–éƒ¨çš„æ–¹æ³•æ”¹å˜è¿‡ã€‚
            checkForComodification();
            // å…·ä½“çš„è·å–ä¸‹ä¸€ä¸ªå…ƒç´ çš„ä»£ç 
            // ...
        }
        
        public void remove() {
            if (lastRet < 0)
                throw new IllegalStateException();
            // åŒ next ä¸­çš„ checkForComodification æ–¹æ³•
            checkForComodification();
            try {
                ArrayList.this.remove(lastRet);
                cursor = lastRet;
                lastRet = -1;
                // Itr å†…éƒ¨çš„åˆ é™¤å…ƒç´ æ“ä½œï¼Œä¼šæ›´æ–° expectedModCount å€¼ï¼Œè€Œå¤–éƒ¨çš„åˆ™ä¸ä¼š
                expectedModCount = modCount;
            } catch (IndexOutOfBoundsException ex) {
                throw new ConcurrentModificationException();
            }
        }

        final void checkForComodification() {
            if (modCount != expectedModCount)
                throw new ConcurrentModificationException();
        }
    }
}
```

å¯ä»¥æ˜æ˜¾çš„çœ‹åˆ°å…±æœ‰ä¸¤ä¸ª`remove()`æ–¹æ³•ï¼Œä¸€ä¸ªå±äº ArrayList æœ¬èº«ï¼Œè¿˜æœ‰ä¸€ä¸ªå±äºå…¶å†…éƒ¨ç±» Itrã€‚ArrayList ç±»ä¸­æœ‰ä¸€ä¸ª modCount å±æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯ç»§æ‰¿å­AbstractListï¼Œå…¶ä¿å­˜äº†æˆ‘ä»¬å¯¹ ArrayList è¿›è¡Œçš„çš„**æ“ä½œæ¬¡æ•°**ï¼Œå½“æˆ‘ä»¬æ·»åŠ æˆ–è€…åˆ é™¤å…ƒç´ æ—¶ï¼ŒmodeCount éƒ½ä¼šè¿›è¡Œå¯¹åº”æ¬¡æ•°çš„**å¢åŠ **ã€‚ç›¸å½“äºè®°å½•äº†ç»“æ„æ€§å˜åŒ–ï¼Œå³æ·»åŠ ã€æ’å…¥ã€åˆ é™¤å…ƒç´ ï¼Œåªæ˜¯ä¿®æ”¹å…ƒç´ çš„å†…å®¹ä¸ç®—ç»“æ„æ€§å˜åŒ–ã€‚

åœ¨æˆ‘ä»¬ä½¿ç”¨ ArrayList çš„ `iterator()` æ–¹æ³•è·å–åˆ°è¿­ä»£å™¨è¿›è¡Œéå†æ—¶ï¼Œä¼šæŠŠ ArrayList å½“å‰çŠ¶æ€ä¸‹çš„ modCount èµ‹å€¼ç»™ Itr ç±»çš„ expectedModeCount å±æ€§ã€‚å¦‚æœæˆ‘ä»¬åœ¨è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨äº† ArrayList çš„ `remove()`æˆ–`add()`æ–¹æ³•ï¼Œè¿™æ—¶ modCount å°±ä¼šåŠ  1 ï¼Œä½†æ˜¯è¿­ä»£å™¨ä¸­çš„expectedModeCount å¹¶æ²¡æœ‰å˜åŒ–ï¼Œå½“æˆ‘ä»¬å†ä½¿ç”¨è¿­ä»£å™¨çš„`next()`æ–¹æ³•æ—¶ï¼Œå®ƒä¼šè°ƒç”¨`checkForComodification()`æ–¹æ³•ï¼Œå³

```java
final void checkForComodification() {
    if (modCount != expectedModCount)
    throw new ConcurrentModificationException();
}
```

å‘ç°ç°åœ¨çš„ modCount å·²ç»ä¸ expectedModCount **ä¸ä¸€è‡´**äº†ï¼Œåˆ™ä¼šæŠ›å‡º`ConcurrentModificationException`å¼‚å¸¸ã€‚

ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨è¿­ä»£å™¨æä¾›çš„`remove()`æ–¹æ³•ï¼Œç”±äºå…¶æœ‰ä¸€ä¸ªæ“ä½œï¼š`expectedModCount = modCount;`ï¼Œä¼šä¿®æ”¹expectedModCount çš„å€¼ï¼Œæ‰€ä»¥å°±ä¸ä¼šå­˜åœ¨ä¸Šè¿°é—®é¢˜ã€‚è°ƒç”¨remove æ–¹æ³•ä¹‹å‰éœ€è¦å…ˆè°ƒç”¨ next æ–¹æ³•ã€‚



#### 4. Fail-Fast

fail-fast æœºåˆ¶åœ¨éå†ä¸€ä¸ªé›†åˆæ—¶ï¼Œå½“é›†åˆç»“æ„è¢«ä¿®æ”¹ï¼Œä¼šæŠ›å‡º ConcurrentModificationExceptionã€‚

modCount ç”¨æ¥è®°å½• ArrayList **ç»“æ„å‘ç”Ÿå˜åŒ–çš„æ¬¡æ•°**ã€‚ç»“æ„å‘ç”Ÿå˜åŒ–æ˜¯æŒ‡æ·»åŠ æˆ–è€…åˆ é™¤è‡³å°‘ä¸€ä¸ªå…ƒç´ çš„æ‰€æœ‰æ“ä½œï¼Œæˆ–è€…æ˜¯è°ƒæ•´å†…éƒ¨æ•°ç»„çš„å¤§å°ï¼Œä»…ä»…åªæ˜¯è®¾ç½®å…ƒç´ çš„å€¼ä¸ç®—ç»“æ„å‘ç”Ÿå˜åŒ–ã€‚

åœ¨è¿›è¡Œ**åºåˆ—åŒ–æˆ–è€…è¿­ä»£**ç­‰æ“ä½œæ—¶ï¼Œéœ€è¦**æ¯”è¾ƒ**æ“ä½œå‰å modCount æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœæ”¹å˜äº†éœ€è¦æŠ›å‡º ConcurrentModificationExceptionã€‚

```java
private void writeObject(java.io.ObjectOutputStream s)
    throws java.io.IOException{
    // Write out element count, and any hidden stuff
    int expectedModCount = modCount;
    s.defaultWriteObject();

    // Write out size as capacity for behavioural compatibility with clone()
    s.writeInt(size);

    // Write out all elements in the proper order.
    for (int i=0; i<size; i++) {
        s.writeObject(elementData[i]);
    }

    if (modCount != expectedModCount) {
        throw new ConcurrentModificationException();
    }
}
```

#### 5. åºåˆ—åŒ–

ArrayList åŸºäºæ•°ç»„å®ç°ï¼Œå¹¶ä¸”å…·æœ‰åŠ¨æ€æ‰©å®¹ç‰¹æ€§ï¼Œå› æ­¤ä¿å­˜å…ƒç´ çš„æ•°ç»„ä¸ä¸€å®šéƒ½ä¼šè¢«ä½¿ç”¨ï¼Œé‚£ä¹ˆ**å°±æ²¡å¿…è¦å…¨éƒ¨**è¿›è¡Œåºåˆ—åŒ–ã€‚

ä¿å­˜å…ƒç´ çš„æ•°ç»„ elementData ä½¿ç”¨ transient ä¿®é¥°ï¼Œè¯¥å…³é”®å­—å£°æ˜æ•°ç»„é»˜è®¤**ä¸ä¼šè¢«åºåˆ—åŒ–**ã€‚

```java
transient Object[] elementData; // non-private to simplify nested class access
```

ArrayList å®ç°äº† writeObject() å’Œ readObject() æ¥æ§åˆ¶**åªåºåˆ—åŒ–æ•°ç»„ä¸­æœ‰å…ƒç´ å¡«å……é‚£éƒ¨åˆ†**å†…å®¹ã€‚æ•°ç»„æ²¡æœ‰å­˜å…ƒç´ çš„éƒ¨åˆ†ä¸åºåˆ—åŒ–ã€‚

```java
private void readObject(java.io.ObjectInputStream s)
    throws java.io.IOException, ClassNotFoundException {
    elementData = EMPTY_ELEMENTDATA;

    // Read in size, and any hidden stuff
    s.defaultReadObject();

    // Read in capacity
    s.readInt(); // ignored

    if (size > 0) {
        // be like clone(), allocate array based upon size not capacity
        ensureCapacityInternal(size);

        Object[] a = elementData;
        // Read in all elements in the proper order.
        for (int i=0; i<size; i++) {
            a[i] = s.readObject();
        }
    }
}
```

```java
private void writeObject(java.io.ObjectOutputStream s)
    throws java.io.IOException{
    // Write out element count, and any hidden stuff
    int expectedModCount = modCount;
    s.defaultWriteObject();

    // Write out size as capacity for behavioural compatibility with clone()
    s.writeInt(size);

    // Write out all elements in the proper order.
    for (int i=0; i<size; i++) {
        s.writeObject(elementData[i]);
    }

    if (modCount != expectedModCount) {
        throw new ConcurrentModificationException();
    }
}
```

åºåˆ—åŒ–æ—¶éœ€è¦ä½¿ç”¨ ObjectOutputStream çš„ writeObject() å°†å¯¹è±¡è½¬æ¢ä¸º**å­—èŠ‚æµ**å¹¶è¾“å‡ºã€‚è€Œ writeObject() æ–¹æ³•åœ¨ä¼ å…¥çš„å¯¹è±¡å­˜åœ¨ writeObject() çš„æ—¶å€™ä¼šå»**åå°„**è°ƒç”¨è¯¥å¯¹è±¡çš„ writeObject() æ¥å®ç°**åºåˆ—åŒ–**ã€‚ååºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯ ObjectInputStream çš„ readObject() æ–¹æ³•ï¼ŒåŸç†ç±»ä¼¼ã€‚

```java
ArrayList list = new ArrayList();
ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(file));
oos.writeObject(list);
```

#### 6. Arrays.asList()

Arraysç±»çš„é™æ€æ–¹æ³• asList() å°†æ•°ç»„è½¬ä¸ºé›†åˆã€‚

```java
String[] str = new String[]{"1","2","3"};
List aslist = Arrays.asList(str);
aslsit.add("4");
// Exception in thread "main" java.lang.UnsupportedOperationException
//    at java.util.AbstractList.add(Unknown Source)
//    at java.util.AbstractList.add(Unknown Source)
//    at test.LinkedListTest.main(LinkedListTest.java:13)
```

å…¶å® asList() è¿”å›çš„æ˜¯ java.util.Arrays.ArrayList å¯¹è±¡ï¼Œä¸æ˜¯ä¸Šè¿°çš„ ArrayList ç±»ï¼ï¼ï¼ï¼

çœ‹ Arrays ç±»çš„éƒ¨åˆ†æºç 

```java
public class Arrays {
    
    // çœç•¥å…¶ä»–æ–¹æ³•
    
    public static <T> List<T> asList(T... a) {
        return new ArrayList<>(a);
    }
        
    // å°±æ˜¯è¿™ä¸ªå®¶ä¼™             ğŸ‘‡
    private static class ArrayList<E> extends AbstractList<E>
            implements RandomAccess, java.io.Serializable{
    
        private final E[] a;
    
        ArrayList(E[] array) {
            a = Objects.requireNonNull(array);
        }
    
        @Override
        public int size() {
            return a.length;
        }
        //çœç•¥å…¶ä»–æ–¹æ³•
    }
}
```

Arrays.ArrayList æ˜¯å·¥å…·ç±» Arrays çš„ä¸€ä¸ª**å†…éƒ¨é™æ€ç±»**ï¼Œå®ƒ**æ²¡æœ‰å®Œå…¨**å®ç° List çš„æ–¹æ³•ï¼Œè€Œ ArrayList ç›´æ¥å®ç°äº†List æ¥å£ï¼Œå®ç°äº† List æ‰€æœ‰æ–¹æ³•ã€‚Arrays.ArrayList æ˜¯ä¸€ä¸ªå®šé•¿é›†åˆï¼Œå› ä¸ºå®ƒ**æ²¡æœ‰é‡å†™** add, remove æ–¹æ³•ï¼Œæ‰€ä»¥ä¸€æ—¦åˆå§‹åŒ–å…ƒç´ åï¼Œé›†åˆçš„ size å°±æ˜¯ä¸å¯å˜çš„ã€‚æ‰€ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•ä¼šæŠ› UnsupportedOperationException å¼‚å¸¸ã€‚

**æ­£ç¡®**çš„ä½¿ç”¨æ–¹å¼ï¼š

```java
String[] str = new String[]{"1","2","3"};
ArrayList al = new ArrayList(Arrays.asList(str)); // å°†æ•°ç»„å…ƒç´ æ·»åŠ åˆ°é›†åˆçš„ä¸€ç§å¿«æ·æ–¹å¼
```





### LinkedList

#### 1. æ¦‚è§ˆ

- åŒæ ·å®ç°äº† List æ¥å£ï¼Œå…¶ç‰¹ç‚¹ä¸ ArrayList å‡ ä¹ç›¸åã€‚
- LinkedList è¿˜å®ç°äº† Deque å’Œ Queue æ¥å£ï¼Œå¯ä»¥æŒ‰ç…§é˜Ÿåˆ—ã€æ ˆå’ŒåŒç«¯é˜Ÿåˆ—çš„æ–¹å¼è¿›è¡Œæ“ä½œã€‚
- LinkedList æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„é˜Ÿåˆ—ã€‚

#### 2. ä¸ ArrayList çš„æ¯”è¾ƒ

- ArrayList åŸºäº**åŠ¨æ€æ•°ç»„**å®ç°ï¼ŒLinkedList åŸºäº**åŒå‘é“¾è¡¨**å®ç°ï¼›
- ArrayList æ”¯æŒ**éšæœºè®¿é—®**ï¼ŒLinkedList ä¸æ”¯æŒï¼›
- LinkedList åœ¨ä»»æ„ä½ç½®æ·»åŠ åˆ é™¤å…ƒç´ **æ›´å¿«**ã€‚

#### 3. åŸºæœ¬ä½¿ç”¨

##### æ„é€ æ–¹æ³•

```java
LinkedList() 	// ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºlinkedList
LinkedList(Collection<? extends E> c) // ä½¿ç”¨ä¸€ä¸ªé›†åˆåˆ›å»ºä¸€ä¸ªæ–°çš„linkedList
```

```java
public class Main {
    public static void main(String[] args) {
        LinkedList<String> linkedList1 = new LinkedList<>();
        System.out.println(linkedList1);
        String[] arr = {"H", "E", "L", "L", "O"};
        LinkedList<String> linkedList2 = new LinkedList<>(Arrays.asList(arr));
        System.out.println(linkedList2);
    }
}
```

##### å…¶ä»–æ–¹æ³•

```java
int size();  	// å®ƒè¿”å›æ­¤åˆ—è¡¨ä¸­å…ƒç´ çš„æ•°é‡
void clear();  	// å®ƒåˆ é™¤åˆ—è¡¨ä¸­çš„æ‰€æœ‰å…ƒç´ 
Object clone();	//å®ƒç”¨äºåˆ¶ä½œç°æœ‰é“¾æ¥åˆ—è¡¨çš„å‰¯æœ¬
Object set(int indexï¼ŒObject element);  // å®ƒç”¨äºç”¨æ–°å…ƒç´ æ›¿æ¢åˆ—è¡¨ä¸­çš„ç°æœ‰å…ƒç´ 
boolean contains(Object element);		// å¦‚æœå…ƒç´ å­˜åœ¨äºåˆ—è¡¨ä¸­ï¼Œåˆ™è¿”å›true
boolean add(Object element);			// å®ƒå°†å…ƒç´ é™„åŠ åˆ°åˆ—è¡¨çš„æœ«å°¾
void add(int indexï¼ŒObject element);	   // å®ƒå°†å…ƒç´ æ’å…¥åˆ—è¡¨ä¸­'index'ä½ç½®
boolean addAll(Collection C);			// å®ƒå°†ä¸€ä¸ªé›†åˆè¿½åŠ åˆ°é“¾æ¥åˆ—è¡¨
boolean addAll(int indexï¼ŒCollection C);// å®ƒå°†ä¸€ä¸ªé›†åˆè¿½åŠ åˆ°æŒ‡å®šä½ç½®çš„é“¾è¡¨ä¸­
void addFirst(Object element);			// å®ƒå°†å…ƒç´ æ’å…¥åˆ—è¡¨çš„å¼€å¤´
void addLast(Object element);			// å®ƒå°†å…ƒç´ é™„åŠ åœ¨åˆ—è¡¨çš„æœ«å°¾
Object get(int index);	// å®ƒè¿”å›åˆ—è¡¨ä¸­ä½ç½®'index'å¤„çš„å…ƒç´ ã€‚å¦‚æœç´¢å¼•è¶…å‡ºäº†åˆ—è¡¨çš„èŒƒå›´ï¼Œå®ƒä¼šæŠ›å‡º'IndexOutOfBoundsException'
Object getFirst();		// å®ƒè¿”å›é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
Object getLast();		// å®ƒè¿”å›é“¾æ¥åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ 
int indexOf(Object element);	// å¦‚æœæ‰¾åˆ°å…ƒç´ ï¼Œå®ƒå°†è¿”å›å…ƒç´ ç¬¬ä¸€æ¬¡å‡ºç°çš„ç´¢å¼•ã€‚å¦åˆ™ï¼Œå®ƒè¿”å›-1
int lastIndexOf(Object element);// å¦‚æœæ‰¾åˆ°å…ƒç´ ï¼Œå®ƒå°†è¿”å›å…ƒç´ æœ€åä¸€æ¬¡å‡ºç°çš„ç´¢å¼•ã€‚å¦åˆ™ï¼Œå®ƒè¿”å›-1
Object remove();		// å®ƒç”¨äºä»åˆ—è¡¨å¤´éƒ¨åˆ é™¤å¹¶è¿”å›å…ƒç´ 
Object remove(int index);		// å®ƒåˆ é™¤æ­¤åˆ—è¡¨ä¸­ä½ç½®'index'å¤„çš„å…ƒç´ ã€‚å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œå®ƒä¼šæŠ›å‡º'NoSuchElementException'
boolean remove(Object O);		// å®ƒç”¨äºä»é“¾è¡¨ä¸­ç§»é™¤ä¸€ä¸ªç‰¹å®šçš„å…ƒç´ å¹¶è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼
Object removeLast();			// å®ƒç”¨äºåˆ é™¤å¹¶è¿”å›é“¾æ¥åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ 
```

#### 4. æºç è§£æ

åŸºäº**åŒå‘é“¾è¡¨**å®ç°ï¼Œä½¿ç”¨ Node å­˜å‚¨é“¾è¡¨èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¹¶ç»´æŠ¤äº†é•¿åº¦ã€å¤´ç»“ç‚¹å’Œå°¾ç»“ç‚¹ã€‚

```java
private static class Node<E> {
    E item;
    Node<E> next;
    Node<E> prev;
     
    Node(Node<E> prev, E element, Node<E> next) {
    	this.item = element;
     	this.next = next;
     	this.prev = prev;
 	}
}
```

æ¯ä¸ªé“¾è¡¨å­˜å‚¨äº† first å’Œ last æŒ‡é’ˆï¼ŒLinkedList ä¸­çš„å±æ€§å¦‚ä¸‹

```java
// é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°
transient int size = 0;
// æŒ‡å‘å¤´èŠ‚ç‚¹çš„æŒ‡é’ˆ
transient Node<E> first;
// æŒ‡å‘å°¾èŠ‚ç‚¹çš„æŒ‡é’ˆ
transient Node<E> last;
```

![1567326494424](assets/1567326494424.png)

**æ·»åŠ å…ƒç´ **

å¯¹äºé“¾è¡¨è¿™ç§æ•°æ®ç»“æ„æ¥è¯´ï¼Œæ·»åŠ å…ƒç´ çš„æ“ä½œæ— éå°±æ˜¯åœ¨è¡¨å¤´/è¡¨å°¾æ’å…¥å…ƒç´ ï¼Œåˆæˆ–è€…åœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ ã€‚å› ä¸º LinkedList æœ‰å¤´æŒ‡é’ˆå’Œå°¾æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨è¡¨å¤´æˆ–è¡¨å°¾è¿›è¡Œæ’å…¥å…ƒç´ åªéœ€è¦ O(1) çš„æ—¶é—´ï¼Œè€Œåœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ åˆ™éœ€è¦å…ˆéå†ä¸€ä¸‹é“¾è¡¨ï¼Œæ‰€ä»¥å¤æ‚åº¦ä¸º O(n)ã€‚

åœ¨è¡¨å¤´æ·»åŠ å…ƒç´ çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š

![1567329260161](assets/1567329260161.png)

å½“å‘**è¡¨å¤´**æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå¾ˆæ˜¾ç„¶å½“å‰èŠ‚ç‚¹çš„**å‰é©±**ä¸€å®šä¸º **null**ï¼Œè€Œåç»§ç»“ç‚¹æ˜¯ first æŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ï¼Œå½“ç„¶è¿˜è¦ä¿®æ”¹ first æŒ‡é’ˆæŒ‡å‘æ–°çš„å¤´èŠ‚ç‚¹ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒåŸæ¥çš„å¤´èŠ‚ç‚¹å˜æˆäº†ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿˜è¦ä¿®æ”¹åŸæ¥å¤´èŠ‚ç‚¹çš„å‰é©±æŒ‡é’ˆï¼Œä½¿å®ƒæŒ‡å‘è¡¨å¤´èŠ‚ç‚¹ï¼Œæºç çš„å®ç°å¦‚ä¸‹ï¼š

```java
private void linkFirst(E e) {
    final Node<E> f = first;
    // å½“å‰èŠ‚ç‚¹çš„å‰é©±æŒ‡å‘ nullï¼Œåç»§æŒ‡é’ˆåŸæ¥çš„å¤´èŠ‚ç‚¹
    final Node<E> newNode = new Node<>(null, e, f);
    // å¤´æŒ‡é’ˆæŒ‡å‘æ–°çš„å¤´èŠ‚ç‚¹
    first = newNode;
    // å¦‚æœåŸæ¥æœ‰å¤´èŠ‚ç‚¹ï¼Œåˆ™æ›´æ–°åŸæ¥èŠ‚ç‚¹çš„å‰é©±æŒ‡é’ˆï¼Œå¦åˆ™æ›´æ–°å°¾æŒ‡é’ˆ
    if (f == null) {
        last = newNode;
    } else {
        f.prev = newNode;
    }
    size++;
    modCount++;
}
```

å½“å‘**è¡¨å°¾**æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå¾ˆæ˜¾ç„¶å½“å‰èŠ‚ç‚¹çš„**åç»§**ä¸€å®šä¸º **null**ï¼Œè€Œå‰é©±ç»“ç‚¹æ˜¯ lastæŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ï¼Œç„¶åè¿˜è¦ä¿®æ”¹ last æŒ‡é’ˆæŒ‡å‘æ–°çš„å°¾èŠ‚ç‚¹ã€‚æ­¤å¤–ï¼Œè¿˜è¦ä¿®æ”¹åŸæ¥å°¾èŠ‚ç‚¹çš„åç»§æŒ‡é’ˆï¼Œä½¿å®ƒæŒ‡å‘æ–°çš„å°¾èŠ‚ç‚¹ï¼Œæ­¤å¤„ä¸èµ˜è¿°ã€‚

æœ€åï¼Œåœ¨æŒ‡å®šèŠ‚ç‚¹ä¹‹å‰æ’å…¥ï¼Œå¦‚å›¾æ‰€ç¤º

![1567329526899](assets/1567329526899.png)

å½“å‘æŒ‡å®šèŠ‚ç‚¹ä¹‹å‰æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå½“å‰èŠ‚ç‚¹çš„**åç»§ä¸ºæŒ‡å®šèŠ‚ç‚¹**ï¼Œè€Œ**å‰é©±ç»“ç‚¹ä¸ºæŒ‡å®šèŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹**ã€‚æ­¤å¤–ï¼Œè¿˜è¦ä¿®æ”¹å‰é©±èŠ‚ç‚¹çš„åç»§ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œä»¥åŠåç»§èŠ‚ç‚¹çš„å‰é©±ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œæºç çš„å®ç°å¦‚ä¸‹ï¼š

```java
void linkBefore(E e, Node<E> succ) {
    // assert succ != null;
    //æŒ‡å®šèŠ‚ç‚¹çš„å‰é©±
    final Node<E> pred = succ.prev;
    //å½“å‰èŠ‚ç‚¹çš„å‰é©±ä¸ºæŒ‡ç‚¹èŠ‚ç‚¹çš„å‰é©±ï¼Œåç»§ä¸ºæŒ‡å®šçš„èŠ‚ç‚¹
    final Node<E> newNode = new Node<>(pred, e, succ);
    //æ›´æ–°æŒ‡å®šèŠ‚ç‚¹çš„å‰é©±ä¸ºå½“å‰èŠ‚ç‚¹
    succ.prev = newNode;
    //æ›´æ–°å‰é©±èŠ‚ç‚¹çš„åç»§
    if (pred == null)
        first = newNode;
    else
        pred.next = newNode;
    size++;
    modCount++;
}
```

**æ•°æ®åŒ…å«**

```java
public boolean contains(Object o) {
     return indexOf(o) != -1;
 }
 // ä»å‰å‘åæŸ¥æ‰¾ï¼Œè¿”å›â€œå€¼ä¸ºå¯¹è±¡(o)çš„èŠ‚ç‚¹å¯¹åº”çš„ç´¢å¼•â€  ä¸å­˜åœ¨å°±è¿”å›-1 
 public int indexOf(Object o) {
      int index = 0;
      if (o==null) {
          for (Entry e = header.next; e != header; e = e.next) {
              if (e.element==null)
                  return index;
              index++;
         }
      } else {
         for (Entry e = header.next; e != header; e = e.next) {
             if (o.equals(e.element))
                 return index;
             index++;
        }
    }
     return -1;
 }
```

indexOf(Object o)åˆ¤æ–­oé“¾è¡¨ä¸­æ˜¯å¦å­˜åœ¨èŠ‚ç‚¹çš„elementå’Œoç›¸ç­‰ï¼Œè‹¥ç›¸ç­‰åˆ™è¿”å›è¯¥èŠ‚ç‚¹åœ¨é“¾è¡¨ä¸­çš„ç´¢å¼•ä½ç½®ï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ”¾å›-1ã€‚

contains(Object o)æ–¹æ³•é€šè¿‡åˆ¤æ–­indexOf(Object o)æ–¹æ³•è¿”å›çš„å€¼æ˜¯å¦æ˜¯-1æ¥åˆ¤æ–­é“¾è¡¨ä¸­æ˜¯å¦åŒ…å«å¯¹è±¡oã€‚

**è·å–æ•°æ®**

Get(int) æ–¹æ³•ç”¨äºè·å–æŒ‡å®šä½ç½®çš„æ•°æ®ã€‚é¦–å…ˆåˆ¤æ–­ä½ç½®ä¿¡æ¯æ˜¯å¦åˆæ³•ï¼ˆå¤§äºç­‰äº0ï¼Œå°äºå½“å‰ LinkedList å®ä¾‹çš„Sizeï¼‰ï¼Œç„¶å**éå†**åˆ°å…·ä½“ä½ç½®ï¼Œè·å¾—èŠ‚ç‚¹çš„ä¸šåŠ¡æ•°æ®ï¼ˆelementï¼‰å¹¶è¿”å›ã€‚

æ³¨æ„ï¼šä¸ºäº†æé«˜æ•ˆç‡ï¼Œéœ€è¦æ ¹æ®è·å–çš„ä½ç½®åˆ¤æ–­æ˜¯ä»å¤´è¿˜æ˜¯ä»å°¾å¼€å§‹éå†ã€‚

```java
// è·å–åŒå‘é“¾è¡¨ä¸­æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹    
private Entry<E> entry(int index) {    
    if (index < 0 || index >= size) {
        throw new IndexOutOfBoundsException("Index: " + index + ", Size: " + size); 
    }   
   
    Entry<E> e = header;    
    // è·å–indexå¤„çš„èŠ‚ç‚¹ã€‚    
    // è‹¥index < åŒå‘é“¾è¡¨é•¿åº¦çš„1/2,åˆ™ä»å‰å…ˆåæŸ¥æ‰¾;    
    // å¦åˆ™ï¼Œä»åå‘å‰æŸ¥æ‰¾ã€‚    
    if (index < (size >> 1)) {    
        for (int i = 0; i <= index; i++)    
            e = e.next;    
    } else {    
        for (int i = size; i > index; i--)    
            e = e.previous;    
    }    
    return e;    
}
```

æ³¨æ„ç»†èŠ‚ï¼š**ä½è¿ç®—**ä¸ç›´æ¥åšé™¤æ³•çš„åŒºåˆ«ã€‚å…ˆå°† index ä¸é•¿åº¦ size çš„**ä¸€åŠ**æ¯”è¾ƒï¼Œå¦‚æœ index < size / 2ï¼Œå°±åªä»ä½ç½®0 å¾€åéå†åˆ°ä½ç½® index å¤„ï¼Œè€Œå¦‚æœ index > size / 2ï¼Œå°±åªä»ä½ç½® size å¾€å‰éå†åˆ°ä½ç½® index å¤„ã€‚è¿™æ ·å¯ä»¥å‡å°‘ä¸€éƒ¨åˆ†ä¸å¿…è¦çš„éå†ã€‚

**åˆ é™¤æ•°æ®remove()**

å‡ ä¸ªremoveæ–¹æ³•æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨äº†ä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼šremove(Entry\<E> e)ï¼Œåªæ˜¯å…¶ä»–ç®€å•é€»è¾‘ä¸Šçš„åŒºåˆ«ã€‚ä¸‹é¢åˆ†æremove(Entry\<E> e) æ–¹æ³•ã€‚

![1567330247769](assets/1567330247769.png)

```java
private E remove(Entry<E> e) {
    if (e == header){
        throw new NoSuchElementException();
    }
    // ä¿ç•™å°†è¢«ç§»é™¤çš„èŠ‚ç‚¹eçš„å†…å®¹
    E result = e.element;
    // å°†å‰ä¸€èŠ‚ç‚¹çš„nextå¼•ç”¨èµ‹å€¼ä¸ºeçš„ä¸‹ä¸€èŠ‚ç‚¹
    e.previous.next = e.next;
    // å°†eçš„ä¸‹ä¸€èŠ‚ç‚¹çš„previousèµ‹å€¼ä¸ºeçš„ä¸Šä¸€èŠ‚ç‚¹
    e.next.previous = e.previous;
    // ä¸Šé¢ä¸¤æ¡è¯­å¥çš„æ‰§è¡Œå·²ç»å¯¼è‡´äº†æ— æ³•åœ¨é“¾è¡¨ä¸­è®¿é—®åˆ°eèŠ‚ç‚¹ï¼Œè€Œä¸‹é¢è§£é™¤äº†eèŠ‚ç‚¹å¯¹å‰åèŠ‚ç‚¹çš„å¼•ç”¨
    e.next = e.previous = null;
    // å°†è¢«ç§»é™¤çš„èŠ‚ç‚¹çš„å†…å®¹è®¾ä¸ºnull
    e.element = null;
    // ä¿®æ”¹sizeå¤§å°
    size--;
    modCount++;
    // è¿”å›ç§»é™¤èŠ‚ç‚¹eçš„å†…å®¹
    return result;
}
```

ç”±äºåˆ é™¤äº†æŸä¸€èŠ‚ç‚¹å› æ­¤è°ƒæ•´ç›¸åº”èŠ‚ç‚¹çš„å‰åæŒ‡é’ˆä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š

```java
e.previous.next = e.next;	// é¢„åˆ é™¤èŠ‚ç‚¹çš„å‰ä¸€èŠ‚ç‚¹çš„åæŒ‡é’ˆæŒ‡å‘é¢„åˆ é™¤èŠ‚ç‚¹çš„åä¸€ä¸ªèŠ‚ç‚¹
e.next.previous = e.previous;	// é¢„åˆ é™¤èŠ‚ç‚¹çš„åä¸€èŠ‚ç‚¹çš„å‰æŒ‡é’ˆæŒ‡å‘é¢„åˆ é™¤èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹
```

æ¸…ç©ºé¢„åˆ é™¤èŠ‚ç‚¹ï¼š

```java
e.next = e.previous = null;
e.element = null;
```

äº¤ç»™gcå®Œæˆèµ„æºå›æ”¶ï¼Œåˆ é™¤æ“ä½œç»“æŸã€‚

ä¸ArrayListæ¯”è¾ƒè€Œè¨€ï¼ŒLinkedListçš„åˆ é™¤åŠ¨ä½œä¸éœ€è¦â€œç§»åŠ¨â€å¾ˆå¤šæ•°æ®ï¼Œä»è€Œæ•ˆç‡æ›´é«˜ã€‚







### Vector

#### 1. åŒæ­¥

å®ƒçš„å®ç°ä¸ ArrayList ç±»ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨äº† **synchronized** è¿›è¡ŒåŒæ­¥ã€‚åœ¨æ–¹æ³•ä¸ŠåŠ  synchronized ã€‚

```java
public synchronized boolean add(E e) {
    modCount++;
    ensureCapacityHelper(elementCount + 1);
    elementData[elementCount++] = e;
    return true;
}

public synchronized E get(int index) {
    if (index >= elementCount)
        throw new ArrayIndexOutOfBoundsException(index);

    return elementData(index);
}
```

#### 2. ä¸ ArrayList çš„æ¯”è¾ƒ

- Vector æ˜¯**åŒæ­¥**çš„ï¼Œå› æ­¤**å¼€é”€**å°±æ¯” ArrayList è¦**å¤§**ï¼Œè®¿é—®é€Ÿåº¦æ›´æ…¢ã€‚æœ€å¥½ä½¿ç”¨ ArrayList è€Œä¸æ˜¯ Vectorï¼Œå› ä¸ºåŒæ­¥æ“ä½œå®Œå…¨å¯ä»¥ç”±ç¨‹åºå‘˜è‡ªå·±æ¥æ§åˆ¶ï¼›
- Vector æ¯æ¬¡æ‰©å®¹è¯·æ±‚å…¶å¤§å°çš„ **2 å€**ç©ºé—´ï¼Œè€Œ ArrayList æ˜¯ **1.5 å€**ã€‚

#### 3. æ›¿ä»£æ–¹æ¡ˆ

å¯ä»¥ä½¿ç”¨ `Collections.synchronizedList();` å¾—åˆ°ä¸€ä¸ª**çº¿ç¨‹å®‰å…¨çš„ ArrayList**ã€‚

```java
List<String> list = new ArrayList<>();
List<String> synList = Collections.synchronizedList(list);	// â€»
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ concurrent å¹¶å‘åŒ…ä¸‹çš„ **CopyOnWriteArrayList** ç±»ã€‚

```java
List<String> list = new CopyOnWriteArrayList<>();
```





### ArrayDeque

#### æ¦‚è¿°

- Queue ä¹Ÿæ˜¯ Java é›†åˆæ¡†æ¶ä¸­å®šä¹‰çš„ä¸€ç§æ¥å£ï¼Œç›´æ¥ç»§æ‰¿è‡ª Collection æ¥å£ã€‚é™¤äº†åŸºæœ¬çš„ Collection æ¥å£è§„å®šæµ‹æ“ä½œå¤–ï¼ŒQueue æ¥å£è¿˜å®šä¹‰ä¸€ç»„é’ˆå¯¹é˜Ÿåˆ—çš„ç‰¹æ®Šæ“ä½œã€‚é€šå¸¸æ¥è¯´ï¼ŒQueue æ˜¯æŒ‰ç…§å…ˆè¿›å…ˆå‡º (FIFO) çš„æ–¹å¼æ¥ç®¡ç†å…¶ä¸­çš„å…ƒç´ çš„ï¼Œä½†æ˜¯ä¼˜å…ˆé˜Ÿåˆ—æ˜¯ä¸€ä¸ªä¾‹å¤–ã€‚

- Deque æ¥å£ç»§æ‰¿è‡ª Queueæ¥å£ï¼Œä½† Deque æ”¯æŒåŒæ—¶ä»ä¸¤ç«¯æ·»åŠ æˆ–ç§»é™¤å…ƒç´ ï¼Œå› æ­¤åˆè¢«æˆä¸ºåŒç«¯é˜Ÿåˆ—ã€‚é‰´äºæ­¤ï¼ŒDeque æ¥å£çš„å®ç°å¯ä»¥è¢«å½“ä½œ  FIFO é˜Ÿåˆ—ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å½“ä½œLIFOé˜Ÿåˆ—ï¼ˆæ ˆï¼‰æ¥ä½¿ç”¨ã€‚å®˜æ–¹ä¹Ÿæ˜¯æ¨èä½¿ç”¨ Deque çš„å®ç°æ¥æ›¿ä»£ Stackã€‚

- ArrayDeque æ˜¯ Deque æ¥å£çš„ä¸€ç§å…·ä½“å®ç°ï¼Œæ˜¯ä¾èµ–äºå¯å˜æ•°ç»„æ¥å®ç°çš„ã€‚ArrayDeque æ²¡æœ‰å®¹é‡é™åˆ¶ï¼Œå¯æ ¹æ®éœ€æ±‚è‡ªåŠ¨è¿›è¡Œæ‰©å®¹ã€‚ArrayDeque**ä¸æ”¯æŒ**å€¼ä¸º **null** çš„å…ƒç´ ã€‚

- ArrayDeque å¯ä»¥ä½œä¸º**æ ˆ**æ¥ä½¿ç”¨ï¼Œæ•ˆç‡è¦é«˜äº Stackï¼›ArrayDeque ä¹Ÿå¯ä»¥ä½œä¸º**é˜Ÿåˆ—**æ¥ä½¿ç”¨ï¼Œæ•ˆç‡ç›¸è¾ƒäºåŸºäºåŒå‘é“¾è¡¨çš„ LinkedList ä¹Ÿè¦æ›´å¥½ä¸€äº›ã€‚

#### æºç åˆ†æ

**Queue æ¥å£**

```java
public interface Queue<E> extends Collection<E> {
    // å‘é˜Ÿåˆ—ä¸­æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›true
    // å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼ŒæŠ›å‡ºIllegalStateExceptionå¼‚å¸¸
    boolean add(E e);

    // å‘é˜Ÿåˆ—ä¸­æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›true
    // å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œè¿”å›false
    boolean offer(E e);

    // å–å‡ºé˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ï¼Œå¹¶ä»é˜Ÿåˆ—ä¸­ç§»é™¤
    // é˜Ÿåˆ—ä¸ºç©ºï¼ŒæŠ›å‡ºNoSuchElementExceptionå¼‚å¸¸
    E remove();

    // å–å‡ºé˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ï¼Œå¹¶ä»é˜Ÿåˆ—ä¸­ç§»é™¤
    // é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›null
    E poll();

    // å–å‡ºé˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ï¼Œä½†å¹¶ä¸ç§»é™¤
    // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼ŒæŠ›å‡ºNoSuchElementExceptionå¼‚å¸¸
    E element();

    // å–å‡ºé˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ï¼Œä½†å¹¶ä¸ç§»é™¤
    // é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›null
    E peek();
}
```

Deque å’Œ Queue æ–¹æ³•çš„çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š

| Queue Method | Equivalent Deque Method |
| :----------: | :---------------------: |
|    add(e)    |       addLast(e)        |
|   offer(e)   |      offerLast(e)       |
|   remove()   |      removeFirst()      |
|    poll()    |       pollFirst()       |
|  element()   |       getFirst()        |
|    peek()    |       peekFirst()       |

Deque å’Œ Stack æ–¹æ³•çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š

| Stack Method | Equivalent Deque Method |
| :----------: | :---------------------: |
|   push(e)    |       addFirst(e)       |
|    pop()     |      removeFirst()      |
|    peek()    |       peekFirst()       |

ArrayList å®ç°äº† Deque æ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚å› ä¸º ArrayList ä¼šæ ¹æ®éœ€æ±‚è‡ªåŠ¨æ‰©å……å®¹é‡ï¼Œå› è€Œåœ¨æ’å…¥å…ƒç´ çš„æ—¶å€™ä¸ä¼šæŠ›å‡ºIllegalStateExceptionå¼‚å¸¸ã€‚

**åº•å±‚ç»“æ„**

```java
// ç”¨æ•°ç»„å­˜å‚¨å…ƒç´ 
transient Object[] elements; // non-private to simplify nested class access
// å¤´éƒ¨å…ƒç´ çš„ç´¢å¼•
transient int head;
// å°¾éƒ¨ä¸‹ä¸€ä¸ªå°†è¦è¢«åŠ å…¥çš„å…ƒç´ çš„ç´¢å¼•
transient int tail;
// æœ€å°å®¹é‡ï¼Œå¿…é¡»ä¸º2çš„å¹‚æ¬¡æ–¹
private static final int MIN_INITIAL_CAPACITY = 8;
```

åœ¨ ArrayDeque åº•éƒ¨æ˜¯ä½¿ç”¨**æ•°ç»„**å­˜å‚¨å…ƒç´ ï¼ŒåŒæ—¶è¿˜ä½¿ç”¨äº†**ä¸¤ä¸ªç´¢å¼•**æ¥è¡¨å¾å½“å‰æ•°ç»„çš„çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯ head å’Œ tailã€‚head æ˜¯å¤´éƒ¨å…ƒç´ çš„ç´¢å¼•ï¼Œä½†æ³¨æ„ **tail *ä¸æ˜¯å°¾éƒ¨å…ƒç´ çš„ç´¢å¼•ï¼Œè€Œæ˜¯å°¾éƒ¨å…ƒç´ çš„ä¸‹ä¸€ä½***ï¼Œå³ä¸‹ä¸€ä¸ªå°†è¦è¢«åŠ å…¥çš„å…ƒç´ çš„ç´¢å¼•ã€‚

**åˆå§‹åŒ–**

ArrayDeque æä¾›äº†ä¸‰ä¸ªæ„é€ æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯é»˜è®¤å®¹é‡ï¼ŒæŒ‡å®šå®¹é‡åŠä¾æ®ç»™å®šçš„é›†åˆä¸­çš„å…ƒç´ è¿›è¡Œåˆ›å»ºã€‚é»˜è®¤å®¹é‡ä¸º16ã€‚

```java
public ArrayDeque() {
    elements = new Object[16];
}

public ArrayDeque(int numElements) {
    allocateElements(numElements);
}

public ArrayDeque(Collection<? extends E> c) {
    allocateElements(c.size());
    addAll(c);
}
```

ArrayDeque å¯¹æ•°ç»„çš„å¤§å°(å³é˜Ÿåˆ—çš„å®¹é‡)æœ‰ç‰¹æ®Šçš„è¦æ±‚ï¼Œå¿…é¡»æ˜¯ **2^n**ã€‚é€šè¿‡ `allocateElements`æ–¹æ³•è®¡ç®—åˆå§‹å®¹é‡ï¼š

```java
private void allocateElements(int numElements) {
    int initialCapacity = MIN_INITIAL_CAPACITY;
    // Find the best power of two to hold elements.
    // Tests "<=" because arrays aren't kept full.
    if (numElements >= initialCapacity) {
        initialCapacity = numElements;
        initialCapacity |= (initialCapacity >>>  1);
        initialCapacity |= (initialCapacity >>>  2);
        initialCapacity |= (initialCapacity >>>  4);
        initialCapacity |= (initialCapacity >>>  8);
        initialCapacity |= (initialCapacity >>> 16);
        initialCapacity++;

        if (initialCapacity < 0)   // Too many elements, must back off
            initialCapacity >>>= 1;// Good luck allocating 2 ^ 30 elements
    }
    elements = new Object[initialCapacity];
}
```

`>>>`æ˜¯æ— ç¬¦å·å³ç§»æ“ä½œï¼Œ`|`æ˜¯ä½æˆ–æ“ä½œï¼Œç»è¿‡äº”æ¬¡å³ç§»å’Œä½æˆ–æ“ä½œå¯ä»¥ä¿è¯å¾—åˆ°å¤§å°ä¸º **2^k-1** çš„æ•°ã€‚çœ‹ä¸€ä¸‹è¿™ä¸ªä¾‹å­ï¼š

```java
0 0 0 0 1 ? ? ? ? ?     // n
0 0 0 0 1 1 ? ? ? ?     // n |= n >>> 1;
0 0 0 0 1 1 1 1 ? ?     // n |= n >>> 2;
0 0 0 0 1 1 1 1 1 1     // n |= n >>> 4;
```

åœ¨è¿›è¡Œ 5 æ¬¡ä½ç§»æ“ä½œå’Œä½æˆ–æ“ä½œåå°±å¯ä»¥å¾—åˆ° **2^k-1**ï¼Œæœ€ååŠ 1å³å¯

**æ·»åŠ å…ƒç´ **

å‘æœ«å°¾æ·»åŠ å…ƒç´ ï¼š

```java
public void addLast(E e) {
    if (e == null)
        throw new NullPointerException();
    // tail ä¸­ä¿å­˜çš„æ˜¯å³å°†åŠ å…¥æœ«å°¾çš„å…ƒç´ çš„ç´¢å¼•
    elements[tail] = e;
    // tail å‘åç§»åŠ¨ä¸€ä½
    // æŠŠæ•°ç»„å½“ä½œç¯å½¢çš„ï¼Œè¶Šç•Œååˆ°0ç´¢å¼•
    if ( (tail = (tail + 1) & (elements.length - 1)) == head)
        // tail å’Œ headç›¸é‡ï¼Œç©ºé—´ç”¨å°½ï¼Œéœ€è¦æ‰©å®¹
        doubleCapacity();
}
```

è¿™æ®µä»£ç ä¸­ï¼Œ`(tail = (tail + 1) & (elements.length - 1)) == head`è¿™å¥æœ‰ç‚¹éš¾ä»¥ç†è§£ã€‚å…¶å®ï¼Œåœ¨ ArrayDeque ä¸­æ•°ç»„æ˜¯å½“ä½œ**ç¯å½¢**æ¥ä½¿ç”¨çš„ï¼Œç´¢å¼• 0 çœ‹ä½œæ˜¯ç´§æŒ¨ç€ç´¢å¼• (length-1) ä¹‹åçš„ã€‚å‚è€ƒä¸‹é¢çš„å›¾ç‰‡ï¼ˆtail æŒ‡å‘çš„æ˜¯**ä¸‹ä¸€ä¸ª**å³å°†å­˜æ”¾å…ƒç´ çš„ä½ç½®ï¼‰

![1567335804367](assets/1567335804367.png)

é‚£ä¹ˆä¸ºä»€ä¹ˆ`(tail + 1) & (elements.length - 1)`å°±èƒ½ä¿è¯æŒ‰ç…§ç¯å½¢å–å¾—æ­£ç¡®çš„ä¸‹ä¸€ä¸ªç´¢å¼•å€¼å‘¢ï¼Ÿè¿™å°±å’Œå‰é¢è¯´åˆ°çš„ ArrayDeque å¯¹å®¹é‡çš„**ç‰¹æ®Šè¦æ±‚**æœ‰å…³äº†ã€‚ä¸‹é¢å¯¹å…¶æ­£ç¡®æ€§åŠ ä»¥éªŒè¯ï¼š

```
length = 2^nï¼ŒäºŒè¿›åˆ¶è¡¨ç¤ºä¸º: ç¬¬ n ä½ä¸º1ï¼Œä½ä½ (n-1ä½) å…¨ä¸º0 
length - 1 = 2^n-1ï¼ŒäºŒè¿›åˆ¶è¡¨ç¤ºä¸ºï¼šä½ä½(n-1ä½)å…¨ä¸º1

å¦‚æœ tail + 1 <= length - 1ï¼Œåˆ™ä½ä¸åä½ (n-1) ä½ä¿æŒä¸å˜ï¼Œé«˜ä½å…¨ä¸º0
å¦‚æœ tail + 1 = lengthï¼Œåˆ™ä½ä¸åä½ n å…¨ä¸º0ï¼Œé«˜ä½ä¹Ÿå…¨ä¸º0ï¼Œç»“æœä¸º 0
```

å¯è§ï¼Œåœ¨å®¹é‡ä¿è¯ä¸º **2^n** çš„æƒ…å†µä¸‹ï¼Œä»…ä»…é€šè¿‡**ä½ä¸**æ“ä½œå°±å¯ä»¥å®Œæˆ***ç¯å½¢*ç´¢å¼•**çš„è®¡ç®—ï¼Œè€Œä¸éœ€è¦è¿›è¡Œè¾¹ç•Œçš„åˆ¤æ–­ï¼Œåœ¨å®ç°ä¸Šæ›´ä¸ºé«˜æ•ˆã€‚

å‘å¤´éƒ¨æ·»åŠ å…ƒç´ çš„ä»£ç å¦‚ä¸‹ï¼š

```java
public void addFirst(E e) {
    if (e == null) // ä¸æ”¯æŒå€¼ä¸ºnullçš„å…ƒç´ 
        throw new NullPointerException();
    elements[head = (head - 1) & (elements.length - 1)] = e;
    if (head == tail)
        doubleCapacity();
}
```

å…¶å®ƒçš„è¯¸å¦‚addï¼Œofferï¼ŒofferFirstï¼ŒofferLast ç­‰æ–¹æ³•éƒ½æ˜¯åŸºäºä¸Šé¢è¿™ä¸¤ä¸ªæ–¹æ³•å®ç°çš„ï¼Œä¸å†èµ˜è¿°ã€‚

**æ‰©å®¹**

åœ¨æ¯æ¬¡æ·»åŠ å…ƒç´ åï¼Œå¦‚æœ**å¤´ç´¢å¼•å’Œå°¾éƒ¨ç´¢å¼•**ç›¸é‡ï¼Œåˆ™è¯´æ˜æ•°ç»„ç©ºé—´å·²æ»¡ï¼Œéœ€è¦è¿›è¡Œ**æ‰©å®¹**æ“ä½œã€‚ ArrayDeque æ¯æ¬¡æ‰©å®¹éƒ½ä¼šåœ¨åŸæœ‰çš„å®¹é‡ä¸Š**ç¿»å€**ï¼Œè¿™ä¹Ÿæ˜¯å¯¹å®¹é‡å¿…é¡»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹çš„ä¿è¯ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ‰©å®¹åä¼šå¤åˆ¶å†…å®¹ï¼Œå¤åˆ¶çš„æ—¶å€™ä¼šè¿›è¡Œé‡æ’ï¼Œå°† head æ”¾åœ¨ç¬¬ä¸€ä¸ªã€‚

![1567336287071](assets/1567336287071.png)

```java
private void doubleCapacity() {
    assert head == tail; // æ‰©å®¹æ—¶å¤´éƒ¨ç´¢å¼•å’Œå°¾éƒ¨ç´¢å¼•è‚¯å®šç›¸ç­‰
    int p = head;
    int n = elements.length;
    // å¤´éƒ¨ç´¢å¼•åˆ°æ•°ç»„æœ«ç«¯(length-1å¤„)å…±æœ‰å¤šå°‘å…ƒç´ 
    int r = n - p; // number of elements to the right of p
    // å®¹é‡ç¿»å€
    int newCapacity = n << 1;
    // å®¹é‡è¿‡å¤§ï¼Œæº¢å‡ºäº†
    if (newCapacity < 0)
        throw new IllegalStateException("Sorry, deque too big");
    // åˆ†é…æ–°ç©ºé—´
    Object[] a = new Object[newCapacity];
    // å¤åˆ¶å¤´éƒ¨ç´¢å¼•åˆ°æ•°ç»„æœ«ç«¯çš„å…ƒç´ åˆ°æ–°æ•°ç»„çš„å¤´éƒ¨
    System.arraycopy(elements, p, a, 0, r);
    // å¤åˆ¶å…¶ä½™å…ƒç´ 
    System.arraycopy(elements, 0, a, r, p);
    elements = a;
    // é‡ç½®å¤´å°¾ç´¢å¼•
    head = 0;
    tail = n;
}
```

**ç§»é™¤å…ƒç´ **

ArrayDeque æ”¯æŒä»**å¤´å°¾ä¸¤ç«¯**ç§»é™¤å…ƒç´ ï¼Œremove æ–¹æ³•æ˜¯é€šè¿‡ poll æ¥å®ç°çš„ã€‚å› ä¸ºæ˜¯åŸºäºæ•°ç»„çš„ï¼Œåœ¨äº†è§£äº†ç¯çš„åŸç†åè¿™æ®µä»£ç å°±æ¯”è¾ƒå®¹æ˜“ç†è§£äº†ã€‚

```java
public E pollFirst() {
    int h = head;
    @SuppressWarnings("unchecked")
    E result = (E) elements[h];
    // Element is null if deque empty
    if (result == null)
        return null;
    elements[h] = null;     // Must null out slot
    head = (h + 1) & (elements.length - 1);
    return result;
}

public E pollLast() {
    int t = (tail - 1) & (elements.length - 1);
    @SuppressWarnings("unchecked")
    E result = (E) elements[t];
    if (result == null)
        return null;
    elements[t] = null;
    tail = t;
    return result;
}
```

**è·å–é˜Ÿå¤´å’Œé˜Ÿå°¾çš„å…ƒç´ **

```java
@SuppressWarnings("unchecked")
public E peekFirst() {
    // elements[head] is null if deque empty
    return (E) elements[head];
}

@SuppressWarnings("unchecked")
public E peekLast() {
    return (E) elements[(tail - 1) & (elements.length - 1)];
}
```

**è¿­ä»£å™¨**

ArrayDeque åœ¨è¿­ä»£æ˜¯æ£€æŸ¥å¹¶å‘ä¿®æ”¹**å¹¶æ²¡æœ‰ä½¿ç”¨**ç±»ä¼¼äº ArrayList ç­‰å®¹å™¨ä¸­ä½¿ç”¨çš„ **modCount**ï¼Œè€Œæ˜¯é€šè¿‡**å°¾éƒ¨ç´¢å¼•**æ¥ç¡®å®šçš„ã€‚å…·ä½“å‚è€ƒ next æ–¹æ³•ä¸­çš„æ³¨é‡Šã€‚ä½†æ˜¯è¿™æ ·**ä¸ä¸€å®š**èƒ½ä¿è¯æ£€æµ‹åˆ°æ‰€æœ‰çš„å¹¶å‘ä¿®æ”¹æƒ…å†µï¼ŒåŠ å…¥å…ˆç§»é™¤äº†å°¾éƒ¨å…ƒç´ ï¼Œåˆæ·»åŠ äº†ä¸€ä¸ªå°¾éƒ¨å…ƒç´ ï¼Œè¿™ç§æƒ…å†µä¸‹è¿­ä»£å™¨æ˜¯æ²¡æ³•æ£€æµ‹å‡ºæ¥çš„ã€‚

```java
private class DeqIterator implements Iterator<E> {
    /**
     * Index of element to be returned by subsequent call to next.
     */
    private int cursor = head;

    /**
     * Tail recorded at construction (also in remove), to stop
     * iterator and also to check for comodification.
     */
    private int fence = tail;

    /**
     * Index of element returned by most recent call to next.
     * Reset to -1 if element is deleted by a call to remove.
     */
    private int lastRet = -1;

    public boolean hasNext() {
        return cursor != fence;
    }

    public E next() {
        if (cursor == fence)
            throw new NoSuchElementException();
        @SuppressWarnings("unchecked")
        E result = (E) elements[cursor];
        // This check doesn't catch all possible comodifications,
        // but does catch the ones that corrupt traversal
        // å¦‚æœç§»é™¤äº†å°¾éƒ¨å…ƒç´ ï¼Œä¼šå¯¼è‡´tail != fence
        // å¦‚æœç§»é™¤äº†å¤´éƒ¨å…ƒç´ ï¼Œä¼šå¯¼è‡´ result == null
        if (tail != fence || result == null)
            throw new ConcurrentModificationException();
        lastRet = cursor;
        cursor = (cursor + 1) & (elements.length - 1);
        return result;
    }

    public void remove() {
        if (lastRet < 0)
            throw new IllegalStateException();
        if (delete(lastRet)) { // if left-shifted, undo increment in next()
            cursor = (cursor - 1) & (elements.length - 1);
            fence = tail;
        }
        lastRet = -1;
    }

    public void forEachRemaining(Consumer<? super E> action) {
        Objects.requireNonNull(action);
        Object[] a = elements;
        int m = a.length - 1, f = fence, i = cursor;
        cursor = f;
        while (i != f) {
            @SuppressWarnings("unchecked") E e = (E)a[i];
            i = (i + 1) & m;
            if (e == null)
                throw new ConcurrentModificationException();
            action.accept(e);
        }
    }
}
```









### PriorityQueue

#### æ¦‚è¿°

- ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ŒåŸºäºå †å®ç°ã€‚
- å †æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œ**æ¦‚å¿µä¸Šæ˜¯==æ ‘==ï¼Œå­˜å‚¨ä¸Šæ˜¯==æ•°ç»„==**ï¼Œçˆ¶å­æœ‰ç‰¹æ®Šé¡ºåºï¼Œæ ¹æ˜¯æœ€å¤§/æœ€å°å€¼ï¼Œæ„å»ºã€æ·»åŠ ã€åˆ é™¤æ•ˆç‡éƒ½å¾ˆé«˜ã€‚
- å®ç°äº†é˜Ÿåˆ—æ¥å£ Queueï¼Œæ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¼˜å…ˆçº§ï¼Œ**é˜Ÿå¤´**çš„å…ƒç´ æ°¸è¿œéƒ½æ˜¯**ä¼˜å…ˆçº§æœ€é«˜**çš„ã€‚
- å†…éƒ¨å…ƒç´ **ä¸æ˜¯å®Œå…¨æœ‰åº**ï¼Œä½†æ˜¯**é€ä¸ª**å‡ºé˜Ÿåˆ—ä¼šå¾—åˆ°**å®Œå…¨æœ‰åº**çš„è¾“å‡ºã€‚
- æœ€å…ˆå‡ºé˜Ÿçš„æ€»æ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„ï¼Œå³æ’åºä¸­çš„ç¬¬ä¸€ä¸ªã€‚
- æŸ¥çœ‹å¤´éƒ¨å…ƒç´ æ•ˆç‡å¾ˆé«˜ï¼Œä¸ºO(1)ï¼Œ å…¥é˜Ÿã€å‡ºé˜Ÿæ•ˆç‡æ¯”è¾ƒé«˜ï¼Œä¸ºO(log2(N))ï¼Œæ„å»ºå † heapify çš„æ•ˆç‡ä¸º O(N)ã€‚



#### åº”ç”¨å®ä¾‹

##### TopKé—®é¢˜

ç”¨ PriorityQueue é»˜è®¤æ˜¯è‡ªç„¶é¡ºåºæ’åºï¼Œ**è¦é€‰æ‹©æœ€å¤§çš„kä¸ªæ•°ï¼Œæ„é€ æœ€å°å †**ï¼Œæ¯æ¬¡å–æ•°ç»„ä¸­å‰©ä½™æ•°ä¸å †é¡¶çš„å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ–°æ•°æ¯”å †é¡¶å…ƒç´ å¤§ï¼Œåˆ™åˆ é™¤å †é¡¶å…ƒç´ ï¼Œå¹¶æ·»åŠ è¿™ä¸ªæ–°æ•°åˆ°å †ä¸­ã€‚å¯ç”¨äºå…ƒç´ ä¸ªæ•°ä¸ç¡®å®šè¿˜éœ€è¦å®æ—¶**åŠ¨æ€æ·»åŠ **çš„é—®é¢˜ã€‚ä¹Ÿå¯ä»¥æ±‚**ç¬¬ K ä¸ª**å…ƒç´ ã€‚

Javaä¸­çš„PriorityQueueæ¥å®ç°å †ï¼Œç”¨PriorityQueueçš„å®ç°çš„ä»£ç å¦‚ä¸‹ï¼š

```java
public class findTopK {
    // æ‰¾å‡ºå‰kä¸ªæœ€å¤§æ•°ï¼Œé‡‡ç”¨å°é¡¶å †å®ç°
    public static int[] findKMax(int[] nums, int k) {
        // é˜Ÿåˆ—é»˜è®¤è‡ªç„¶é¡ºåºæ’åˆ—ï¼Œå°é¡¶å †ï¼Œä¸å¿…é‡å†™compare
        PriorityQueue<Integer> pq = new PriorityQueue<>(k);

        for (int num : nums) {
            if (pq.size() < k) {
                pq.offer(num);
            } else if (pq.peek() < num) { // å¦‚æœå †é¡¶å…ƒç´  < æ–°æ•°ï¼Œåˆ™åˆ é™¤å †é¡¶ï¼ŒåŠ å…¥æ–°æ•°å…¥å †
                pq.poll();
                pq.offer(num);
            }
        }

        int[] result = new int[k];
        for (int i = 0; i < k && !pq.isEmpty(); i++) {
            result[i] = pq.poll();
        }
        return result;
    }

    public static void main(String[] args) {
        int[]arr=new int[]{1, 6, 2, 3, 5, 4, 8, 7, 9};
        System.out.println(Arrays.toString(findKMax(arr,5)));
    }
}
/**
* è¾“å‡ºï¼š[5, 6, 7, 8, 9]
*/
```



##### æ±‚ä¸­å€¼

æ±‚ä¸­å€¼çš„ä¸€ä¸ªåŸºæœ¬æ€è·¯æ˜¯æ’åºï¼Œæ’åºä¹‹åæ‰¾åˆ°ä¸­é—´å€¼ã€‚å¦‚æœå…ƒç´ ä¼šåŠ¨æ€æ·»åŠ ï¼Œå°±å¯ä»¥ä½¿ç”¨å †ã€‚ç»´æŠ¤ä¸¤ä¸ªå †ï¼Œä¸€ä¸ªæœ€å¤§å †ï¼Œä¸€ä¸ªæœ€å°å †ã€‚

æ€è·¯å¦‚ä¸‹ï¼š

- è®¾å½“å‰ä¸­ä½æ•°ä¸º m, æœ€å¤§å †ç»´æŠ¤çš„æ˜¯ â‰¤ m çš„å…ƒç´ ï¼Œæœ€å°å †ç»´æŠ¤çš„æ˜¯ â‰¥ m çš„å…ƒç´ ï¼Œä½†ä¸¤ä¸ªå †éƒ½ä¸åŒ…å« mã€‚
- å½“æ–°å…ƒç´ åˆ°è¾¾æ—¶ï¼Œå°†æ–°å…ƒç´ ä¸ m è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥æ–°å…ƒç´  â‰¤ mï¼Œ åˆ™å°†å…¶åŠ å…¥æœ€å¤§å †ï¼Œå¦åˆ™åŠ å…¥æœ€å°å †ã€‚
- ç¬¬äºŒæ­¥åï¼Œå¦‚æœæ­¤æ—¶æœ€å°å †ä¸æœ€å¤§å †çš„å…ƒç´ ä¸ªæ•°å·®å€¼ â‰¥ 2ï¼Œåˆ™å°† m åŠ å…¥å…ƒç´ ä¸ªæ•°å°‘çš„å †ä¸­ï¼Œç„¶åä»å…ƒç´ ä¸ªæ•°å¤šçš„å †ä¸­å°†æ ¹èŠ‚ç‚¹ç§»é™¤å¹¶å¹…å€¼ç»™ m å³å¯ã€‚

```java
import java.util.Collection;
import java.util.Collections;
import java.util.PriorityQueue;

public class Midian<E> {
    private PriorityQueue<E> minP;
    private PriorityQueue<E> maxP;
	// ä¸­å€¼
    private E m;
    public Midian(){
        this.minP = new PriorityQueue<>();
        this.maxP = new PriorityQueue<>(11,Collections.<E>reverseOrder());
    }

    private int compare(E e , E m){
        Comparable<? super E>  cmpr = (Comparable<? super E>) e;
        return cmpr.compareTo(m);
    }

    public void add(E e){
		// ç¬¬ä¸€ä¸ªå…ƒç´ 
        if (m == null){
            m = e;
            return;
        }
		// å°äºä¸­å€¼åŠ å…¥æœ€å¤§å †
        if (compare(e , m) <= 0){
            maxP.add(e);
        }else {
            minP.add(e);
        }

        if (minP.size() - maxP.size() >=2){
			// æœ€å°å †å…ƒç´ ä¸ªæ•°å¤šï¼Œå°†måŠ å…¥æœ€å¤§å †ä¸­ï¼Œç„¶åæœ€å°å †ä¸­æ ¹ç§»é™¤èµ‹å€¼ç»™m
            maxP.add(this.m);
            this.m = minP.poll();
        }else if (maxP.size() - minP.size() >= 2){
            minP.add(this.m);
            this.m = maxP.poll();
        }
    }

    public void addAll(Collection<? extends E> c){
        for(E e:c){
            add(e);
        }
    }

    public E getM(){
        return m;
    }
}

public static void main(String[] args) {
    Midian<Integer> integerMidian = new Midian<>();
    List<Integer> list = Arrays.asList(new Integer[] {1,2,3,4,5,6,7,8,9,10});
    integerMidian.addAll(list);
    System.out.println(integerMidian.getM());
}
```







## å››ã€Mapä¸Set

### â€» HashMap

#### æ¦‚è¿°

- é”®ä¸èƒ½é‡å¤ï¼Œé‡å¤å°±ä¼šè¦†ç›–å€¼ã€‚



ä¸ºäº†ä¾¿äºç†è§£ï¼Œä»¥ä¸‹æºç åˆ†æä»¥ JDK 1.7 ä¸ºä¸»ã€‚

#### 1. å­˜å‚¨ç»“æ„

å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª **Entry ç±»å‹**çš„æ•°ç»„ tableã€‚

```java
transient Entry[] table;
```

Entry å­˜å‚¨ç€**é”®å€¼å¯¹**ã€‚å®ƒåŒ…å«äº†å››ä¸ªå­—æ®µï¼Œä» next å­—æ®µæˆ‘ä»¬å¯ä»¥çœ‹å‡º Entry æ˜¯ä¸€ä¸ª**é“¾è¡¨**ã€‚å³æ•°ç»„ä¸­çš„æ¯ä¸ªä½ç½®è¢«å½“æˆä¸€ä¸ª**æ¡¶**ï¼Œä¸€ä¸ªæ¡¶å­˜æ”¾ä¸€ä¸ª**é“¾è¡¨**ã€‚HashMap ä½¿ç”¨**æ‹‰é“¾æ³•**æ¥è§£å†³å†²çªï¼ŒåŒä¸€ä¸ªé“¾è¡¨ä¸­å­˜æ”¾å“ˆå¸Œå€¼ç›¸åŒçš„ Entryã€‚

![1563604844175](assets/1563604844175.png)

![1567483909960](assets/1567483909960.png)

```java
static class Entry<K,V> implements Map.Entry<K,V> {
    final K key;
    V value;
    Entry<K,V> next;
    int hash;

    Entry(int h, K k, V v, Entry<K,V> n) {
        value = v;
        next = n;
        key = k;
        hash = h;
    }

    public final K getKey() {
        return key;
    }

    public final V getValue() {
        return value;
    }

    public final V setValue(V newValue) {
        V oldValue = value;
        value = newValue;
        return oldValue;
    }

    public final boolean equals(Object o) {
        if (!(o instanceof Map.Entry))
            return false;
        Map.Entry e = (Map.Entry)o;
        Object k1 = getKey();
        Object k2 = e.getKey();
        if (k1 == k2 || (k1 != null && k1.equals(k2))) {
            Object v1 = getValue();
            Object v2 = e.getValue();
            if (v1 == v2 || (v1 != null && v1.equals(v2)))
                return true;
        }
        return false;
    }

    public final int hashCode() {
        return Objects.hashCode(getKey()) ^ Objects.hashCode(getValue());
    }

    public final String toString() {
        return getKey() + "=" + getValue();
    }
}
```

#### 2. æ‹‰é“¾æ³•çš„å·¥ä½œåŸç†

```java
HashMap<String, String> map = new HashMap<>();
map.put("K1", "V1");
map.put("K2", "V2");
map.put("K3", "V3");
```

- æ–°å»ºä¸€ä¸ª HashMapï¼Œé»˜è®¤å¤§å°ä¸º 16ï¼›
- æ’å…¥ &lt;K1,V1> é”®å€¼å¯¹ï¼Œå…ˆè®¡ç®— K1 çš„ hashCode ä¸º 115ï¼Œä½¿ç”¨é™¤ç•™ä½™æ•°æ³•å¾—åˆ°æ‰€åœ¨çš„**æ¡¶ä¸‹æ ‡** 115%16 = 3ã€‚
- æ’å…¥ &lt;K2,V2> é”®å€¼å¯¹ï¼Œå…ˆè®¡ç®— K2 çš„ hashCode ä¸º 118ï¼Œä½¿ç”¨é™¤ç•™ä½™æ•°æ³•å¾—åˆ°æ‰€åœ¨çš„æ¡¶ä¸‹æ ‡ 118%16 = 6ã€‚
- æ’å…¥ &lt;K3,V3> é”®å€¼å¯¹ï¼Œå…ˆè®¡ç®— K3 çš„ hashCode ä¸º 118ï¼Œä½¿ç”¨é™¤ç•™ä½™æ•°æ³•å¾—åˆ°æ‰€åœ¨çš„æ¡¶ä¸‹æ ‡ 118%16 = 6ï¼Œæ’åœ¨ &lt;K2,V2> å‰é¢ã€‚

åº”è¯¥æ³¨æ„åˆ°é“¾è¡¨çš„æ’å…¥æ˜¯ä»¥==å¤´æ’æ³•æ–¹å¼==è¿›è¡Œçš„ï¼Œä¾‹å¦‚ä¸Šé¢çš„ &lt;K3,V3> ä¸æ˜¯æ’åœ¨ &lt;K2,V2> åé¢ï¼Œè€Œæ˜¯æ’å…¥åœ¨**é“¾è¡¨å¤´éƒ¨**ã€‚

**æŸ¥æ‰¾**éœ€è¦åˆ†æˆä¸¤æ­¥è¿›è¡Œï¼š

- è®¡ç®—é”®å€¼å¯¹æ‰€åœ¨çš„**æ¡¶**ï¼›
- åœ¨é“¾è¡¨ä¸Šé¡ºåºæŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¾ç„¶å’Œé“¾è¡¨çš„é•¿åº¦æˆæ­£æ¯”ã€‚

![1563604859596](assets/1563604859596.png)

#### 3. put æ“ä½œ

```java
public V put(K key, V value) {
    if (table == EMPTY_TABLE) {
        inflateTable(threshold);
    }
    // é”®ä¸º null å•ç‹¬å¤„ç†
    if (key == null)
        return putForNullKey(value);
    int hash = hash(key);
    // ç¡®å®šæ¡¶ä¸‹æ ‡
    int i = indexFor(hash, table.length);
    // å…ˆæ‰¾å‡ºæ˜¯å¦å·²ç»å­˜åœ¨é”®ä¸º key çš„é”®å€¼å¯¹ï¼Œå¦‚æœå­˜åœ¨çš„è¯å°±æ›´æ–°è¿™ä¸ªé”®å€¼å¯¹çš„å€¼ä¸º value
    for (Entry<K,V> e = table[i]; e != null; e = e.next) {
        Object k;
        if (e.hash == hash && ((k = e.key) == key || key.equals(k))) {
            V oldValue = e.value;
            e.value = value;
            e.recordAccess(this);
            return oldValue;
        }
    }
    modCount++; 	// è®°å½•ç»“æ„å˜åŒ–
    // æ’å…¥æ–°é”®å€¼å¯¹
    addEntry(hash, key, value, i);
    return null;
}
```

HashMap **å…è®¸**æ’å…¥é”®ä¸º **null** çš„é”®å€¼å¯¹ã€‚ä½†æ˜¯å› ä¸ºæ— æ³•è°ƒç”¨ null çš„ hashCode() æ–¹æ³•ï¼Œä¹Ÿå°±æ— æ³•ç¡®å®šè¯¥é”®å€¼å¯¹çš„æ¡¶ä¸‹æ ‡ï¼Œåªèƒ½é€šè¿‡å¼ºåˆ¶æŒ‡å®šä¸€ä¸ªæ¡¶ä¸‹æ ‡æ¥å­˜æ”¾ã€‚HashMap ä½¿ç”¨**ç¬¬0 ä¸ªæ¡¶å­˜æ”¾é”®ä¸º null çš„é”®å€¼å¯¹**ã€‚

```java
private V putForNullKey(V value) {
    for (Entry<K,V> e = table[0]; e != null; e = e.next) {
        if (e.key == null) {
            V oldValue = e.value;
            e.value = value;
            e.recordAccess(this);
            return oldValue;
        }
    }
    modCount++;
    addEntry(0, null, value, 0);
    return null;
}
```

ä½¿ç”¨é“¾è¡¨çš„å¤´æ’æ³•ï¼Œä¹Ÿå°±æ˜¯æ–°çš„é”®å€¼å¯¹æ’åœ¨é“¾è¡¨çš„**å¤´éƒ¨**ï¼Œè€Œä¸æ˜¯é“¾è¡¨çš„å°¾éƒ¨ã€‚

```java
void addEntry(int hash, K key, V value, int bucketIndex) {
    if ((size >= threshold) && (null != table[bucketIndex])) {
        resize(2 * table.length);
        hash = (null != key) ? hash(key) : 0;
        bucketIndex = indexFor(hash, table.length);
    }

    createEntry(hash, key, value, bucketIndex);
}

void createEntry(int hash, K key, V value, int bucketIndex) {
    Entry<K,V> e = table[bucketIndex];
    // å¤´æ’æ³•ï¼Œé“¾è¡¨å¤´éƒ¨æŒ‡å‘æ–°çš„é”®å€¼å¯¹
    table[bucketIndex] = new Entry<>(hash, key, value, e);
    size++;
}
```

```java
Entry(int h, K k, V v, Entry<K,V> n) {
    value = v;
    next = n;
    key = k;
    hash = h;
}
```

#### 4. ç¡®å®šæ¡¶ä¸‹æ ‡

å¾ˆå¤šæ“ä½œéƒ½éœ€è¦å…ˆç¡®å®šä¸€ä¸ªé”®å€¼å¯¹æ‰€åœ¨çš„**æ¡¶ä¸‹æ ‡**ã€‚

```java
int hash = hash(key);
int i = indexFor(hash, table.length);
```

##### 4.1 è®¡ç®— hash å€¼

```java
final int hash(Object k) {
    int h = hashSeed;
    if (0 != h && k instanceof String) {
        return sun.misc.Hashing.stringHash32((String) k);
    }

    h ^= k.hashCode();

    // This function ensures that hashCodes that differ only by
    // constant multiples at each bit position have a bounded
    // number of collisions (approximately 8 at default load factor).
    h ^= (h >>> 20) ^ (h >>> 12);
    return h ^ (h >>> 7) ^ (h >>> 4);
}
```

```java
public final int hashCode() {
    return Objects.hashCode(key) ^ Objects.hashCode(value);
}
```

##### 4.2 å–æ¨¡ 

ä»¤ x = 1<<4ï¼Œå³ x ä¸º 2 çš„ 4 æ¬¡æ–¹ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹æ€§è´¨ï¼š

```
x   : 00010000
x-1 : 00001111
```

ä»¤ä¸€ä¸ªæ•° y ä¸ x-1 åšä¸è¿ç®—ï¼Œå¯ä»¥å»é™¤ y ä½çº§è¡¨ç¤ºçš„ç¬¬ 4 ä½ä»¥ä¸Šæ•°ï¼š

```
y       : 10110010
x-1     : 00001111
y&(x-1) : 00000010
```

è¿™ä¸ªæ€§è´¨å’Œ y å¯¹ x å–æ¨¡æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼š

```
y   : 10110010
x   : 00010000
y%x : 00000010
```

æˆ‘ä»¬çŸ¥é“ï¼Œä½è¿ç®—çš„ä»£ä»·æ¯”æ±‚æ¨¡è¿ç®—å°çš„å¤šï¼Œå› æ­¤åœ¨è¿›è¡Œè¿™ç§è®¡ç®—æ—¶ç”¨**ä½è¿ç®—**çš„è¯èƒ½å¸¦æ¥æ›´é«˜çš„æ€§èƒ½ã€‚

ç¡®å®šæ¡¶ä¸‹æ ‡çš„æœ€åä¸€æ­¥æ˜¯å°† key çš„ hash å€¼å¯¹æ¡¶ä¸ªæ•°å–æ¨¡ï¼šhash % capacityï¼Œå¦‚æœèƒ½ä¿è¯ **capacity ä¸º 2 çš„ n æ¬¡æ–¹**ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†è¿™ä¸ªæ“ä½œè½¬æ¢ä¸º**ä½è¿ç®—**ã€‚

```java
static int indexFor(int h, int length) {
    return h & (length - 1);
}
```

#### 5. æ‰©å®¹-åŸºæœ¬åŸç†

è®¾ HashMap çš„ table é•¿åº¦ä¸º Mï¼Œéœ€è¦å­˜å‚¨çš„é”®å€¼å¯¹æ•°é‡ä¸º Nï¼Œå¦‚æœå“ˆå¸Œå‡½æ•°æ»¡è¶³å‡åŒ€æ€§çš„è¦æ±‚ï¼Œé‚£ä¹ˆæ¯æ¡é“¾è¡¨çš„**é•¿åº¦**å¤§çº¦ä¸º **N/M**ï¼Œå› æ­¤å¹³å‡æŸ¥æ‰¾æ¬¡æ•°çš„å¤æ‚åº¦ä¸º **O(N/M)**ã€‚

ä¸ºäº†è®©æŸ¥æ‰¾çš„æˆæœ¬é™ä½ï¼Œåº”è¯¥å°½å¯èƒ½ä½¿å¾— N/M å°½å¯èƒ½å°ï¼Œå› æ­¤éœ€è¦ä¿è¯ M å°½å¯èƒ½å¤§ï¼Œä¹Ÿå°±æ˜¯è¯´ table è¦å°½å¯èƒ½å¤§ã€‚HashMap é‡‡ç”¨åŠ¨æ€æ‰©å®¹æ¥æ ¹æ®å½“å‰çš„ N å€¼æ¥è°ƒæ•´ M å€¼ï¼Œä½¿å¾—ç©ºé—´æ•ˆç‡å’Œæ—¶é—´æ•ˆç‡éƒ½èƒ½å¾—åˆ°ä¿è¯ã€‚

å’Œæ‰©å®¹ç›¸å…³çš„å‚æ•°ä¸»è¦æœ‰ï¼šcapacityã€sizeã€threshold å’Œ load_factorã€‚

|    å‚æ•°    | å«ä¹‰                                                         |
| :--------: | :----------------------------------------------------------- |
|  capacity  | table çš„å®¹é‡å¤§å°ï¼Œé»˜è®¤ä¸º 16ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ capacity å¿…é¡»ä¿è¯ä¸º **2 çš„ n æ¬¡æ–¹**ã€‚ |
|    size    | é”®å€¼å¯¹æ•°é‡ã€‚                                                 |
| threshold  | size çš„**ä¸´ç•Œå€¼**ï¼Œå½“ size å¤§äºç­‰äº threshold å°±å¿…é¡»è¿›è¡Œæ‰©å®¹æ“ä½œã€‚ |
| loadFactor | **è£…è½½å› **å­ï¼Œtable èƒ½å¤Ÿä½¿ç”¨çš„æ¯”ä¾‹ï¼Œthreshold = capacity * loadFactorã€‚ |

```java
// é»˜è®¤åˆå§‹å®¹é‡
static final int DEFAULT_INITIAL_CAPACITY = 16;

static final int MAXIMUM_CAPACITY = 1 << 30;
// é»˜è®¤è£…è½½å› å­
static final float DEFAULT_LOAD_FACTOR = 0.75f;

transient Entry[] table;

transient int size;

int threshold;

final float loadFactor;

transient int modCount;
```

ä»ä¸‹é¢çš„æ·»åŠ å…ƒç´ ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œå½“éœ€è¦æ‰©å®¹æ—¶ï¼Œä»¤ capacity ä¸ºåŸæ¥çš„**ä¸¤å€**ã€‚

```java
void addEntry(int hash, K key, V value, int bucketIndex) {
    Entry<K,V> e = table[bucketIndex];
    table[bucketIndex] = new Entry<>(hash, key, value, e);
    if (size++ >= threshold)
        resize(2 * table.length);
}
```

æ‰©å®¹ä½¿ç”¨ resize() å®ç°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**æ‰©å®¹**æ“ä½œåŒæ ·éœ€è¦æŠŠ oldTable çš„æ‰€æœ‰é”®å€¼å¯¹**é‡æ–°æ’å…¥ newTable** ä¸­ï¼Œå› æ­¤è¿™ä¸€æ­¥æ˜¯å¾ˆ**è´¹æ—¶**çš„ã€‚

```java
void resize(int newCapacity) {
    Entry[] oldTable = table;
    int oldCapacity = oldTable.length;
    if (oldCapacity == MAXIMUM_CAPACITY) {
        threshold = Integer.MAX_VALUE;
        return;
    }
    Entry[] newTable = new Entry[newCapacity];
    transfer(newTable);
    table = newTable;
    threshold = (int)(newCapacity * loadFactor);
}

void transfer(Entry[] newTable) {
    Entry[] src = table;
    int newCapacity = newTable.length;
    for (int j = 0; j < src.length; j++) {
        Entry<K,V> e = src[j];
        if (e != null) {
            src[j] = null;
            do {
                Entry<K,V> next = e.next;
                int i = indexFor(e.hash, newCapacity);
                e.next = newTable[i];
                newTable[i] = e;
                e = next;
            } while (e != null);
        }
    }
}
```

#### 6. æ‰©å®¹-é‡æ–°è®¡ç®—æ¡¶ä¸‹æ ‡

åœ¨è¿›è¡Œæ‰©å®¹æ—¶ï¼Œéœ€è¦æŠŠé”®å€¼å¯¹**é‡æ–°**æ”¾åˆ°å¯¹åº”çš„æ¡¶ä¸Šã€‚HashMap ä½¿ç”¨äº†ä¸€ä¸ªç‰¹æ®Šçš„æœºåˆ¶ï¼Œå¯ä»¥é™ä½é‡æ–°è®¡ç®—æ¡¶ä¸‹æ ‡çš„æ“ä½œã€‚

å‡è®¾åŸæ•°ç»„é•¿åº¦ capacity ä¸º 16ï¼Œæ‰©å®¹ä¹‹å new capacity ä¸º 32ï¼š

```html
capacity     : 00010000
new capacity : 00100000
```

å¯¹äºä¸€ä¸ª **Key**ï¼Œ

- å®ƒçš„å“ˆå¸Œå€¼å¦‚æœåœ¨**ç¬¬ 5 ä½ä¸Šä¸º 0**ï¼Œé‚£ä¹ˆå–æ¨¡å¾—åˆ°çš„ç»“æœå’Œä¹‹å‰**ä¸€æ ·**ï¼›
- å¦‚æœä¸º **1**ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æœä¸ºåŸæ¥çš„**ç»“æœ +16**ã€‚

#### 7. è®¡ç®—æ•°ç»„å®¹é‡

HashMap æ„é€ å‡½æ•°å…è®¸ç”¨æˆ·ä¼ å…¥çš„å®¹é‡ä¸æ˜¯ 2 çš„ n æ¬¡æ–¹ï¼Œå› ä¸ºå®ƒå¯ä»¥**è‡ªåŠ¨åœ°**å°†ä¼ å…¥çš„å®¹é‡è½¬æ¢ä¸º 2 çš„ n æ¬¡æ–¹ã€‚

å…ˆè€ƒè™‘å¦‚ä½•æ±‚ä¸€ä¸ªæ•°çš„æ©ç ï¼Œå¯¹äº 10010000ï¼Œå®ƒçš„æ©ç ä¸º 11111111ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•å¾—åˆ°ï¼š

```
mask |= mask >> 1    11011000
mask |= mask >> 2    11111110
mask |= mask >> 4    11111111
```

mask + 1 æ˜¯å¤§äºåŸå§‹æ•°å­—çš„æœ€å°çš„ 2 çš„ n æ¬¡æ–¹ã€‚

```
num     10010000
mask+1 100000000
```

ä»¥ä¸‹æ˜¯ HashMap ä¸­è®¡ç®—æ•°ç»„å®¹é‡çš„ä»£ç ï¼Œè‡ªåŠ¨è½¬ä¸º2 çš„æ•´æ•°æ¬¡æ–¹ï¼š

```java
static final int tableSizeFor(int cap) {
    int n = cap - 1;
    n |= n >>> 1;
    n |= n >>> 2;
    n |= n >>> 4;
    n |= n >>> 8;
    n |= n >>> 16;
    return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;
}
```

#### 8. é“¾è¡¨è½¬çº¢é»‘æ ‘

ä» JDK 1.8 å¼€å§‹ï¼Œä¸€ä¸ªæ¡¶å­˜å‚¨çš„**é“¾è¡¨é•¿åº¦å¤§äº 8** æ—¶ä¼šå°†é“¾è¡¨è½¬æ¢ä¸º**çº¢é»‘æ ‘**ã€‚

#### 9. ä¸ HashTable çš„æ¯”è¾ƒ

- HashTable ä½¿ç”¨ **synchronized** æ¥è¿›è¡ŒåŒæ­¥ã€‚
- HashMap å¯ä»¥æ’å…¥é”®ä¸º null çš„ Entryã€‚
- HashMap çš„è¿­ä»£å™¨æ˜¯ fail-fast è¿­ä»£å™¨ã€‚
- HashMap ä¸èƒ½ä¿è¯éšç€æ—¶é—´çš„æ¨ç§» Map ä¸­çš„å…ƒç´ æ¬¡åºæ˜¯ä¸å˜çš„ã€‚



#### HashMapç›¸å…³é¢è¯•é¢˜

**Qï¼šHashMap çš„æ•°æ®ç»“æ„ï¼Ÿ**

Aï¼š**å“ˆå¸Œè¡¨ç»“æ„ï¼ˆé“¾è¡¨æ•£åˆ—ï¼šæ•°ç»„+é“¾è¡¨ï¼‰**å®ç°ï¼Œç»“åˆæ•°ç»„å’Œé“¾è¡¨çš„ä¼˜ç‚¹ã€‚å½“é“¾è¡¨é•¿åº¦è¶…è¿‡ **8** æ—¶ï¼Œé“¾è¡¨è½¬æ¢ä¸º**çº¢é»‘æ ‘**ã€‚
transient Node<K,V>[] table;

![1567084676248](assets/1567084676248.png)

**Qï¼šHashMap çš„å·¥ä½œåŸç†ï¼Ÿ**

Aï¼šHashMap åº•å±‚æ˜¯ **hash æ•°ç»„**å’Œ**å•å‘é“¾è¡¨**å®ç°ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯**é“¾è¡¨**ï¼Œç”± **Node å†…éƒ¨ç±»ï¼ˆå®ç° Map.Entry<K,V>æ¥å£ï¼‰**å®ç°ï¼ŒHashMap é€šè¿‡ put & get æ–¹æ³•å­˜å‚¨å’Œè·å–ã€‚

**å­˜å‚¨å¯¹è±¡**æ—¶ï¼Œå°† K/V é”®å€¼ä¼ ç»™ put() æ–¹æ³•ï¼š1ã€è°ƒç”¨ hash(K) æ–¹æ³•**è®¡ç®— K çš„ hash å€¼**ï¼Œç„¶åç»“åˆæ•°ç»„é•¿åº¦ï¼Œè®¡ç®—å¾—æ•°ç»„ä¸‹æ ‡ï¼›2ã€**è°ƒæ•´æ•°ç»„å¤§å°**ï¼ˆå½“å®¹å™¨ä¸­çš„å…ƒç´ ä¸ªæ•°å¤§äº capacity * loadfactor æ—¶ï¼Œå®¹å™¨ä¼šè¿›è¡Œæ‰©å®¹resize ä¸º 2nï¼‰ï¼›3ã€â‘ .å¦‚æœ **K çš„ hash å€¼**åœ¨ HashMap ä¸­**ä¸å­˜åœ¨**ï¼Œåˆ™æ‰§è¡Œ**æ’å…¥**ï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™å‘ç”Ÿ**ç¢°æ’**ï¼›
 â‘¡.å¦‚æœ K çš„ hash å€¼åœ¨ HashMap ä¸­**å­˜åœ¨**ï¼Œä¸”å®ƒä»¬ä¸¤è€… **equals è¿”å› true**ï¼Œåˆ™**æ›´æ–°é”®å€¼å¯¹**ï¼›
 â‘¢. å¦‚æœ K çš„ hash å€¼åœ¨ HashMap ä¸­**å­˜åœ¨**ï¼Œä¸”å®ƒä»¬ä¸¤è€… **equals è¿”å› false**ï¼Œåˆ™**æ’å…¥é“¾è¡¨çš„å°¾éƒ¨ï¼ˆå°¾æ’æ³•ï¼‰æˆ–è€…çº¢é»‘æ ‘ä¸­ï¼ˆæ ‘çš„æ·»åŠ æ–¹å¼ï¼‰**ã€‚

ï¼ˆ**JDK 1.7** ä¹‹å‰ä½¿ç”¨**å¤´æ’æ³•**ã€**JDK 1.8** ä½¿ç”¨**å°¾æ’æ³•**ï¼‰
 ï¼ˆæ³¨æ„ï¼šå½“ç¢°æ’å¯¼è‡´é“¾è¡¨å¤§äº TREEIFY_THRESHOLD =  8 æ—¶ï¼Œå°±æŠŠé“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘ï¼‰

**è·å–å¯¹è±¡**æ—¶ï¼Œå°† K ä¼ ç»™ get() æ–¹æ³•ï¼šâ‘ ã€è°ƒç”¨ hash(K) æ–¹æ³•ï¼ˆ**è®¡ç®— K çš„ hash å€¼**ï¼‰ä»è€Œ**è·å–è¯¥é”®å€¼æ‰€åœ¨é“¾è¡¨çš„æ•°ç»„ä¸‹æ ‡**ï¼›â‘¡ã€é¡ºåºéå†é“¾è¡¨ï¼Œequals()æ–¹æ³•æŸ¥æ‰¾**ç›¸åŒ Node é“¾è¡¨ä¸­ K å€¼**å¯¹åº”çš„ V å€¼ã€‚

hashCode æ˜¯å®šä½çš„ï¼Œ**å­˜å‚¨ä½ç½®**ï¼›equalsæ˜¯å®šæ€§çš„ï¼Œ**æ¯”è¾ƒä¸¤è€…æ˜¯å¦ç›¸ç­‰**ã€‚

**Qï¼šå½“ä¸¤ä¸ªå¯¹è±¡çš„ hashCode ç›¸åŒä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**

Aï¼šå› ä¸º hashCode ç›¸åŒï¼Œä¸ä¸€å®šå°±æ˜¯ç›¸ç­‰çš„ï¼ˆequalsæ–¹æ³•æ¯”è¾ƒï¼‰ï¼Œæ‰€ä»¥ä¸¤ä¸ªå¯¹è±¡æ‰€åœ¨æ•°ç»„çš„ä¸‹æ ‡ç›¸åŒï¼Œ**"ç¢°æ’"**å°±æ­¤å‘ç”Ÿã€‚åˆå› ä¸º HashMap ä½¿ç”¨é“¾è¡¨å­˜å‚¨å¯¹è±¡ï¼Œè¿™ä¸ª Node ä¼šå­˜å‚¨åˆ°é“¾è¡¨ä¸­ã€‚

**Qï¼šä½ çŸ¥é“ hash çš„å®ç°å—ï¼Ÿä¸ºä»€ä¹ˆè¦è¿™æ ·å®ç°ï¼Ÿ**

Aï¼šJDK 1.8 ä¸­ï¼Œæ˜¯é€šè¿‡ hashCode() çš„**é«˜ 16 ä½å¼‚æˆ–ä½ 16 ä½**å®ç°çš„ï¼š(h = k.hashCode()) ^ (h >>> 16)ï¼Œä¸»è¦æ˜¯ä»é€Ÿåº¦ï¼ŒåŠŸæ•ˆå’Œè´¨é‡æ¥è€ƒè™‘çš„ï¼Œ**å‡å°‘ç³»ç»Ÿçš„å¼€é”€**ï¼Œä¹Ÿä¸ä¼šé€ æˆ**å› ä¸ºé«˜ä½æ²¡æœ‰å‚ä¸**ä¸‹æ ‡çš„è®¡ç®—ï¼Œä»è€Œå¼•èµ·çš„**ç¢°æ’**ã€‚

**Qï¼šä¸ºä»€ä¹ˆè¦ç”¨å¼‚æˆ–è¿ç®—ç¬¦ï¼Ÿ**
Aï¼šä¿è¯äº†å¯¹è±¡çš„ hashCode çš„ 32 ä½å€¼åªè¦æœ‰ä¸€ä½å‘ç”Ÿæ”¹å˜ï¼Œæ•´ä¸ª hash() è¿”å›å€¼å°±ä¼šæ”¹å˜ã€‚å°½å¯èƒ½çš„å‡å°‘ç¢°æ’ã€‚

**Qï¼šHashMap çš„ table çš„å®¹é‡å¦‚ä½•ç¡®å®šï¼ŸloadFactor æ˜¯ä»€ä¹ˆï¼Ÿ è¯¥å®¹é‡å¦‚ä½•å˜åŒ–ï¼Ÿè¿™ç§å˜åŒ–ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿ**

Aï¼š1ã€**table æ•°ç»„å¤§å°**æ˜¯ç”± **capacity** è¿™ä¸ªå‚æ•°ç¡®å®šçš„ï¼Œé»˜è®¤æ˜¯**16**ï¼Œä¹Ÿå¯ä»¥æ„é€ æ—¶ä¼ å…¥ï¼Œæœ€å¤§é™åˆ¶æ˜¯1<<30ï¼›
 2ã€**loadFactor æ˜¯è£…è½½å› å­**ï¼Œä¸»è¦ç›®çš„æ˜¯ç”¨æ¥**ç¡®è®¤table æ•°ç»„æ˜¯å¦éœ€è¦åŠ¨æ€æ‰©å±•**ï¼Œé»˜è®¤å€¼æ˜¯**0.75**ï¼Œæ¯”å¦‚table æ•°ç»„å¤§å°ä¸º 16ï¼Œè£…è½½å› å­ä¸º 0.75 æ—¶ï¼Œthreshold å°±æ˜¯12ï¼Œå½“ table çš„å®é™…å¤§å°è¶…è¿‡ 12 æ—¶ï¼Œtableå°±éœ€è¦åŠ¨æ€æ‰©å®¹ï¼›
 3ã€æ‰©å®¹æ—¶ï¼Œè°ƒç”¨ resize() æ–¹æ³•ï¼Œå°† **table é•¿åº¦å˜ä¸ºåŸæ¥çš„ä¸¤å€**ï¼ˆæ³¨æ„æ˜¯ **table é•¿åº¦**ï¼Œè€Œä¸æ˜¯ thresholdï¼‰
 4ã€å¦‚æœæ•°æ®å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œæ‰©å±•æ—¶å°†ä¼šå¸¦æ¥æ€§èƒ½çš„æŸå¤±ï¼Œåœ¨æ€§èƒ½è¦æ±‚å¾ˆé«˜çš„åœ°æ–¹ï¼Œè¿™ç§æŸå¤±å¾ˆå¯èƒ½å¾ˆè‡´å‘½ã€‚

**Qï¼šHashMap å’Œ HashTable æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

Aï¼š1ã€**HashMap** æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œ**HashTable** æ˜¯**çº¿ç¨‹å®‰å…¨**çš„ï¼›
 2ã€ç”±äºçº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥ HashTable çš„æ•ˆç‡æ¯”ä¸ä¸Š HashMapï¼›
 3ã€**HashMap**æœ€å¤šåªå…è®¸**ä¸€æ¡è®°å½•çš„é”®ä¸ºnull**ï¼Œå…è®¸**å¤šæ¡è®°å½•çš„å€¼ä¸ºnull**ï¼Œè€Œ **HashTable** ä¸å…è®¸ï¼›
 4ã€**HashMap** é»˜è®¤åˆå§‹åŒ–æ•°ç»„çš„å¤§å°ä¸º**16**ï¼Œ**HashTable** ä¸º **11**ï¼Œå‰è€…æ‰©å®¹æ—¶ï¼Œæ‰©å¤§**ä¸¤å€**ï¼Œåè€…**æ‰©å¤§ä¸¤å€+1**ï¼›
 5ã€HashMap éœ€è¦é‡æ–°è®¡ç®— hash å€¼ï¼Œè€Œ HashTable ç›´æ¥ä½¿ç”¨å¯¹è±¡çš„ hashCode

**Qï¼šJava ä¸­çš„å¦ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ä¸ HashMap æå…¶ç±»ä¼¼çš„ç±»æ˜¯ä»€ä¹ˆï¼ŸåŒæ ·æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œå®ƒä¸ HashTable åœ¨çº¿ç¨‹åŒæ­¥ä¸Šæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ**

Aï¼š**ConcurrentHashMap** ç±»ï¼ˆæ˜¯ Javaå¹¶å‘åŒ… java.util.concurrent ä¸­æä¾›çš„ä¸€ä¸ª**çº¿ç¨‹å®‰å…¨ä¸”é«˜æ•ˆ**çš„ HashMap å®ç°ï¼‰ã€‚
 **HashTable** æ˜¯ä½¿ç”¨ **synchronize** å…³é”®å­—åŠ é”çš„åŸç†ï¼ˆå°±æ˜¯å¯¹**å¯¹è±¡**åŠ é”ï¼‰ï¼›
 è€Œé’ˆå¯¹ **ConcurrentHashMap**ï¼Œåœ¨ **JDK 1.7** ä¸­é‡‡ç”¨ **åˆ†æ®µé”**çš„æ–¹å¼ï¼›**JDK 1.8** ä¸­ç›´æ¥é‡‡ç”¨äº†**CASï¼ˆæ— é”ç®—æ³•ï¼‰+ synchronized**ã€‚

**Qï¼šHashMap & ConcurrentHashMap çš„åŒºåˆ«ï¼Ÿ**

Aï¼šé™¤äº†åŠ é”ï¼ŒåŸç†ä¸Šæ— å¤ªå¤§åŒºåˆ«ã€‚

å¦å¤–ï¼Œ**HashMap çš„é”®å€¼å¯¹å…è®¸æœ‰nullï¼Œä½†æ˜¯ConCurrentHashMap éƒ½ä¸å…è®¸**ã€‚

**Qï¼šä¸ºä»€ä¹ˆ ConcurrentHashMap  æ¯” HashTable æ•ˆç‡è¦é«˜ï¼Ÿ**

Aï¼š**HashTable** ä½¿ç”¨**ä¸€æŠŠé”ï¼ˆé”ä½æ•´ä¸ªé“¾è¡¨ç»“æ„ï¼‰**å¤„ç†å¹¶å‘é—®é¢˜ï¼Œå¤šä¸ªçº¿ç¨‹ç«äº‰ä¸€æŠŠé”ï¼Œå®¹æ˜“**é˜»å¡**ï¼›

**ConcurrentHashMap**  
 **JDK 1.7** ä¸­ä½¿ç”¨**åˆ†æ®µé”ï¼ˆReentrantLock + Segment + HashEntryï¼‰**ï¼Œç›¸å½“äºæŠŠä¸€ä¸ª HashMap åˆ†æˆå¤šä¸ªæ®µï¼Œæ¯æ®µåˆ†é…ä¸€æŠŠé”ï¼Œè¿™æ ·æ”¯æŒå¤šçº¿ç¨‹è®¿é—®ã€‚é”ç²’åº¦ï¼š**åŸºäº Segment**ï¼ŒåŒ…å«å¤šä¸ª HashEntryã€‚
 **JDK 1.8** ä¸­ä½¿ç”¨ **CAS + synchronized + Node + çº¢é»‘æ ‘**ã€‚é”ç²’åº¦ï¼š**Nodeï¼ˆé¦–ç»“ç‚¹ï¼‰**ï¼ˆå®ç° Map.Entry<K,V>ï¼‰ã€‚é”ç²’åº¦é™ä½äº†ã€‚

**Qï¼šJava1.7å’Œ1.8çš„HashMapçš„ä¸åŒç‚¹**

Aï¼š1ã€JDK1.7ç”¨çš„æ˜¯å¤´æ’æ³•ï¼Œè€ŒJDK1.8åŠä¹‹åä½¿ç”¨çš„éƒ½æ˜¯å°¾æ’æ³•ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿå› ä¸ºJDK1.7æ˜¯ç”¨å•é“¾è¡¨è¿›è¡Œçš„çºµå‘å»¶ä¼¸ï¼Œå½“é‡‡ç”¨å¤´æ’æ³•å°±æ˜¯èƒ½å¤Ÿæé«˜æ’å…¥çš„æ•ˆç‡ï¼Œä½†æ˜¯ä¹Ÿä¼šå®¹æ˜“å‡ºç°é€†åºä¸”ç¯å½¢é“¾è¡¨æ­»å¾ªç¯é—®é¢˜ã€‚ä½†æ˜¯åœ¨JDK1.8ä¹‹åæ˜¯å› ä¸ºåŠ å…¥äº†çº¢é»‘æ ‘ä½¿ç”¨å°¾æ’æ³•ï¼Œèƒ½å¤Ÿé¿å…å‡ºç°é€†åºä¸”é“¾è¡¨æ­»å¾ªç¯çš„é—®é¢˜ã€‚

2ã€æ‰©å®¹åæ•°æ®å­˜å‚¨ä½ç½®çš„è®¡ç®—æ–¹å¼ä¹Ÿä¸ä¸€æ ·ï¼š

â‘  åœ¨JDK1.7çš„æ—¶å€™æ˜¯ç›´æ¥ç”¨hashå€¼å’Œéœ€è¦æ‰©å®¹çš„äºŒè¿›åˆ¶æ•°è¿›è¡Œ&ï¼ˆè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆæ‰©å®¹çš„æ—¶å€™ä¸ºå•¥ä¸€å®šå¿…é¡»æ˜¯2çš„å¤šå°‘æ¬¡å¹‚çš„åŸå› æ‰€åœ¨ï¼Œå› ä¸ºå¦‚æœåªæœ‰2çš„næ¬¡å¹‚çš„æƒ…å†µæ—¶æœ€åä¸€ä½äºŒè¿›åˆ¶æ•°æ‰ä¸€å®šæ˜¯1ï¼Œè¿™æ ·èƒ½æœ€å¤§ç¨‹åº¦å‡å°‘hashç¢°æ’ï¼‰ï¼ˆhash å€¼ & length-1ï¼‰ ã€‚

â‘¡ è€Œåœ¨JDK1.8çš„æ—¶å€™ç›´æ¥ç”¨äº†JDK1.7çš„æ—¶å€™è®¡ç®—çš„è§„å¾‹ï¼Œä¹Ÿå°±æ˜¯æ‰©å®¹å‰çš„åŸå§‹ä½ç½® + æ‰©å®¹çš„å¤§å°å€¼ = JDK1.8çš„è®¡ç®—æ–¹å¼ï¼Œè€Œä¸å†æ˜¯ JDK1.7 çš„é‚£ç§å¼‚æˆ–çš„æ–¹æ³•ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼å°±ç›¸å½“äºåªéœ€è¦åˆ¤æ–­Hashå€¼çš„æ–°å¢å‚ä¸è¿ç®—çš„ä½æ˜¯0è¿˜æ˜¯1å°±ç›´æ¥è¿…é€Ÿè®¡ç®—å‡ºäº†æ‰©å®¹åçš„å‚¨å­˜æ–¹å¼ã€‚

3ã€JDK1.7çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯æ•°ç»„+ å•é“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚ä½†æ˜¯åœ¨JDK1.8åŠä¹‹åæ—¶ï¼Œä½¿ç”¨çš„æ˜¯æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„ï¼ˆå½“é“¾è¡¨çš„æ·±åº¦è¾¾åˆ°8çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯é»˜è®¤é˜ˆå€¼ï¼Œå°±ä¼šè‡ªåŠ¨æ‰©å®¹æŠŠé“¾è¡¨è½¬æˆçº¢é»‘æ ‘çš„æ•°æ®ç»“æ„æ¥æŠŠæ—¶é—´å¤æ‚åº¦ä»Oï¼ˆNï¼‰å˜æˆOï¼ˆlogNï¼‰æé«˜äº†æ•ˆç‡ï¼‰ã€‚







### HashSet

#### æ¦‚è¿°

- HashSet çš„åº•å±‚é€šè¿‡ **HashMap** å®ç°çš„ã€‚è€Œ HashMap åœ¨1.7ä¹‹å‰ä½¿ç”¨çš„æ˜¯æ•°ç»„ + é“¾è¡¨å®ç°ï¼Œåœ¨1.8 + ä½¿ç”¨çš„æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘å®ç°ã€‚å…¶å®ä¹Ÿå¯ä»¥è¿™æ ·ç†è§£ï¼ŒHashSet çš„åº•å±‚å®ç°å’Œ HashMap ä½¿ç”¨çš„æ˜¯ç›¸åŒçš„æ–¹å¼ï¼Œå› ä¸º Map æ˜¯æ— åºçš„ï¼Œå› æ­¤ HashSet ä¹Ÿ**æ— æ³•ä¿è¯é¡ºåº**ã€‚
- Set **æ²¡æœ‰é‡å¤å…ƒç´ **ã€‚ç›¸åŒçš„å…ƒç´ æ·»åŠ è¿›å»ä¹Ÿåªä¼šä¿ç•™ä¸€ä»½ã€‚
- HashSet çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯å€ŸåŠ© HashMap çš„æ–¹æ³•æ¥å®ç°çš„ã€‚
- å¯ä»¥é«˜æ•ˆçš„æ·»åŠ ã€åˆ é™¤å…ƒç´ ã€åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œæ•ˆç‡éƒ½ä¸ºO(1)ã€‚

#### æºç è§£æ

```java
public class HashSet<E> extends AbstractSet<E>
    implements Set<E>, Cloneable, java.io.Serializable {

    static final long serialVersionUID = -5024744406713321676L; // åºåˆ—åŒ–ç‰ˆæœ¬å·

    private transient HashMap<E,Object> map;  // HashMapå˜é‡ï¼Œç”¨äºå­˜æ”¾HashSetçš„å€¼

    private static final Object PRESENT = new Object(); // mapä¸­çš„å€¼

    // æ„é€ æ–¹æ³•
    public HashSet() {
        map = new HashMap<>();
    }

    // æ„é€ æ–¹æ³•ï¼Œå°†æŒ‡å®šçš„é›†åˆè½¬åŒ–ä¸ºHashSet
    public HashSet(Collection<? extends E> c) {
        map = new HashMap<>(Math.max((int) (c.size()/.75f) + 1, 16));
        addAll(c);
    }

    // æ„é€ æ–¹æ³•ï¼ŒæŒ‡å®šåˆå§‹åŒ–çš„å¤§å°å’Œè´Ÿè½½å› å­
    public HashSet(int initialCapacity, float loadFactor) {
        map = new HashMap<>(initialCapacity, loadFactor);
    }
    // æŒ‡å®šåˆå§‹åŒ–å¤§å°
    public HashSet(int initialCapacity) {
        map = new HashMap<>(initialCapacity);
    }

    // æ„é€ æ–¹æ³•ï¼Œé‡‡ç”¨defaultä¿®é¥°ï¼Œåªèƒ½æ˜¯åŒä¸€ä¸ªåŒ…ä¸‹çš„æˆå‘˜è®¿é—®ã€‚åŒ…ä¸ç›¸åŒæ— æ³•è®¿é—®
    HashSet(int initialCapacity, float loadFactor, boolean dummy) {
        map = new LinkedHashMap<>(initialCapacity, loadFactor);
    }

    // HashSetçš„éå†æ“ä½œ
    // é€šè¿‡è¿™ä¸ªæ–¹æ³•å¯ä»¥å‘ç°ï¼ŒHashSetè°ƒç”¨äº†HashMapå­˜æ”¾ï¼Œå› ä¸ºHashSetå¹¶ä¸æ˜¯é”®å€¼å¯¹å­˜å‚¨ï¼Œæ‰€ä»¥å®ƒåªæ˜¯æŠŠå®ƒçš„å€¼åšäº†Mapä¸­çš„é”®ï¼Œåœ¨éå†HashSetçš„é›†åˆå…ƒç´ æ—¶ï¼Œå®é™…ä¸Šæ˜¯éå†çš„Mapä¸­Keyçš„é›†åˆã€‚
    public Iterator<E> iterator() {
        return map.keySet().iterator();
    }

    // è¿”å›é›†åˆä¸­å…ƒç´ çš„å®¹é‡
    public int size() {
        return map.size();
    }

    // åˆ¤æ–­æ˜¯å¦ä¸ºç©º
    public boolean isEmpty() {
        return map.isEmpty();
    }

    // æ˜¯å¦åŒ…å«æŒ‡å®šçš„å…ƒç´ 
    public boolean contains(Object o) {
        return map.containsKey(o);
    }

    // æ·»åŠ å…ƒç´ ï¼Œæ·»åŠ çš„å…ƒç´ ä½œä¸ºäº†Mapä¸­çš„key,valueä½¿ç”¨äº†ä¸€ä¸ªå¸¸é‡è¡¨ç¤º
    public boolean add(E e) {
        return map.put(e, PRESENT)==null;
    }

    // åˆ é™¤å…ƒç´ 
    public boolean remove(Object o) {
        return map.remove(o)==PRESENT;
    }

    // æ¸…ç©ºé›†åˆ
    public void clear() {
        map.clear();
    }

    // å…‹éš†æ–¹æ³•
    public Object clone() {
        try {
            HashSet<E> newSet = (HashSet<E>) super.clone();
            newSet.map = (HashMap<E, Object>) map.clone();
            return newSet;
        } catch (CloneNotSupportedException e) {
            throw new InternalError();
        }
    }

    // å†™å…¥è¾“å‡ºæµæ“ä½œ
    private void writeObject(java.io.ObjectOutputStream s)
        throws java.io.IOException {
        // Write out any hidden serialization magic
        s.defaultWriteObject();

        // Write out HashMap capacity and load factor
        s.writeInt(map.capacity());
        s.writeFloat(map.loadFactor());

        // Write out size
        s.writeInt(map.size());

        // Write out all elements in the proper order.
        for (E e : map.keySet())
            s.writeObject(e);
    }

    // ä»è¾“å…¥æµä¸­è¯»å–å¯¹è±¡
    private void readObject(java.io.ObjectInputStream s)
        throws java.io.IOException, ClassNotFoundException {
        // Read in any hidden serialization magic
        s.defaultReadObject();

        // Read in HashMap capacity and load factor and create backing HashMap
        int capacity = s.readInt();
        float loadFactor = s.readFloat();
        map = (((HashSet)this) instanceof LinkedHashSet ?
               new LinkedHashMap<E,Object>(capacity, loadFactor) :
               new HashMap<E,Object>(capacity, loadFactor));

        // Read in size
        int size = s.readInt();

        // Read in all elements in the proper order.
        for (int i=0; i<size; i++) {
            E e = (E) s.readObject();
            map.put(e, PRESENT);
        }
    }
}
```



### TreeMap

#### æ¦‚è¿°

- TreeMap æ˜¯ä¸€ä¸ª**æœ‰åºçš„key-valueé›†åˆ**ï¼Œå®ƒæ˜¯é€šè¿‡çº¢é»‘æ ‘å®ç°çš„ã€‚
- TreeMap æ˜¯æŒ‰ç…§é”®è€Œä¸æ˜¯å€¼æœ‰åºï¼Œéƒ½æ˜¯å¯¹**é”®**è¿›è¡Œæ¯”è¾ƒã€‚
- 



#### åŸºæœ¬ä½¿ç”¨

##### æ„é€ æ–¹æ³•

- `TreeMap()`ï¼šåˆ›å»ºä¸€ä¸ªç©º TreeMapï¼ŒkeysæŒ‰ç…§**è‡ªç„¶æ’åº**ã€‚è¦æ±‚ Map ä¸­çš„é”®å®ç° Comparable æ¥å£ã€‚

    ```java
    TreeMap<Integer, String> treeMap = new TreeMap<>();
    ```

- `TreeMap(Comparator comparator)`ï¼šåˆ›å»ºä¸€ä¸ªç©ºTreeMapï¼ŒæŒ‰ç…§æŒ‡å®šçš„ **comparator** æ’åºã€‚å³åˆ›å»ºè‡ªå®šä¹‰çš„æ¯”è¾ƒå™¨ã€‚

    ```java
    TreeMap<Integer, String> map = new TreeMap<>(Comparator.reverseOrder());
    map.put(3, "val");
    map.put(2, "val");
    map.put(1, "val");
    map.put(5, "val");
    map.put(4, "val");
    System.out.println(map); // {5 = val, 4 = val, 3 = val, 2 = val, 1 = val} é€†åº
    ```

    ```java
    // String.CASE_INSENSITIVE_ORDERæ˜¯Stringç±»ä¸­çš„ä¸€ä¸ªå¿½ç•¥å¤§å°å†™çš„Comparator
    Map<String, String> map = new TreeMap<>(String.CASE_INSENSITIVE_ORDER);
    // é€†åºå¹¶å¿½ç•¥å¤§å°å†™
    Map<String, String> map = new TreeMap<>(Collections.reverseOrder(String.CASE_INSENSITIVE_ORDER));
    ```

- `TreeMap(Map m)`ï¼šç”±ç»™å®šçš„ map åˆ›å»ºä¸€ä¸ª TreeMapï¼Œkeys æŒ‰ç…§è‡ªç„¶æ’åºã€‚

    ```java
    Map<Integer, String> map = new HashMap<>();
    map.put(1, "val");
    ...
    TreeMap<Integer, String> treeMap = new TreeMap<>(map);
    ```

- `TreeMap(SortedMap m)`ï¼šç”±ç»™å®šçš„æœ‰åº map åˆ›å»º TreeMapï¼Œkeys æŒ‰ç…§åŸé¡ºåºæ’åºã€‚



##### å…¶ä»–æ–¹æ³•

**å¢æ·»å…ƒç´ **

- `V put(K key, V value)`ï¼šå°†æŒ‡å®šæ˜ å°„æ”¾å…¥è¯¥TreeMapä¸­
- `V putAll(Map map)`ï¼šå°†æŒ‡å®šmapæ”¾å…¥è¯¥TreeMapä¸­

**åˆ é™¤å…ƒç´ **

- `void clear()`ï¼šæ¸…ç©ºTreeMapä¸­çš„æ‰€æœ‰å…ƒç´ 
- `V remove(Object key)`ï¼šä»TreeMapä¸­ç§»é™¤æŒ‡å®škeyå¯¹åº”çš„æ˜ å°„

**ä¿®æ”¹å…ƒç´ **

- `V replace(K key, V value)`ï¼šæ›¿æ¢æŒ‡å®škeyå¯¹åº”çš„valueå€¼
- `boolean replace(K key, V oldValue, V newValue)`ï¼šå½“æŒ‡å®škeyçš„å¯¹åº”çš„valueä¸ºæŒ‡å®šå€¼æ—¶ï¼Œæ›¿æ¢è¯¥å€¼ä¸ºæ–°å€¼

**æŸ¥æ‰¾å…ƒç´ **

- `boolean containsKey(Object key)`ï¼šåˆ¤æ–­è¯¥TreeMapä¸­æ˜¯å¦åŒ…å«æŒ‡å®škeyçš„æ˜ å°„
- `boolean containsValue(Object value)`ï¼šåˆ¤æ–­è¯¥TreeMapä¸­æ˜¯å¦åŒ…å«æœ‰å…³æŒ‡å®švalueçš„æ˜ å°„
- `Map.Entry<K, V> firstEntry()`ï¼šè¿”å›è¯¥TreeMapçš„ç¬¬ä¸€ä¸ªï¼ˆæœ€å°çš„ï¼‰æ˜ å°„
- `K firstKey()`ï¼šè¿”å›è¯¥TreeMapçš„ç¬¬ä¸€ä¸ªï¼ˆæœ€å°çš„ï¼‰æ˜ å°„çš„key
- `Map.Entry<K, V> lastEntry()`ï¼šè¿”å›è¯¥TreeMapçš„æœ€åä¸€ä¸ªï¼ˆæœ€å¤§çš„ï¼‰æ˜ å°„
- `K lastKey()`ï¼šè¿”å›è¯¥TreeMapçš„æœ€åä¸€ä¸ªï¼ˆæœ€å¤§çš„ï¼‰æ˜ å°„çš„key
- `v get(K key)`ï¼šè¿”å›æŒ‡å®škeyå¯¹åº”çš„value
- `SortedMap<K, V> headMap(K toKey)`ï¼šè¿”å›è¯¥TreeMapä¸­ä¸¥æ ¼å°äºæŒ‡å®škeyçš„æ˜ å°„é›†åˆ
- `SortedMap<K, V> subMap(K fromKey, K toKey)`ï¼šè¿”å›è¯¥TreeMapä¸­æŒ‡å®šèŒƒå›´çš„æ˜ å°„é›†åˆï¼ˆå¤§äºç­‰äºfromKeyï¼Œå°äºtoKeyï¼‰

**éå†æ¥å£**

- `Set<Map<K, V>> entrySet()`ï¼šè¿”å›ç”±è¯¥TreeMapä¸­çš„æ‰€æœ‰æ˜ å°„ç»„æˆçš„Setå¯¹è±¡
- `void forEach(BiConsumer<? super K,? super V> action)`ï¼šå¯¹è¯¥TreeMapä¸­çš„æ¯ä¸€ä¸ªæ˜ å°„æ‰§è¡ŒæŒ‡å®šæ“ä½œ
- `Collection<V> values()`ï¼šè¿”å›ç”±è¯¥TreeMapä¸­æ‰€æœ‰çš„valuesæ„æˆçš„é›†åˆ

**å…¶ä»–æ–¹æ³•**

- `Object clone()`ï¼šè¿”å›TreeMapå®ä¾‹çš„æµ…æ‹·è´
- `Comparator<? super K> comparator()`ï¼šè¿”å›ç»™è¯¥TreeMapçš„keysæ’åºçš„comparatorï¼Œè‹¥ä¸ºè‡ªç„¶æ’åºåˆ™è¿”å›null
- `int size()`ï¼šè¿”å›è¯¥TreepMapä¸­åŒ…å«çš„æ˜ å°„çš„æ•°é‡

```java
TreeMap<Integer, String> treeMap = new TreeMap<>();
treeMap.put(1, "a");
treeMap.put(2, "b");
treeMap.put(3, "c");
treeMap.put(4, "d"); 	// treeMap: {1 = a, 2 = b, 3 = c, 4 = d}

treeMap.remove(4); // treeMap: {1 = a, 2 = b, 3 = c}
int sizeOfTreeMap = treeMap.size(); // sizeOfTreeMap: 3

treeMap.replace(2, "e"); // treeMap: {1 = a, 2 = e, 3 = c}

Map.Entry entry = treeMap.firstEntry(); // entry: 1 -> a
Integer key = treeMap.firstKey(); // key: 1
entry = treeMap.lastEntry(); // entry: 3 -> c
key = treeMap.lastKey(); // key: 3
String value = treeMap.get(3); // value: c
SortedMap sortedMap = treeMap.headMap(2); // sortedMap: {1 = a}
sortedMap = treeMap.subMap(1, 3); // sortedMap: {1 = a, 2 = e}

Set setOfEntry = treeMap.entrySet(); // setOfEntry: [1 = a, 2 = e, 3 = c]
Collection<String> values = treeMap.values(); // values: [a, e, c]
treeMap.forEach((integer, s) -> System.out.println(integer + "->" + s)); 
// outputï¼š
// 1 -> a
// 2 -> e
// 3 -> c
```

##### éå†æ–¹å¼

- forå¾ªç¯

    ```java
    for (Map.Entry entry : treeMap.entrySet()) {
          System.out.println(entry);
    }
    ```

- è¿­ä»£å™¨å¾ªç¯

    ```java
    Iterator iterator = treeMap.entrySet().iterator();
    while (iterator.hasNext()) {
          System.out.println(iterator.next());
    }
    ```



#### æºç è§£æ

TreeMap çš„åŸºæœ¬æ•°æ®ç»“æ„ Entry çš„éƒ¨åˆ†æºç ï¼š

```java
static final class Entry<K,V> implements Map.Entry<K,V> {
    K key;
    V value;
    Entry<K,V> left;
    Entry<K,V> right;
    Entry<K,V> parent;
    boolean color = BLACK;
    // ......
}
```

å¯ä»¥çœ‹å‡ºï¼ŒEntry ä¸­é™¤äº†åŸºæœ¬çš„ keyã€value  ä¹‹å¤–ï¼Œè¿˜æœ‰å·¦èŠ‚ç‚¹ã€å³èŠ‚ç‚¹ä»¥åŠçˆ¶èŠ‚ç‚¹ï¼Œå¦å¤–è¿˜æœ‰é¢œè‰²é»‘è‰²ä¸º trueï¼Œçº¢è‰²ä¸º falseã€‚

å…·ä½“çœ‹çœ‹è¿™ä¸ªï¼š

[çº¢é»‘æ ‘å®ç°TreeMapåŸç†è§£æ](https://www.cnblogs.com/Joe-Go/p/10497115.html)





### TreeSet

- TreeSet æ˜¯ Set çš„ä¸€ä¸ªå­ç±»ï¼ŒTreeSet é›†åˆæ˜¯ç”¨æ¥å¯¹è±¡å…ƒç´ è¿›è¡Œæ’åºçš„ï¼Œæ²¡æœ‰é‡å¤å…ƒç´ ã€‚å®ç°äº†**æ’é‡ä¸æœ‰åº**ã€‚
- éœ€è¦ä¼ å…¥ä¸€ä¸ª Comparator æ¯”è¾ƒå™¨å¯¹è±¡è¿›è¡Œæ’åºï¼Œæˆ–è€…æ·»åŠ çš„å…ƒç´ å®ç°äº† Comparable æ¥å£ã€‚
- å†…éƒ¨åŸºäº TreeMap å®ç°ã€‚
- 













### â€» LinkedHashMap

#### æ¦‚è¿°

- LinkedHashMap æ˜¯ HashMap çš„å­ç±»ï¼Œä½†å¯ä»¥ä¿æŒå…ƒç´ æŒ‰æ’å…¥æˆ–è®¿é—®æœ‰åºï¼Œä¸ TreeMap æŒ‰é”®æ’åºä¸åŒã€‚
- HashMap æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼ŒLinkedHashMap åŒæ ·æ˜¯çº¿ç¨‹**ä¸å®‰å…¨**çš„ã€‚





#### åŸºæœ¬ä½¿ç”¨

HashMapæ˜¯æ— åºçš„ï¼Œå½“æˆ‘ä»¬å¸Œæœ›æœ‰é¡ºåºåœ°å»å­˜å‚¨key-valueæ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨LinkedHashMap

```java
// ä½¿ç”¨HashMap
Map<String, String> hashMap = new HashMap<String, String>();
hashMap.put("name1", "josan1");
hashMap.put("name2", "josan2");
hashMap.put("name3", "josan3");
Set<Entry<String, String>> set = hashMap.entrySet();
Iterator<Entry<String, String>> iterator = set.iterator();
while(iterator.hasNext()) {
    Entry entry = iterator.next();
    String key = (String) entry.getKey();
    String value = (String) entry.getValue();
    System.out.println("key:" + key + ",value:" + value);
}
// key:name3,value:josan3
// key:name1,value:josan1
// key:name2,value:josan2

// ä½¿ç”¨LinkedHashMap
Map<String, String> linkedHashMap = new LinkedHashMap<>();
linkedHashMap.put("name1", "josan1");
linkedHashMap.put("name2", "josan2");
linkedHashMap.put("name3", "josan3");
Set<Entry<String, String>> set = linkedHashMap.entrySet();
Iterator<Entry<String, String>> iterator = set.iterator();
while(iterator.hasNext()) {
    Entry entry = iterator.next();
    String key = (String) entry.getKey();
    String value = (String) entry.getValue();
    System.out.println("key:" + key + ",value:" + value);
}
// key:name1,value:josan1
// key:name2,value:josan2
// key:name3,value:josan3
```

ç»“æœå¯çŸ¥ï¼ŒLinkedHashMapæ˜¯æœ‰åºçš„ï¼Œä¸”é»˜è®¤ä¸º**æ’å…¥é¡ºåº**ã€‚

è·ŸHashMapä¸€æ ·ï¼Œå®ƒä¹Ÿæ˜¯æä¾›äº† key-value çš„å­˜å‚¨æ–¹å¼ï¼Œå¹¶æä¾›äº† put å’Œ get æ–¹æ³•æ¥è¿›è¡Œæ•°æ®å­˜å–ã€‚



#### æºç åˆ†æ

LinkedHashMap ç»“æ„å¦‚ä¸‹å›¾ã€‚

![1567478530282](assets/1567478530282.png)

ç»§æ‰¿è‡ª HashMapï¼Œå› æ­¤å…·æœ‰å’Œ HashMap ä¸€æ ·çš„**å¿«é€ŸæŸ¥æ‰¾**ç‰¹æ€§ã€‚

```java
public class LinkedHashMap<K,V> extends HashMap<K,V> implements Map<K,V>
```

**æ„é€ æ–¹æ³•**

æœ‰å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œæ— å‚çš„å¦‚ä¸‹

```java
public LinkedHashMap() {
    // è°ƒç”¨HashMapçš„æ„é€ æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯åˆå§‹åŒ–Entry[] table
    super();
    // è¿™é‡Œæ˜¯æŒ‡æ˜¯å¦åŸºäºè®¿é—®æ’åºï¼Œé»˜è®¤ä¸ºfalse
    accessOrder = false;
}    public LinkedHashMap() {
    // è°ƒç”¨HashMapçš„æ„é€ æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯åˆå§‹åŒ–Entry[] table
    super();
    // è¿™é‡Œæ˜¯æŒ‡æ˜¯å¦åŸºäºè®¿é—®æ’åºï¼Œé»˜è®¤ä¸ºfalse
    accessOrder = false;
}
```

é¦–å…ˆä½¿ç”¨ super è°ƒç”¨äº†çˆ¶ç±» HashMap çš„æ„é€ æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯æ ¹æ®åˆå§‹å®¹é‡ã€è´Ÿè½½å› å­å»åˆå§‹åŒ–Entry[] tableã€‚

ç„¶åæŠŠ accessOrder è®¾ç½®ä¸º falseï¼Œè¿™å°±è·Ÿå­˜å‚¨çš„é¡ºåºæœ‰å…³äº†ï¼ŒLinkedHashMap å­˜å‚¨æ•°æ®æ˜¯æœ‰åºçš„ï¼Œè€Œä¸”åˆ†ä¸ºä¸¤ç§ï¼š**æ’å…¥é¡ºåºå’Œè®¿é—®é¡ºåºã€‚**

è¿™é‡Œ accessOrder è®¾ç½®ä¸º falseï¼Œè¡¨ç¤ºä¸æ˜¯è®¿é—®é¡ºåºè€Œæ˜¯æ’å…¥é¡ºåºå­˜å‚¨çš„ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤å€¼ï¼Œè¡¨ç¤º LinkedHashMapä¸­å­˜å‚¨çš„é¡ºåºæ˜¯æŒ‰ç…§è°ƒç”¨ put æ–¹æ³•æ’å…¥çš„é¡ºåºè¿›è¡Œæ’åºçš„ã€‚

LinkedHashMap ä¹Ÿæä¾›äº†å¯ä»¥è®¾ç½® accessOrder çš„æ„é€ æ–¹æ³•ï¼Œå¦‚ä¸‹è®¾ç½®æ˜¯æŒ‰ç…§è®¿é—®é¡ºåºè¿›è¡Œå­˜å‚¨ï¼Œæ­¤æ—¶éå¸¸é€‚åˆç”¨äº LRU ç¼“å­˜ã€‚

```java
// ç¬¬ä¸‰ä¸ªå‚æ•°ç”¨äºæŒ‡å®šaccessOrderå€¼
Map<String, String> linkedHashMap = new LinkedHashMap<>(16, 0.75f, true);
linkedHashMap.put("name1", "josan1");
linkedHashMap.put("name2", "josan2");
linkedHashMap.put("name3", "josan3");
System.out.println("å¼€å§‹æ—¶é¡ºåºï¼š");
Set<Entry<String, String>> set = linkedHashMap.entrySet();
Iterator<Entry<String, String>> iterator = set.iterator();
while(iterator.hasNext()) {
    Entry entry = iterator.next();
    String key = (String) entry.getKey();
    String value = (String) entry.getValue();
    System.out.println("key:" + key + ",value:" + value);
}
System.out.println("é€šè¿‡getæ–¹æ³•ï¼Œå¯¼è‡´keyä¸ºname1å¯¹åº”çš„Entryåˆ°è¡¨å°¾");
linkedHashMap.get("name1");
Set<Entry<String, String>> set2 = linkedHashMap.entrySet();
Iterator<Entry<String, String>> iterator2 = set2.iterator();
while(iterator2.hasNext()) {
    Entry entry = iterator2.next();
    String key = (String) entry.getKey();
    String value = (String) entry.getValue();
    System.out.println("key:" + key + ",value:" + value);
}
// å¼€å§‹æ—¶é¡ºåºï¼š
// key:name1,value:josan1
// key:name2,value:josan2
// key:name3,value:josan3
// é€šè¿‡getæ–¹æ³•ï¼Œå¯¼è‡´keyä¸ºname1å¯¹åº”çš„Entryåˆ°è¡¨å°¾
// key:name2,value:josan2
// key:name3,value:josan3
// key:name1,value:josan1
```

å› ä¸ºè°ƒç”¨äº†get("name1")å¯¼è‡´äº† name1 å¯¹åº”çš„ Entry ç§»åŠ¨åˆ°äº† Map æœ€åã€‚

**åˆå§‹åŒ–**

åœ¨ HashMap çš„æ„é€ å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº† init æ–¹æ³•ï¼Œè€Œåœ¨ HashMap ä¸­ init æ–¹æ³•æ˜¯ç©ºå®ç°ï¼Œä½† LinkedHashMap é‡å†™äº†è¯¥æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨ LinkedHashMap çš„æ„é€ æ–¹æ³•é‡Œï¼Œè°ƒç”¨äº†è‡ªèº«çš„ init æ–¹æ³•ï¼Œinit çš„é‡å†™å®ç°å¦‚ä¸‹ï¼š

```java
/**
 * Called by superclass constructors and pseudoconstructors (clone,
 * readObject) before any entries are inserted into the map.  Initializes
 * the chain.
 */
@Override
void init() {
    // åˆ›å»ºäº†ä¸€ä¸ªhash = -1ï¼Œkeyã€valueã€nextéƒ½ä¸ºnullçš„Entry
    header = new Entry<>(-1, null, null, null);
    // è®©åˆ›å»ºçš„Entryçš„beforeå’Œafteréƒ½æŒ‡å‘è‡ªèº«ï¼Œæ³¨æ„afterä¸æ˜¯ä¹‹å‰æåˆ°çš„next
    // å…¶å®å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªåªæœ‰å¤´éƒ¨èŠ‚ç‚¹çš„åŒå‘é“¾è¡¨
    header.before = header.after = header;
}
```

**å­˜å‚¨ç»“æ„**

HashMap ä¸­é™æ€å†…éƒ¨ç±» Entry æ˜¯è¿™æ ·å®šä¹‰çš„ã€‚

```java
static class Entry<K,V> implements Map.Entry<K,V> {
    final K key;
    V value;
    Entry<K,V> next;
    int hash;
}    
```

LinkedHashMapæœ‰è‡ªå·±çš„é™æ€å†…éƒ¨ç±» Entryï¼Œå®ƒ**ç»§æ‰¿**äº†HashMap.Entryï¼Œå®šä¹‰å¦‚ä¸‹:

```java
/**
 * LinkedHashMap entry.
 */
private static class Entry<K,V> extends HashMap.Entry<K,V> {
    // These fields comprise the doubly linked list used for iteration.
    Entry<K,V> before, after;

    Entry(int hash, K key, V value, HashMap.Entry<K,V> next) {
        super(hash, key, value, next);
	}
}    
```

æ‰€ä»¥ LinkedHashMap æ„é€ å‡½æ•°ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨ HashMap æ„é€ å‡½æ•°åˆå§‹åŒ–äº†ä¸€ä¸ª Entry[] tableï¼Œç„¶åè°ƒç”¨è‡ªèº«çš„init åˆå§‹åŒ–äº†ä¸€ä¸ª**åªæœ‰å¤´ç»“ç‚¹çš„åŒå‘é“¾è¡¨**ã€‚ç”¨æ¥ç»´æŠ¤æ’å…¥é¡ºåºæˆ–è€… **LRU** é¡ºåºã€‚å‚æ•°**accessOrder** ç”¨äºæŒ‡å®šæ˜¯å¦æŒ‰**è®¿é—®é¡ºåº**ï¼Œé»˜è®¤ä¸º falseï¼Œæ­¤æ—¶ç»´æŠ¤çš„æ˜¯**æ’å…¥é¡ºåº**ã€‚å¦‚æœä¸º trueï¼Œå°±æ˜¯è®¿é—®é¡ºåºã€‚

```java
/**
 * The head (eldest) of the doubly linked list.
 */
transient LinkedHashMap.Entry<K,V> head;

/**
 * The tail (youngest) of the doubly linked list.
 */
transient LinkedHashMap.Entry<K,V> tail;

final boolean accessOrder;
```

å®Œæˆäº†å¦‚ä¸‹æ“ä½œã€‚

![1567483723793](assets/1567483723793.png)

**put æ–¹æ³•**

LinkedHashMap å¦‚ä¸‹ï¼ˆJava 9ï¼‰ï¼š

```java
public V put(K key, V value) {
    return putVal(hash(key), key, value, false, true);
}
```

```java
/**
 * Implements Map.put and related methods
 *
 * @param hash hash for key
 * @param key the key
 * @param value the value to put
 * @param onlyIfAbsent if true, don't change existing value
 * @param evict if false, the table is in creation mode.
 * @return previous value, or null if none
 */
final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
               boolean evict) {
    Node<K,V>[] tab; Node<K,V> p; int n, i;
    if ((tab = table) == null || (n = tab.length) == 0)
        n = (tab = resize()).length;
    if ((p = tab[i = (n - 1) & hash]) == null)
        tab[i] = newNode(hash, key, value, null);
    else {
        Node<K,V> e; K k;
        if (p.hash == hash &&
            ((k = p.key) == key || (key != null && key.equals(k))))
            e = p;
        else if (p instanceof TreeNode)
            e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);
        else {
            for (int binCount = 0; ; ++binCount) {
                if ((e = p.next) == null) {
                    p.next = newNode(hash, key, value, null);
                    if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
                        treeifyBin(tab, hash);
                    break;
                }
                if (e.hash == hash &&
                    ((k = e.key) == key || (key != null && key.equals(k))))
                    break;
                p = e;
            }
        }
        if (e != null) { // existing mapping for key
            V oldValue = e.value;
            if (!onlyIfAbsent || oldValue == null)
                e.value = value;
            // é‡ç‚¹
            afterNodeAccess(e);
            return oldValue;
        }
    }
    ++modCount;
    if (++size > threshold)
        // æ‰©å®¹
        resize();
    // é‡ç‚¹
    afterNodeInsertion(evict);
    return null;
}
```

å½“ put å…ƒç´ æ—¶ï¼Œä¸ä½†è¦æŠŠå®ƒåŠ å…¥åˆ° **HashMap** ä¸­å»ï¼Œè¿˜è¦åŠ å…¥åˆ°**åŒå‘é“¾è¡¨**ä¸­ï¼Œæ‰€ä»¥å¯ä»¥çœ‹å‡ºLinkedHashMapå°±æ˜¯ **HashMap + åŒå‘é“¾è¡¨** ï¼Œä¸‹é¢ç”¨å›¾æ¥è¡¨ç¤ºé€æ­¥å¾€ LinkedHashMap ä¸­æ·»åŠ æ•°æ®çš„è¿‡ç¨‹ï¼Œçº¢è‰²éƒ¨åˆ†æ˜¯åŒå‘é“¾è¡¨ï¼Œé»‘è‰²éƒ¨åˆ†æ˜¯ HashMap ç»“æ„ï¼Œheader æ˜¯ä¸€ä¸ª Entry ç±»å‹çš„åŒå‘é“¾è¡¨è¡¨å¤´ï¼Œæœ¬èº«ä¸å­˜å‚¨æ•°æ®ã€‚

åŠ å…¥ä¸€ä¸ªå…ƒç´ Entry1ï¼Œ å‡è®¾ index ä¸º0ï¼Œå¦‚ä¸‹å›¾ã€‚

![1567480305247](assets/1567480305247.png)

åŠ å…¥ Entry2ï¼Œå‡è®¾ index ä¸º15ï¼Œå¦‚ä¸‹ï¼š

![1567480481449](assets/1567480481449.png)

å†æ·»åŠ ä¸€ä¸ª Entry3ï¼Œå‡è®¾å…¶ index ä¸º 0ï¼Œå¦‚ä¸‹å›¾ã€‚

![1567480711374](assets/1567480711374.png)

ä»¥ä¸Šï¼Œå°±æ˜¯LinkedHashMap çš„ put çš„æ‰€æœ‰è¿‡ç¨‹äº†ï¼Œæ€»ä½“æ¥çœ‹ï¼Œè·Ÿ HashMap çš„ put ç±»ä¼¼ï¼Œåªä¸è¿‡å¤šäº†æŠŠæ–°å¢çš„Entry åŠ å…¥åˆ°åŒå‘åˆ—è¡¨ä¸­ã€‚

**æ‰©å®¹**

åœ¨ HashMap çš„ put æ–¹æ³•ä¸­ï¼Œå¦‚æœå‘ç°å‰å…ƒç´ ä¸ªæ•°è¶…è¿‡äº†æ‰©å®¹é˜€å€¼æ—¶ï¼Œä¼šè°ƒç”¨ resize æ–¹æ³•ã€‚LinkedHashMapé‡å†™äº† transfer æ–¹æ³•ï¼Œæ•°æ®çš„è¿ç§»ã€‚å¯ä»¥çœ‹å‡ºï¼ŒLinkedHashMap æ‰©å®¹æ—¶ï¼Œæ•°æ®çš„å†æ•£åˆ—å’Œ HashMap æ˜¯ä¸ä¸€æ ·çš„ã€‚

HashMap æ˜¯å…ˆéå†æ—§ tableï¼Œå†éå†æ—§ table ä¸­æ¯ä¸ªå…ƒç´ çš„å•å‘é“¾è¡¨ï¼Œå–å¾— Entry ä»¥åï¼Œé‡æ–°è®¡ç®— hash å€¼ï¼Œç„¶åå­˜æ”¾åˆ°æ–° table çš„å¯¹åº”ä½ç½®ã€‚

LinkedHashMapæ˜¯éå†çš„åŒå‘é“¾è¡¨ï¼Œå–å¾—æ¯ä¸€ä¸ª Entryï¼Œç„¶åé‡æ–°è®¡ç®— hash å€¼ï¼Œç„¶åå­˜æ”¾åˆ°æ–° table çš„å¯¹åº”ä½ç½®ã€‚

ä»éå†çš„æ•ˆç‡æ¥è¯´ï¼Œéå†åŒå‘é“¾è¡¨çš„æ•ˆç‡è¦é«˜äºéå† tableï¼Œå› ä¸ºéå†åŒå‘é“¾è¡¨æ˜¯ N æ¬¡ï¼ˆNä¸ºå…ƒç´ ä¸ªæ•°ï¼‰ï¼›è€Œéå†table æ˜¯ N + table çš„ç©ºä½™ä¸ªæ•°ï¼ˆNä¸ºå…ƒç´ ä¸ªæ•°ï¼‰ã€‚

**get æ–¹æ³•**

ä»£ç å¦‚ä¸‹ï¼ˆJava 9ï¼‰

```java
public V get(Object key) {
    Node<K,V> e;
    if ((e = getNode(hash(key), key)) == null)
        return null;
    // å¦‚æœæ˜¯trueå°±æ˜¯è®¿é—®é¡ºåºï¼Œå°±ä¼šæŠŠæœ€è¿‘è®¿é—®çš„æ•°æ®æ”¾åˆ°æœ«å°¾
    if (accessOrder)
        // é¡ºåºè°ƒæ•´
        afterNodeAccess(e);
    return e.value;
}
```

**é¡ºåºç»´æŠ¤**

LinkedHashMap æœ€é‡è¦çš„æ˜¯ä»¥ä¸‹ç”¨äº**ç»´æŠ¤é¡ºåºçš„å‡½æ•°**ï¼Œå®ƒä»¬ä¼šåœ¨ **putã€get** ç­‰æ–¹æ³•ä¸­è°ƒç”¨ã€‚

```java
void afterNodeAccess(Node<K,V> p) { }
void afterNodeInsertion(boolean evict) { }
```

**afterNodeAccess**()

å½“ä¸€ä¸ªèŠ‚ç‚¹è¢«**è®¿é—®**æ—¶ï¼Œå¦‚æœ accessOrder ä¸º true ï¼ˆå³è®¿é—®é¡ºåºï¼‰ï¼Œåˆ™ä¼šå°†è¯¥èŠ‚ç‚¹ç§»åˆ°**é“¾è¡¨å°¾éƒ¨**ã€‚ä¹Ÿå°±æ˜¯è¯´æŒ‡å®šä¸º LRU é¡ºåºä¹‹åï¼Œåœ¨æ¯æ¬¡è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¼šå°†è¿™ä¸ªèŠ‚ç‚¹ç§»åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œä¿è¯**é“¾è¡¨å°¾éƒ¨æ˜¯æœ€è¿‘è®¿é—®**çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆ**é“¾è¡¨é¦–éƒ¨**å°±æ˜¯**æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨**çš„èŠ‚ç‚¹ã€‚

```java
void afterNodeAccess(Node<K,V> e) { // move node to last
    LinkedHashMap.Entry<K,V> last;
    if (accessOrder && (last = tail) != e) {
        LinkedHashMap.Entry<K,V> p =
            (LinkedHashMap.Entry<K,V>)e, b = p.before, a = p.after;
        p.after = null;
        if (b == null)
            head = a;
        else
            b.after = a;
        if (a != null)
            a.before = b;
        else
            last = b;
        if (last == null)
            head = p;
        else {
            p.before = last;
            last.after = p;
        }
        tail = p;
        ++modCount;
    }
}
```

**afterNodeInsertion**()

åœ¨ put ç­‰æ“ä½œä¹‹åæ‰§è¡Œï¼Œå½“ removeEldestEntry() æ–¹æ³•è¿”å› true æ—¶ä¼š**ç§»é™¤æœ€æ™š**çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯é“¾è¡¨**é¦–éƒ¨**èŠ‚ç‚¹ firstã€‚

evict åªæœ‰åœ¨æ„å»º Map çš„æ—¶å€™æ‰ä¸º falseï¼Œåœ¨è¿™é‡Œä¸º trueã€‚

```java
void afterNodeInsertion(boolean evict) { // possibly remove eldest
    LinkedHashMap.Entry<K,V> first;
    if (evict && (first = head) != null && removeEldestEntry(first)) {
        K key = first.key;
        removeNode(hash(key), key, null, false, true);
    }
}
```

removeEldestEntry() é»˜è®¤ä¸º falseï¼Œå¦‚æœéœ€è¦è®©å®ƒä¸º trueï¼Œéœ€è¦ç»§æ‰¿ LinkedHashMap å¹¶ä¸”è¦†ç›–è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼Œè¿™åœ¨å®ç° **LRU çš„ç¼“å­˜**ä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œé€šè¿‡ç§»é™¤æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯ç¼“å­˜ç©ºé—´è¶³å¤Ÿï¼Œå¹¶ä¸”ç¼“å­˜çš„æ•°æ®éƒ½æ˜¯çƒ­ç‚¹æ•°æ®ã€‚

```java
protected boolean removeEldestEntry(Map.Entry<K,V> eldest) {
    return false;
}
```

#### HashMap ä¸ LinkedHashMap å¯¹æ¯”

- çœ‹çœ‹HashMapå’ŒLinkedHashMapçš„ç»“æ„å›¾ï¼ŒLinkedHashMap å…¶å®å°±æ˜¯å¯ä»¥çœ‹æˆ HashMap çš„åŸºç¡€ä¸Šï¼Œå¤šäº†ä¸€ä¸ª**åŒå‘é“¾è¡¨**æ¥ç»´æŒé¡ºåºã€‚

![1567483958427](assets/1567483958427.png)



![1567483989341](assets/1567483989341.png)

- LinkedHashMap æ˜¯ç»§æ‰¿äº HashMapï¼Œæ˜¯åŸºäº HashMap å’ŒåŒå‘é“¾è¡¨æ¥å®ç°çš„ã€‚
- HashMap æ— åºï¼›LinkedHashMap æœ‰åºï¼Œå¯åˆ†ä¸ºæ’å…¥é¡ºåºå’Œè®¿é—®é¡ºåºä¸¤ç§ã€‚å¦‚æœæ˜¯è®¿é—®é¡ºåºï¼Œé‚£ put å’Œ getæ“ä½œå·²å­˜åœ¨çš„ Entry æ—¶ï¼Œéƒ½ä¼šæŠŠ Entry ç§»åŠ¨åˆ°åŒå‘é“¾è¡¨çš„è¡¨å°¾(å…¶å®æ˜¯å…ˆåˆ é™¤å†æ’å…¥)ã€‚
- LinkedHashMap å­˜å–æ•°æ®ï¼Œè¿˜æ˜¯è·Ÿ HashMap ä¸€æ ·ä½¿ç”¨çš„ Entry[] çš„æ–¹å¼ï¼ŒåŒå‘é“¾è¡¨åªæ˜¯ä¸ºäº†ä¿è¯é¡ºåºã€‚
- LinkedHashMap æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚
- LinkedHashMap åŠå…¶èŠ‚ç‚¹ç±» LinkedHashMap.Entry é‡å†™äº†éƒ¨åˆ†æ–¹æ³•æ¥å®ç°äº†å¯¹é¡ºåºçš„æ§åˆ¶ã€‚



#### LRU ç¼“å­˜åº”ç”¨

ä»¥ä¸‹æ˜¯ä½¿ç”¨ LinkedHashMap å®ç°çš„ä¸€ä¸ª LRU ç¼“å­˜ï¼š

- è®¾å®š**æœ€å¤§ç¼“å­˜**ç©ºé—´ MAX_ENTRIES  ä¸º 3ï¼›
- ä½¿ç”¨ LinkedHashMap çš„æ„é€ å‡½æ•°å°† accessOrder è®¾ç½®ä¸º **true**ï¼Œå¼€å¯ LRU é¡ºåºï¼›
- **è¦†ç›–** removeEldestEntry() æ–¹æ³•å®ç°ï¼Œåœ¨èŠ‚ç‚¹å¤šäº MAX_ENTRIES å°±ä¼šå°†æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„æ•°æ®ç§»é™¤ã€‚

```java
class LRUCache<K, V> extends LinkedHashMap<K, V> {
    private static final int MAX_ENTRIES = 3;

    // è¦†å†™
    protected boolean removeEldestEntry(Map.Entry eldest) {
        return size() > MAX_ENTRIES;
    }

    LRUCache() {
        super(MAX_ENTRIES, 0.75f, true);
    }
}
```

```java
public static void main(String[] args) {
    LRUCache<Integer, String> cache = new LRUCache<>();
    cache.put(1, "a");
    cache.put(2, "b");
    cache.put(3, "c");
    cache.get(1);
    cache.put(4, "d");
    System.out.println(cache.keySet());
}
```

```html
[3, 1, 4]
```





### WeakHashMap

#### å­˜å‚¨ç»“æ„

WeakHashMap çš„ Entry ç»§æ‰¿è‡ª WeakReferenceï¼Œè¢« WeakReference å…³è”çš„å¯¹è±¡åœ¨ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶æ—¶ä¼š**è¢«å›æ”¶**ã€‚

WeakHashMap ä¸»è¦ç”¨æ¥**å®ç°ç¼“å­˜**ï¼Œé€šè¿‡ä½¿ç”¨ WeakHashMap æ¥å¼•ç”¨ç¼“å­˜å¯¹è±¡ï¼Œç”± JVM å¯¹è¿™éƒ¨åˆ†**ç¼“å­˜è¿›è¡Œå›æ”¶**ã€‚

```java
private static class Entry<K,V> extends WeakReference<Object> implements Map.Entry<K,V>
```

#### ConcurrentCache

Tomcat ä¸­çš„ **ConcurrentCache** ä½¿ç”¨äº† WeakHashMap æ¥å®ç°**ç¼“å­˜**åŠŸèƒ½ã€‚

ConcurrentCache é‡‡å–çš„æ˜¯**åˆ†ä»£ç¼“å­˜**ï¼š

- ç»å¸¸ä½¿ç”¨çš„å¯¹è±¡æ”¾å…¥ **eden** ä¸­ï¼Œeden ä½¿ç”¨ **ConcurrentHashMap** å®ç°ï¼Œä¸ç”¨æ‹…å¿ƒä¼šè¢«å›æ”¶ï¼ˆä¼Šç”¸å›­ï¼‰ï¼›
- ä¸å¸¸ç”¨çš„å¯¹è±¡æ”¾å…¥ **longterm**ï¼Œlongterm ä½¿ç”¨ **WeakHashMap** å®ç°ï¼Œè¿™äº›è€å¯¹è±¡ä¼šè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚
- å½“è°ƒç”¨  get() æ–¹æ³•æ—¶ï¼Œä¼šå…ˆä» eden åŒºè·å–ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°çš„è¯å†åˆ° longterm è·å–ï¼Œå½“ä» longterm è·å–åˆ°å°±æŠŠå¯¹è±¡**æ”¾å…¥ eden** ä¸­ï¼Œä»è€Œä¿è¯ç»å¸¸è¢«è®¿é—®çš„èŠ‚ç‚¹ä¸å®¹æ˜“è¢«å›æ”¶ã€‚
- å½“è°ƒç”¨ put() æ–¹æ³•æ—¶ï¼Œå¦‚æœ eden çš„å¤§å°è¶…è¿‡äº† sizeï¼Œé‚£ä¹ˆå°±å°† eden ä¸­çš„æ‰€æœ‰å¯¹è±¡**éƒ½æ”¾å…¥** longterm ä¸­ï¼Œåˆ©ç”¨è™šæ‹Ÿæœºå›æ”¶æ‰ä¸€éƒ¨åˆ†ä¸ç»å¸¸ä½¿ç”¨çš„å¯¹è±¡ã€‚

```java
public final class ConcurrentCache<K, V> {

    private final int size;
    // ä¼Šç”¸åŒº
    private final Map<K, V> eden;

    private final Map<K, V> longterm;

    public ConcurrentCache(int size) {
        this.size = size;
        this.eden = new ConcurrentHashMap<>(size);
        this.longterm = new WeakHashMap<>(size);
    }

    public V get(K k) {
        V v = this.eden.get(k);
        if (v == null) {
            v = this.longterm.get(k);
            if (v != null)
                this.eden.put(k, v);
        }
        return v;
    }

    public void put(K k, V v) {
        if (this.eden.size() >= size) {
            this.longterm.putAll(this.eden);
            this.eden.clear();
        }
        this.eden.put(k, v);
    }
}
```























### å‚è€ƒèµ„æ–™

- [Java Collection Framework](https://www.w3resource.com/java-tutorial/java-collections.php)
- [Iterator æ¨¡å¼](https://openhome.cc/Gossip/DesignPattern/IteratorPattern.htm)
- [Java 8 ç³»åˆ—ä¹‹é‡æ–°è®¤è¯† HashMapï¼ˆå¥½ï¼ï¼ï¼ï¼ï¼‰](https://tech.meituan.com/java_hashmap.html)
- [What is difference between HashMap and Hashtable in Java?](http://javarevisited.blogspot.hk/2010/10/difference-between-hashmap-and.html)
- [Java é›†åˆä¹‹ HashMap](http://www.zhangchangle.com/2018/02/07/Java%E9%9B%86%E5%90%88%E4%B9%8BHashMap/)
- [The principle of ConcurrentHashMap analysis](http://www.programering.com/a/MDO3QDNwATM.html)
- [æ¢ç´¢ ConcurrentHashMap é«˜å¹¶å‘æ€§çš„å®ç°æœºåˆ¶](https://www.ibm.com/developerworks/cn/java/java-lo-concurrenthashmap/)
- [HashMap ç›¸å…³é¢è¯•é¢˜åŠå…¶è§£ç­”ï¼ˆå¥½ï¼ï¼ï¼ï¼ï¼ï¼ï¼‰](https://www.jianshu.com/p/75adf47958a7)
- [Java é›†åˆç»†èŠ‚ï¼ˆäºŒï¼‰ï¼šasList çš„ç¼ºé™·](http://wiki.jikexueyuan.com/project/java-enhancement/java-thirtysix.html)

    







