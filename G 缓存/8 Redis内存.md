[TOC]

### Redis内存

Redis 就是内存数据库，所以理解 Redis 的内存是非常关键的。

#### 内存消耗

内存消耗分为**自身内存**消耗和**子进程内存**消耗。

##### 1. 内存使用统计

内存统计信息通过 **info memory** 指令查看。重点指标如下。

|           属性名            |                           属性说明                           |
| :-------------------------: | :----------------------------------------------------------: |
|       **used_memory**       | Redis 分配器分配的内存**总量**，也就是内部存储的所有数据内存占用量 |
|     **used_memory_rss**     |    从**操作系统**的角度显示 Redis 进程占用的物理内存总量     |
|    **used_memory_peak**     |       内存**使用的最大值**，表示 used_memory **峰值**        |
|   used_memory_peak_human    |            以**可读的格式**返回 used_memory peak             |
|       used_memory_lua       |                   Lua 引擎锁消耗的内存大小                   |
| **mem_fragmentation_ratio** |   used_memory_rss/used_memory **比值**，表示**内存碎片率**   |
|        mem_allocator        |           Redis 所使用的内存分配器 默认为 jemalloc           |

重点关注：**used_memory_rss**，**used_memory**，及两者比值 **mem_fragmentation_ratio**。

- 当 **mem_fragmentation_ratio >1** 时，说明 used_memory_rss-used_memory 多出的部分**内存并没有用于数据存储**，而是被内存碎片所消耗，如果两者相差很大，**说明内存碎片率严重**。

- 当 **mem_fragmentation_ratio <1** 时，这种情况一般出现在操作系统把 Redis 内存**交换到硬盘导致**，由于硬盘速度远远慢于内存，Redis 性能会变得很差，甚至僵死。

##### 2. 内存消耗划分

Redis 进程内存消耗主要有四个部分：自身内存、对象内存、缓冲内存、内存碎片。

<img src="8 Redis内存.assets/image-20200426234244499.png" alt="image-20200426234244499" style="zoom:67%;" />

###### ① 自身内存

自身内存很小。

###### ② 对象内存

是占用最多的内存，就是保存用户的**所有数据**。所有的数据都采用 key-value 的方式进行存储。键对象都是字符串，所以应该避免过长的键。不同数据结构占用内存不同。

###### ③ 缓冲内存

缓冲内存就是**缓冲区**内存，是实现功能很重要的一部分。

缓冲内存主要包括：客户端缓冲、复制积压缓冲区、AOF 缓冲区。

<img src="8 Redis内存.assets/image-20200426235212679.png" alt="image-20200426235212679" style="zoom:67%;" />

**① 客户端缓冲区**：客户端缓冲指的是所有接入到 Redis 服务器 TCP 连接的**输入输出缓冲**。**输入缓冲**无法控制，最大空间为1G，如果超过将断开连接。**输出缓冲**通过参数 client-output-buffer-limit 控制。客户端分为普通客户端、从客户端、订阅客户端，配置情况不同。

**② 复制积压缓冲区**：Redis2.8 以后提供了一个**可重用的固定大小缓冲区用于实现部分复制**功能，根据 repl-backlog-size 参数控制，默认 1MB。对于复制积压缓冲区**整个主节点只有一个**，所有的从节点**共享**此缓冲区，因此可以**设置较大**的缓冲区空间，如 100MB，这部分内存投入是有价值的，可以**有效避免全量复制**。

**③ AOF缓冲区**：这部分空间用于在 **AOF 重写期间保存最近的写入命令**。此空间的消耗用户无法控制，消耗的内存取决于AOF 重写时间和写入命令量，这部分空间占用通常很小。

###### ④ 内存碎片



